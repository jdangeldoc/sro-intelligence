<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | SRO Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-hover: #242f45;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --border-color: #2d3a52;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation */
        .nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .nav-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), #8b5cf6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .nav-links {
            display: flex;
            gap: 4px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--accent-blue);
            color: white;
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 36px 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
            min-width: 180px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-blue-hover);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Scope Indicator */
        .scope-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .scope-indicator.clinic {
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .scope-indicator.surgeon {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.blue { color: var(--accent-blue); }

        .stat-change {
            font-size: 12px;
            margin-top: 4px;
        }

        .stat-change.positive { color: var(--accent-green); }
        .stat-change.negative { color: var(--accent-red); }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Surgeon Comparison Table */
        .comparison-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 14px 20px;
            text-align: left;
        }

        .comparison-table th {
            background: var(--bg-secondary);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .comparison-table td {
            border-bottom: 1px solid var(--border-color);
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .surgeon-name {
            font-weight: 600;
        }

        .surgeon-specialty {
            font-size: 12px;
            color: var(--text-muted);
        }

        .metric-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        .metric-cell.green { color: var(--accent-green); }
        .metric-cell.yellow { color: var(--accent-yellow); }
        .metric-cell.red { color: var(--accent-red); }

        /* Progress Bar */
        .progress-bar {
            width: 100px;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }

        .progress-fill.green { background: var(--accent-green); }
        .progress-fill.yellow { background: var(--accent-yellow); }
        .progress-fill.red { background: var(--accent-red); }
        .progress-fill.blue { background: var(--accent-blue); }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 64px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Export Section */
        .export-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .export-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .export-card:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .export-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .export-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .export-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .comparison-section {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="sro-clinician-dashboard.html" class="nav-brand">
                <div class="nav-logo">SR</div>
                <span class="nav-title">SRO Intelligence</span>
            </a>
            <div class="nav-links">
                <a href="sro-clinician-dashboard.html" class="nav-link">Dashboard</a>
                <a href="sro-patients.html" class="nav-link">Patients</a>
                <a href="sro-analytics.html" class="nav-link active">Analytics</a>
                <a href="sro-settings.html" class="nav-link">Settings</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="page-header">
            <div>
                <h1 class="page-title">Analytics</h1>
                <p class="page-subtitle">Performance metrics and outcomes tracking</p>
            </div>
            <div class="header-controls">
                <select class="filter-select" id="surgeon-filter">
                    <option value="">All Surgeons (Clinic-Wide)</option>
                </select>
                <select class="filter-select" id="time-filter">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365">Last Year</option>
                    <option value="all">All Time</option>
                </select>
                <div class="scope-indicator clinic" id="scope-indicator">
                    <span>üìä</span>
                    <span id="scope-text">Clinic-Wide View</span>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Episodes</div>
                <div class="stat-value" id="stat-episodes">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Patients</div>
                <div class="stat-value blue" id="stat-active">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg. Check-ins/Patient</div>
                <div class="stat-value green" id="stat-checkins">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Compliance Rate</div>
                <div class="stat-value" id="stat-compliance">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg. Pain Score</div>
                <div class="stat-value" id="stat-pain">-</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Check-ins Over Time</h3>
                        <p class="chart-subtitle">Daily check-in activity</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="checkins-chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Surgery Type Distribution</h3>
                        <p class="chart-subtitle">Episodes by procedure</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="surgery-chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Pain Score Trends</h3>
                        <p class="chart-subtitle">Average pain over recovery period</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="pain-chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">Patient Status Distribution</h3>
                        <p class="chart-subtitle">Current compliance status</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="status-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Surgeon Comparison -->
        <div class="comparison-section" id="comparison-section">
            <div class="section-header">
                <h2 class="section-title">Surgeon Performance Comparison</h2>
            </div>
            <div id="comparison-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h2 class="section-title">Export Reports</h2>
            <div class="export-grid">
                <div class="export-card" onclick="exportPatientSummary()">
                    <div class="export-icon">üìã</div>
                    <div class="export-title">Patient Summary</div>
                    <div class="export-desc">All patients with current status</div>
                </div>
                <div class="export-card" onclick="exportCheckinData()">
                    <div class="export-icon">üìä</div>
                    <div class="export-title">Check-in Data</div>
                    <div class="export-desc">Detailed check-in records</div>
                </div>
                <div class="export-card" onclick="exportCMSReport()">
                    <div class="export-icon">üè•</div>
                    <div class="export-title">CMS TEAM Report</div>
                    <div class="export-desc">CMS compliance format</div>
                </div>
                <div class="export-card" onclick="exportSurgeonReport()">
                    <div class="export-icon">üë®‚Äç‚öïÔ∏è</div>
                    <div class="export-title">Surgeon Report</div>
                    <div class="export-desc">Per-surgeon outcomes</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://kutnednztssloqluygse.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bs41LPV6lzVSk3RvdNGnOg_Io1z1m-o';
        const CLINIC_ID = '11111111-1111-1111-1111-111111111111';

        let surgeons = [];
        let allData = { patients: [], episodes: [], checkins: [] };
        let charts = {};

        // Supabase helper
        async function supabaseRequest(endpoint) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error(await response.text());
            const text = await response.text();
            return text ? JSON.parse(text) : null;
        }

        // Load initial data
        async function loadData() {
            try {
                const [patients, episodes, checkins, surgeonData] = await Promise.all([
                    supabaseRequest(`patients?clinic_id=eq.${CLINIC_ID}`),
                    supabaseRequest(`episodes?clinic_id=eq.${CLINIC_ID}`),
                    supabaseRequest(`checkins?clinic_id=eq.${CLINIC_ID}`),
                    supabaseRequest(`users?clinic_id=eq.${CLINIC_ID}&role=eq.surgeon&order=name.asc`)
                ]);

                allData = { patients, episodes, checkins };
                surgeons = surgeonData || [];

                // Populate surgeon filter
                const surgeonFilter = document.getElementById('surgeon-filter');
                surgeons.forEach(s => {
                    const fullName = [s.first_name, s.last_name].filter(Boolean).join(' ') || 'Unknown';
                    surgeonFilter.innerHTML += `<option value="${s.id}">${fullName}</option>`;
                });

                updateAnalytics();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update analytics based on filters
        function updateAnalytics() {
            const surgeonId = document.getElementById('surgeon-filter').value;
            const timeRange = parseInt(document.getElementById('time-filter').value) || Infinity;

            // Update scope indicator
            const scopeIndicator = document.getElementById('scope-indicator');
            const scopeText = document.getElementById('scope-text');
            if (surgeonId) {
                const surgeon = surgeons.find(s => s.id === surgeonId);
                const fullName = surgeon ? [surgeon.first_name, surgeon.last_name].filter(Boolean).join(' ') : 'Surgeon View';
                scopeText.textContent = fullName;
                scopeIndicator.className = 'scope-indicator surgeon';
            } else {
                scopeText.textContent = 'Clinic-Wide View';
                scopeIndicator.className = 'scope-indicator clinic';
            }

            // Filter data
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - timeRange);

            let filteredEpisodes = allData.episodes;
            if (surgeonId) {
                filteredEpisodes = filteredEpisodes.filter(e => e.surgeon_id === surgeonId);
            }

            const episodeIds = new Set(filteredEpisodes.map(e => e.id));
            let filteredCheckins = allData.checkins.filter(c => episodeIds.has(c.episode_id));
            
            if (timeRange !== Infinity) {
                filteredCheckins = filteredCheckins.filter(c => new Date(c.created_at) >= cutoffDate);
            }

            // Calculate stats
            updateStats(filteredEpisodes, filteredCheckins);
            updateCharts(filteredEpisodes, filteredCheckins, cutoffDate);
            updateComparison();
        }

        function updateStats(episodes, checkins) {
            const activeEpisodes = episodes.filter(e => e.status === 'active');
            const uniquePatients = new Set(activeEpisodes.map(e => e.patient_id));
            
            document.getElementById('stat-episodes').textContent = episodes.length;
            document.getElementById('stat-active').textContent = uniquePatients.size;

            // Average check-ins per patient
            const avgCheckins = uniquePatients.size > 0 
                ? (checkins.length / uniquePatients.size).toFixed(1) 
                : '0';
            document.getElementById('stat-checkins').textContent = avgCheckins;

            // Compliance rate (patients with check-ins in last 7 days)
            const recentCutoff = new Date();
            recentCutoff.setDate(recentCutoff.getDate() - 7);
            const recentCheckins = checkins.filter(c => new Date(c.created_at) >= recentCutoff);
            const patientsWithRecentCheckins = new Set(
                recentCheckins.map(c => {
                    const episode = episodes.find(e => e.id === c.episode_id);
                    return episode?.patient_id;
                }).filter(Boolean)
            );
            const complianceRate = uniquePatients.size > 0
                ? Math.round((patientsWithRecentCheckins.size / uniquePatients.size) * 100)
                : 0;
            const complianceEl = document.getElementById('stat-compliance');
            complianceEl.textContent = `${complianceRate}%`;
            complianceEl.className = `stat-value ${complianceRate >= 70 ? 'green' : complianceRate >= 40 ? 'yellow' : 'red'}`;

            // Average pain score
            const painCheckins = checkins.filter(c => c.pain_level !== null);
            const avgPain = painCheckins.length > 0
                ? (painCheckins.reduce((sum, c) => sum + c.pain_level, 0) / painCheckins.length).toFixed(1)
                : '-';
            const painEl = document.getElementById('stat-pain');
            painEl.textContent = avgPain !== '-' ? `${avgPain}/10` : avgPain;
            if (avgPain !== '-') {
                painEl.className = `stat-value ${avgPain <= 4 ? 'green' : avgPain <= 7 ? 'yellow' : 'red'}`;
            }
        }

        function updateCharts(episodes, checkins, cutoffDate) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart?.destroy());

            // Check-ins over time
            const checkinsByDay = {};
            checkins.forEach(c => {
                const day = c.created_at.split('T')[0];
                checkinsByDay[day] = (checkinsByDay[day] || 0) + 1;
            });

            const sortedDays = Object.keys(checkinsByDay).sort();
            const last30Days = sortedDays.slice(-30);

            charts.checkins = new Chart(document.getElementById('checkins-chart'), {
                type: 'line',
                data: {
                    labels: last30Days.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Check-ins',
                        data: last30Days.map(d => checkinsByDay[d]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#2d3a52' }, ticks: { color: '#64748b' } },
                        y: { grid: { color: '#2d3a52' }, ticks: { color: '#64748b' }, beginAtZero: true }
                    }
                }
            });

            // Surgery type distribution
            const surgeryTypes = {};
            episodes.forEach(e => {
                if (e.surgery_type) {
                    surgeryTypes[e.surgery_type] = (surgeryTypes[e.surgery_type] || 0) + 1;
                }
            });

            charts.surgery = new Chart(document.getElementById('surgery-chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(surgeryTypes),
                    datasets: [{
                        data: Object.values(surgeryTypes),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });

            // Pain score trends (by week post-op)
            const painByWeek = {};
            checkins.forEach(c => {
                if (c.pain_level !== null) {
                    const episode = episodes.find(e => e.id === c.episode_id);
                    if (episode?.surgery_date) {
                        const daysPostOp = Math.floor((new Date(c.created_at) - new Date(episode.surgery_date)) / (1000 * 60 * 60 * 24));
                        const week = Math.floor(daysPostOp / 7);
                        if (week >= 0 && week <= 12) {
                            if (!painByWeek[week]) painByWeek[week] = [];
                            painByWeek[week].push(c.pain_level);
                        }
                    }
                }
            });

            const weeks = Array.from({ length: 13 }, (_, i) => i);
            const avgPainByWeek = weeks.map(w => {
                const pains = painByWeek[w] || [];
                return pains.length > 0 ? pains.reduce((a, b) => a + b, 0) / pains.length : null;
            });

            charts.pain = new Chart(document.getElementById('pain-chart'), {
                type: 'line',
                data: {
                    labels: weeks.map(w => `Week ${w}`),
                    datasets: [{
                        label: 'Avg Pain',
                        data: avgPainByWeek,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#2d3a52' }, ticks: { color: '#64748b' } },
                        y: { grid: { color: '#2d3a52' }, ticks: { color: '#64748b' }, min: 0, max: 10 }
                    }
                }
            });

            // Status distribution
            const statusCounts = { green: 0, yellow: 0, red: 0 };
            const now = new Date();
            
            episodes.filter(e => e.status === 'active').forEach(ep => {
                const episodeCheckins = checkins.filter(c => c.episode_id === ep.id);
                if (episodeCheckins.length > 0) {
                    const lastCheckin = new Date(Math.max(...episodeCheckins.map(c => new Date(c.created_at))));
                    const daysSince = Math.floor((now - lastCheckin) / (1000 * 60 * 60 * 24));
                    if (daysSince <= 3) statusCounts.green++;
                    else if (daysSince <= 7) statusCounts.yellow++;
                    else statusCounts.red++;
                } else {
                    statusCounts.red++;
                }
            });

            charts.status = new Chart(document.getElementById('status-chart'), {
                type: 'pie',
                data: {
                    labels: ['On Track', 'Needs Attention', 'Overdue'],
                    datasets: [{
                        data: [statusCounts.green, statusCounts.yellow, statusCounts.red],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function updateComparison() {
            const container = document.getElementById('comparison-container');
            
            if (surgeons.length === 0) {
                container.innerHTML = `<div style="padding: 24px; color: var(--text-muted);">No surgeons found. Add surgeons in Settings.</div>`;
                return;
            }

            const surgeonStats = surgeons.map(surgeon => {
                const surgeonEpisodes = allData.episodes.filter(e => e.surgeon_id === surgeon.id);
                const episodeIds = new Set(surgeonEpisodes.map(e => e.id));
                const surgeonCheckins = allData.checkins.filter(c => episodeIds.has(c.episode_id));
                
                const activePatients = new Set(surgeonEpisodes.filter(e => e.status === 'active').map(e => e.patient_id)).size;
                const avgCheckins = activePatients > 0 ? (surgeonCheckins.length / activePatients).toFixed(1) : '0';
                
                const painCheckins = surgeonCheckins.filter(c => c.pain_level !== null);
                const avgPain = painCheckins.length > 0
                    ? (painCheckins.reduce((sum, c) => sum + c.pain_level, 0) / painCheckins.length).toFixed(1)
                    : '-';

                // Compliance
                const recentCutoff = new Date();
                recentCutoff.setDate(recentCutoff.getDate() - 7);
                const recentCheckins = surgeonCheckins.filter(c => new Date(c.created_at) >= recentCutoff);
                const patientsWithRecent = new Set(
                    recentCheckins.map(c => {
                        const ep = surgeonEpisodes.find(e => e.id === c.episode_id);
                        return ep?.patient_id;
                    }).filter(Boolean)
                ).size;
                const compliance = activePatients > 0 ? Math.round((patientsWithRecent / activePatients) * 100) : 0;

                return {
                    ...surgeon,
                    totalEpisodes: surgeonEpisodes.length,
                    activePatients,
                    avgCheckins,
                    avgPain,
                    compliance
                };
            });

            container.innerHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Surgeon</th>
                            <th>Total Episodes</th>
                            <th>Active Patients</th>
                            <th>Avg Check-ins</th>
                            <th>Avg Pain</th>
                            <th>Compliance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${surgeonStats.map(s => {
                            const fullName = [s.first_name, s.last_name].filter(Boolean).join(' ') || 'Unknown';
                            return `
                            <tr>
                                <td>
                                    <div class="surgeon-name">${fullName}</div>
                                    <div class="surgeon-specialty">${s.specialty || '-'}</div>
                                </td>
                                <td class="metric-cell">${s.totalEpisodes}</td>
                                <td class="metric-cell">${s.activePatients}</td>
                                <td class="metric-cell">${s.avgCheckins}</td>
                                <td class="metric-cell ${s.avgPain !== '-' ? (s.avgPain <= 4 ? 'green' : s.avgPain <= 7 ? 'yellow' : 'red') : ''}">
                                    ${s.avgPain !== '-' ? `${s.avgPain}/10` : '-'}
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div class="progress-bar">
                                            <div class="progress-fill ${s.compliance >= 70 ? 'green' : s.compliance >= 40 ? 'yellow' : 'red'}" 
                                                 style="width: ${s.compliance}%"></div>
                                        </div>
                                        <span class="metric-cell">${s.compliance}%</span>
                                    </div>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        // Export functions
        function exportPatientSummary() {
            const surgeonId = document.getElementById('surgeon-filter').value;
            let episodes = allData.episodes;
            if (surgeonId) {
                episodes = episodes.filter(e => e.surgeon_id === surgeonId);
            }

            const rows = [['Patient Name', 'Surgery Type', 'Surgery Date', 'Surgeon', 'Status', 'Check-ins']];
            
            episodes.forEach(ep => {
                const patient = allData.patients.find(p => p.id === ep.patient_id);
                const patientName = patient ? [patient.first_name, patient.last_name].filter(Boolean).join(' ') : '-';
                const surgeon = surgeons.find(s => s.id === ep.surgeon_id);
                const surgeonName = surgeon ? [surgeon.first_name, surgeon.last_name].filter(Boolean).join(' ') : '-';
                const checkinCount = allData.checkins.filter(c => c.episode_id === ep.id).length;
                
                rows.push([
                    patientName,
                    ep.surgery_type || '-',
                    ep.surgery_date || '-',
                    surgeonName,
                    ep.status || '-',
                    checkinCount
                ]);
            });

            downloadCSV(rows, 'patient-summary');
        }

        function exportCheckinData() {
            const rows = [['Patient', 'Date', 'Type', 'Pain Level', 'Episode ID']];
            
            allData.checkins.forEach(c => {
                const episode = allData.episodes.find(e => e.id === c.episode_id);
                const patient = allData.patients.find(p => p.id === episode?.patient_id);
                const patientName = patient ? [patient.first_name, patient.last_name].filter(Boolean).join(' ') : '-';
                
                rows.push([
                    patientName,
                    c.created_at,
                    c.checkin_type || 'daily',
                    c.pain_level !== null ? c.pain_level : '-',
                    c.episode_id
                ]);
            });

            downloadCSV(rows, 'checkin-data');
        }

        function exportCMSReport() {
            const rows = [['Patient Name', 'DOB', 'Surgery Type', 'Surgery Date', 'Surgeon NPI', 'PRO-PM Completed', 'Days to First PRO']];
            
            allData.episodes.forEach(ep => {
                const patient = allData.patients.find(p => p.id === ep.patient_id);
                const patientName = patient ? [patient.first_name, patient.last_name].filter(Boolean).join(' ') : '-';
                const surgeon = surgeons.find(s => s.id === ep.surgeon_id);
                const episodeCheckins = allData.checkins.filter(c => c.episode_id === ep.id);
                const proCheckins = episodeCheckins.filter(c => c.checkin_type === 'pro_pm');
                
                let daysToFirstPro = '-';
                if (proCheckins.length > 0 && ep.surgery_date) {
                    const firstPro = new Date(Math.min(...proCheckins.map(c => new Date(c.created_at))));
                    daysToFirstPro = Math.floor((firstPro - new Date(ep.surgery_date)) / (1000 * 60 * 60 * 24));
                }

                rows.push([
                    patientName,
                    patient?.date_of_birth || '-',
                    ep.surgery_type || '-',
                    ep.surgery_date || '-',
                    surgeon?.npi || '-',
                    proCheckins.length > 0 ? 'Yes' : 'No',
                    daysToFirstPro
                ]);
            });

            downloadCSV(rows, 'cms-team-report');
        }

        function exportSurgeonReport() {
            const rows = [['Surgeon', 'Specialty', 'NPI', 'Total Episodes', 'Active Patients', 'Avg Check-ins', 'Compliance Rate']];
            
            surgeons.forEach(surgeon => {
                const fullName = [surgeon.first_name, surgeon.last_name].filter(Boolean).join(' ') || 'Unknown';
                const surgeonEpisodes = allData.episodes.filter(e => e.surgeon_id === surgeon.id);
                const episodeIds = new Set(surgeonEpisodes.map(e => e.id));
                const surgeonCheckins = allData.checkins.filter(c => episodeIds.has(c.episode_id));
                const activePatients = new Set(surgeonEpisodes.filter(e => e.status === 'active').map(e => e.patient_id)).size;
                const avgCheckins = activePatients > 0 ? (surgeonCheckins.length / activePatients).toFixed(1) : '0';

                rows.push([
                    fullName,
                    surgeon.specialty || '-',
                    surgeon.npi || '-',
                    surgeonEpisodes.length,
                    activePatients,
                    avgCheckins,
                    '-' // Would calculate compliance here
                ]);
            });

            downloadCSV(rows, 'surgeon-report');
        }

        function downloadCSV(rows, filename) {
            const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('surgeon-filter').addEventListener('change', updateAnalytics);
        document.getElementById('time-filter').addEventListener('change', updateAnalytics);

        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
