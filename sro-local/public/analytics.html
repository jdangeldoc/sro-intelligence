<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | SRO Intelligence</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .analytics-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .rate-card { background: white; border-radius: 12px; padding: 24px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .rate-value { font-size: 3rem; font-weight: 800; }
        .rate-label { font-size: 0.9rem; color: #666; margin-top: 4px; }
        .rate-sub { font-size: 0.8rem; color: #999; margin-top: 8px; }
        .section-card { background: white; border-radius: 12px; padding: 24px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; }
        .bar-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .bar-label { width: 140px; font-size: 0.85rem; font-weight: 600; }
        .bar-track { flex: 1; height: 24px; background: #e5e7eb; border-radius: 6px; position: relative; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.75rem; font-weight: 700; color: white; min-width: 40px; }
        .bar-count { width: 80px; text-align: right; font-size: 0.8rem; color: #666; }
        .threshold-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #1e3a5f; z-index: 2; }
        .threshold-label { position: absolute; top: -16px; font-size: 0.65rem; color: #1e3a5f; font-weight: 700; transform: translateX(-50%); }
        .cms-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .cms-table th { background: #1e3a5f; color: white; padding: 8px 10px; text-align: left; font-weight: 600; position: sticky; top: 0; }
        .cms-table td { padding: 7px 10px; border-bottom: 1px solid #eee; }
        .cms-table tr:hover { background: #f0f4ff; }
        .scb-yes { color: #16a34a; font-weight: 700; }
        .scb-no { color: #dc2626; font-weight: 700; }
        .scb-pending { color: #6b7280; }
        .export-btn { background: #16a34a; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .export-btn:hover { background: #15803d; }
        .tab-bar { display: flex; gap: 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; font-size: 1rem; font-weight: 600; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #6b7280; margin-bottom: -2px; }
        .tab-btn.active { border-bottom-color: #2c5aa0; color: #2c5aa0; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <div class="logo">SRO</div>
            <span>SRO Intelligence</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html">Dashboard</a>
            <a href="/preop.html">Pre-Op</a>
            <a href="/analytics.html" class="active">Analytics</a>
            <a href="/rpm-report.html">RPM Billing</a>
            <a href="/settings.html">Settings</a>
        </div>
        <div class="nav-user">
            <span id="userName">User</span>
            <button class="btn btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="analytics-container">
        <h1 style="margin-bottom: 5px;">Analytics</h1>
        <p style="color: #666; margin-bottom: 20px;">CMS Outcomes Reporting & Practice Performance</p>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchAnalyticsTab('cms')" id="tabCms">üìä CMS Outcomes</button>
            <button class="tab-btn" onclick="switchAnalyticsTab('surgeon')" id="tabSurgeon">üë®‚Äç‚öïÔ∏è Surgeon Comparison</button>
        </div>

        <!-- CMS OUTCOMES TAB -->
        <div id="panelCms">
            <!-- Substantial Clinical Benefit (SCB) Rate Cards -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                <div class="rate-card">
                    <div class="rate-value" id="overallScbRate" style="color: #6b7280;">--%</div>
                    <div class="rate-label">Overall Substantial Clinical Benefit Rate</div>
                    <div class="rate-sub" id="overallScbSub">-- patients with outcomes</div>
                </div>
                <div class="rate-card">
                    <div class="rate-value" id="tkaScbRate" style="color: #6b7280;">--%</div>
                    <div class="rate-label">TKA Substantial Clinical Benefit Rate</div>
                    <div class="rate-sub">KOOS Jr ‚â•20 pts improvement</div>
                </div>
                <div class="rate-card">
                    <div class="rate-value" id="thaScbRate" style="color: #6b7280;">--%</div>
                    <div class="rate-label">THA Substantial Clinical Benefit Rate</div>
                    <div class="rate-sub">HOOS Jr ‚â•22 pts improvement</div>
                </div>
                <div class="rate-card">
                    <div class="rate-value" id="completionRate" style="color: #6b7280;">--%</div>
                    <div class="rate-label">PROM Completion</div>
                    <div class="rate-sub">CMS requires 50% by 2027</div>
                </div>
            </div>

            <!-- Surgeon Substantial Clinical Benefit Breakdown -->
            <div class="section-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="section-title">Substantial Clinical Benefit Rate by Surgeon</div>
                    <div style="font-size: 0.75rem; color: #999;">CMS Substantial Clinical Benefit threshold shown as dark line</div>
                </div>
                <div id="surgeonScbBars"></div>
            </div>

            <!-- Risk Tier Breakdown -->
            <div class="section-card">
                <div class="section-title">Substantial Clinical Benefit Rate by Risk Tier</div>
                <div id="riskTierBars"></div>
            </div>

            <!-- Patient Detail Table -->
            <div class="section-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="section-title" style="margin-bottom: 0;">Patient Outcomes Detail</div>
                    <div style="display: flex; gap: 10px;">
                        <select id="cmsFilterSurgeon" onchange="renderCmsTable()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="all">All Surgeons</option>
                        </select>
                        <select id="cmsFilterType" onchange="renderCmsTable()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="all">All Types</option>
                            <option value="TKA">TKA Only</option>
                            <option value="THA">THA Only</option>
                        </select>
                        <button class="export-btn" onclick="exportCmsReport()">‚¨á Export CSV</button>
                    </div>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table class="cms-table">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>MRN</th>
                                <th>Surgery</th>
                                <th>Date</th>
                                <th>Surgeon</th>
                                <th>Risk</th>
                                <th>Pre-Op</th>
                                <th>Post-Op</th>
                                <th>Œî</th>
                                <th>Substantial Clinical Benefit Threshold</th>
                                <th>Substantial Clinical Benefit Met</th>
                            </tr>
                        </thead>
                        <tbody id="cmsTableBody">
                            <tr><td colspan="11" style="text-align:center; color:#999; padding:30px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SURGEON COMPARISON TAB -->
        <div id="panelSurgeon" style="display: none;">
            <div class="section-card">
                <div class="section-title">Surgeon Comparison</div>
                <div id="surgeonComparisonTable"></div>
            </div>
        </div>
    </main>

    <script>
    const CLINIC_ID = sessionStorage.getItem('clinicId') || '11111111-1111-1111-1111-111111111111';
    const USER_NAME = sessionStorage.getItem('userName') || 'User';
    document.getElementById('userName').textContent = USER_NAME;

    let cmsData = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadCmsOutcomes();
        await loadSurgeonComparison();
    });

    function switchAnalyticsTab(tab) {
        document.getElementById('panelCms').style.display = tab === 'cms' ? 'block' : 'none';
        document.getElementById('panelSurgeon').style.display = tab === 'surgeon' ? 'block' : 'none';
        document.getElementById('tabCms').className = 'tab-btn' + (tab === 'cms' ? ' active' : '');
        document.getElementById('tabSurgeon').className = 'tab-btn' + (tab === 'surgeon' ? ' active' : '');
    }

    function colorRate(pct) {
        if (pct === null) return '#6b7280';
        if (pct >= 80) return '#16a34a';
        if (pct >= 50) return '#d97706';
        return '#dc2626';
    }

    async function loadCmsOutcomes() {
        try {
            const resp = await fetch(`/api/analytics/cms-outcomes?clinic_id=${CLINIC_ID}`);
            cmsData = await resp.json();
            
            // Rate cards
            const s = cmsData.summary;
            document.getElementById('overallScbRate').textContent = s.overall_scb_rate !== null ? s.overall_scb_rate + '%' : 'N/A';
            document.getElementById('overallScbRate').style.color = colorRate(s.overall_scb_rate);
            document.getElementById('overallScbSub').textContent = `${s.with_postop} of ${s.total_episodes} patients with outcomes`;
            
            document.getElementById('tkaScbRate').textContent = s.tka_scb_rate !== null ? s.tka_scb_rate + '%' : 'N/A';
            document.getElementById('tkaScbRate').style.color = colorRate(s.tka_scb_rate);
            
            document.getElementById('thaScbRate').textContent = s.tha_scb_rate !== null ? s.tha_scb_rate + '%' : 'N/A';
            document.getElementById('thaScbRate').style.color = colorRate(s.tha_scb_rate);
            
            document.getElementById('completionRate').textContent = s.completion_rate + '%';
            document.getElementById('completionRate').style.color = colorRate(s.completion_rate);
            
            // Surgeon filter
            const surgeonSelect = document.getElementById('cmsFilterSurgeon');
            const surgeons = [...new Set(cmsData.patients.map(p => p.surgeon))];
            surgeons.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                surgeonSelect.appendChild(opt);
            });
            
            // Surgeon SCB bars
            renderSurgeonBars();
            renderRiskTierBars();
            renderCmsTable();
            
        } catch (error) {
            console.error('Error loading CMS outcomes:', error);
        }
    }

    function renderSurgeonBars() {
        const div = document.getElementById('surgeonScbBars');
        if (!cmsData || cmsData.by_surgeon.length === 0) {
            div.innerHTML = '<p style="color: #999; text-align: center;">No post-op outcome data yet. Substantial Clinical Benefit rates will appear after 1-year follow-up assessments are completed.</p>';
            return;
        }
        div.innerHTML = cmsData.by_surgeon.map(s => `
            <div class="bar-row">
                <div class="bar-label">${s.surgeon}</div>
                <div class="bar-track">
                    <div class="bar-fill" style="width: ${s.scb_rate}%; background: ${colorRate(s.scb_rate)};">${s.scb_rate}%</div>
                </div>
                <div class="bar-count">${s.scb_met}/${s.total} met</div>
            </div>
        `).join('');
    }

    function renderRiskTierBars() {
        const div = document.getElementById('riskTierBars');
        if (!cmsData || cmsData.by_risk_tier.length === 0) {
            div.innerHTML = '<p style="color: #999; text-align: center;">No post-op outcome data yet.</p>';
            return;
        }
        const tierColors = { 'LOW': '#16a34a', 'MODERATE': '#d97706', 'HIGH': '#dc2626', 'UNKNOWN': '#6b7280' };
        div.innerHTML = cmsData.by_risk_tier.map(t => `
            <div class="bar-row">
                <div class="bar-label"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:${tierColors[t.tier] || '#6b7280'};color:white;font-size:0.75rem;">${t.tier}</span></div>
                <div class="bar-track">
                    <div class="bar-fill" style="width: ${t.scb_rate}%; background: ${colorRate(t.scb_rate)};">${t.scb_rate}%</div>
                </div>
                <div class="bar-count">${t.scb_met}/${t.total} met</div>
            </div>
        `).join('');
    }

    function renderCmsTable() {
        if (!cmsData) return;
        const tbody = document.getElementById('cmsTableBody');
        const filterSurgeon = document.getElementById('cmsFilterSurgeon').value;
        const filterType = document.getElementById('cmsFilterType').value;
        
        let filtered = cmsData.patients;
        if (filterSurgeon !== 'all') filtered = filtered.filter(p => p.surgeon === filterSurgeon);
        if (filterType !== 'all') {
            filtered = filtered.filter(p => {
                if (!p.surgery_type) return false;
                if (filterType === 'TKA') return p.surgery_type.toUpperCase().includes('TKA') || p.surgery_type.toUpperCase().includes('KNEE');
                if (filterType === 'THA') return p.surgery_type.toUpperCase().includes('THA') || p.surgery_type.toUpperCase().includes('HIP');
                return true;
            });
        }
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#999;padding:20px;">No patients match filters</td></tr>';
            return;
        }
        
        tbody.innerHTML = filtered.map(p => {
            let scbHtml = '';
            if (p.scb_met === true) scbHtml = '<span class="scb-yes">‚úÖ Yes</span>';
            else if (p.scb_met === false) scbHtml = '<span class="scb-no">‚ùå No</span>';
            else scbHtml = '<span class="scb-pending">Pending</span>';
            
            return `<tr>
                <td><strong>${p.patient_name}</strong></td>
                <td>${p.mrn || '-'}</td>
                <td>${p.surgery_type || '-'}</td>
                <td>${p.surgery_date || '-'}</td>
                <td>${p.surgeon}</td>
                <td>${p.risk_tier || '-'}</td>
                <td>${p.preop_score !== null ? p.preop_score : '-'}</td>
                <td>${p.postop_score !== null ? p.postop_score : '<em style="color:#999;">awaiting</em>'}</td>
                <td>${p.delta !== null ? (p.delta >= 0 ? '+' : '') + p.delta : '-'}</td>
                <td>‚â•${p.scb_threshold}</td>
                <td>${scbHtml}</td>
            </tr>`;
        }).join('');
    }

    function exportCmsReport() {
        if (!cmsData) return;
        
        const headers = [
            'Patient Name', 'MRN', 'DOB', 'Age', 'Sex', 'BMI', 'ASA Class',
            'Surgery Type', 'Surgery Date', 'Surgeon', 'Risk Tier',
            'Score Type', 'Pre-Op Score', 'Post-Op Score', 'Delta',
            'Substantial Clinical Benefit Threshold', 'Substantial Clinical Benefit Met',
            'PROMIS Physical Pre', 'PROMIS Mental Pre',
            'PROMIS Physical Post', 'PROMIS Mental Post',
            'Low Back Pain', 'Health Literacy (SILS)', 'Painful Joint Count',
            'Chronic Narcotics >90d'
        ];
        
        const rows = cmsData.patients.map(p => [
            p.patient_name, p.mrn || '', p.dob || '', p.age || '', p.sex || '', p.bmi || '', p.asa_class || '',
            p.surgery_type || '', p.surgery_date || '', p.surgeon, p.risk_tier || '',
            p.score_type || '', p.preop_score !== null ? p.preop_score : '', p.postop_score !== null ? p.postop_score : '', p.delta !== null ? p.delta : '',
            p.scb_threshold, p.scb_met === true ? 'Yes' : p.scb_met === false ? 'No' : 'Pending',
            p.promis_physical_pre || '', p.promis_mental_pre || '',
            p.promis_physical_post || '', p.promis_mental_post || '',
            p.low_back_pain ? 'Yes' : 'No', p.health_literacy || '', p.total_painful_joint_count || '',
            p.chronic_narcotics_use ? 'Yes' : 'No'
        ]);
        
        // Add summary rows
        const s = cmsData.summary;
        rows.push([]);
        rows.push(['=== PRACTICE SUMMARY ===']);
        rows.push(['Total Episodes', s.total_episodes]);
        rows.push(['With Pre-Op Assessment', s.with_preop]);
        rows.push(['With Post-Op Outcomes', s.with_postop]);
        rows.push(['PROM Completion Rate', s.completion_rate + '%']);
        rows.push(['Overall Substantial Clinical Benefit Rate', s.overall_scb_rate !== null ? s.overall_scb_rate + '%' : 'N/A']);
        rows.push(['TKA Substantial Clinical Benefit Rate (KOOS Jr ‚â•20)', s.tka_scb_rate !== null ? s.tka_scb_rate + '%' : 'N/A']);
        rows.push(['THA Substantial Clinical Benefit Rate (HOOS Jr ‚â•22)', s.tha_scb_rate !== null ? s.tha_scb_rate + '%' : 'N/A']);
        rows.push(['Avg TKA Delta', s.avg_delta_tka !== null ? s.avg_delta_tka : 'N/A']);
        rows.push(['Avg THA Delta', s.avg_delta_tha !== null ? s.avg_delta_tha : 'N/A']);
        rows.push([]);
        rows.push(['=== BY SURGEON ===']);
        cmsData.by_surgeon.forEach(sr => {
            rows.push([sr.surgeon, `Substantial Clinical Benefit: ${sr.scb_met}/${sr.total} (${sr.scb_rate}%)`]);
        });
        rows.push([]);
        rows.push(['=== BY RISK TIER ===']);
        cmsData.by_risk_tier.forEach(rt => {
            rows.push([rt.tier, `Substantial Clinical Benefit: ${rt.scb_met}/${rt.total} (${rt.scb_rate}%)`]);
        });
        
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SRO-CMS-Outcomes-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    async function loadSurgeonComparison() {
        try {
            const resp = await fetch(`/api/analytics/surgeon-comparison?clinic_id=${CLINIC_ID}`);
            const data = await resp.json();
            
            const div = document.getElementById('surgeonComparisonTable');
            if (data.length === 0) {
                div.innerHTML = '<p style="color:#999;text-align:center;">No surgeon data yet.</p>';
                return;
            }
            
            div.innerHTML = `
                <table class="cms-table">
                    <thead>
                        <tr>
                            <th>Surgeon</th>
                            <th>Patients</th>
                            <th>Episodes</th>
                            <th>Avg Pain</th>
                            <th>PT Compliance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(s => `
                            <tr>
                                <td><strong>Dr. ${s.first_name} ${s.last_name}</strong></td>
                                <td>${s.total_patients}</td>
                                <td>${s.total_episodes}</td>
                                <td>${s.avg_pain !== null ? s.avg_pain.toFixed(1) : '-'}</td>
                                <td>${s.pt_compliance_rate !== null ? Math.round(s.pt_compliance_rate) + '%' : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error loading surgeon comparison:', error);
        }
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = '/index.html';
    }
    </script>
</body>
</html>
