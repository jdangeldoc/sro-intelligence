<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | SRO Intelligence</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon">SRO</span>
            <span class="nav-title">SRO Intelligence</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/preop.html" class="nav-link">Pre-Op</a>
            <a href="/analytics.html" class="nav-link active">Analytics</a>
            <a href="/rpm-report.html" class="nav-link">RPM Billing</a>
            <a href="/settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span id="userName">Loading...</span>
            <button class="btn btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Analytics</h1>
            <p>Surgeon performance and patient outcome comparisons</p>
        </div>

        <!-- Surgeon Comparison -->
        <div class="settings-section">
            <h2>Surgeon Comparison</h2>
            <div class="table-container" style="box-shadow: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Surgeon</th>
                            <th>Active Patients</th>
                            <th>Avg Pain Level</th>
                            <th>PT Compliance</th>
                        </tr>
                    </thead>
                    <tbody id="surgeonTable">
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="settings-section">
            <h2>Practice Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalPatients">-</div>
                    <div class="stat-label">Total Active Patients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPain">-</div>
                    <div class="stat-label">Average Pain Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPT">-</div>
                    <div class="stat-label">PT Compliance Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="checkinsToday">-</div>
                    <div class="stat-label">Check-ins Today</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CLINIC_ID = sessionStorage.getItem('clinicId') || '11111111-1111-1111-1111-111111111111';
        document.getElementById('userName').textContent = sessionStorage.getItem('userName') || 'User';

        document.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();
            loadStats();
        });

        async function loadAnalytics() {
            try {
                const res = await fetch(`/api/analytics/surgeon-comparison?clinic_id=${CLINIC_ID}`);
                const data = await res.json();
                
                const tbody = document.getElementById('surgeonTable');
                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty">No data</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(s => `
                    <tr>
                        <td><strong>Dr. ${s.first_name} ${s.last_name}</strong></td>
                        <td>${s.total_patients || 0}</td>
                        <td>${s.avg_pain ? s.avg_pain.toFixed(1) + '/10' : '-'}</td>
                        <td>${s.pt_compliance_rate ? s.pt_compliance_rate.toFixed(0) + '%' : '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`/api/dashboard-stats?clinic_id=${CLINIC_ID}`);
                const stats = await res.json();
                
                document.getElementById('totalPatients').textContent = stats.active_patients || 0;
                document.getElementById('checkinsToday').textContent = stats.checked_in_today || 0;
                
                // Get averages from patients
                const pRes = await fetch(`/api/patients?clinic_id=${CLINIC_ID}`);
                const patients = await pRes.json();
                
                const withPain = patients.filter(p => p.last_pain_level !== null);
                const avgPain = withPain.length ? (withPain.reduce((s, p) => s + p.last_pain_level, 0) / withPain.length).toFixed(1) : '-';
                
                const withPT = patients.filter(p => p.last_pt_exercises !== null);
                const ptRate = withPT.length ? Math.round(withPT.filter(p => p.last_pt_exercises === 1).length / withPT.length * 100) + '%' : '-';
                
                document.getElementById('avgPain').textContent = avgPain !== '-' ? avgPain + '/10' : '-';
                document.getElementById('avgPT').textContent = ptRate;
            } catch (e) {
                console.error(e);
            }
        }

        function logout() { sessionStorage.clear(); location.href = '/index.html'; }
    </script>
</body>
</html>
