<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | SRO Intelligence</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover {
            color: #333;
        }
        .tab.active {
            color: #2c5aa0;
            border-bottom-color: #2c5aa0;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .role-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .role-surgeon { background: #e8f4fd; color: #2c5aa0; }
        .role-nurse { background: #d4edda; color: #155724; }
        .role-ma { background: #fff3cd; color: #856404; }
        .role-staff { background: #f0f0f0; color: #666; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon">SRO</span>
            <span class="nav-title">SRO Intelligence</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/analytics.html" class="nav-link">Analytics</a>
            <a href="/rpm-report.html" class="nav-link">RPM Billing</a>
            <a href="/settings.html" class="nav-link active">Settings</a>
        </div>
        <div class="nav-user">
            <span id="userName">Loading...</span>
            <button class="btn btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>Settings</h1>
            <p>Manage team members and clinic settings</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('surgeons')">Surgeons</button>
            <button class="tab" onclick="showTab('staff')">Nurses & Staff</button>
            <button class="tab" onclick="showTab('clinic')">Clinic Info</button>
        </div>

        <!-- Surgeons Tab -->
        <div id="surgeons-tab" class="tab-content active">
            <div class="settings-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; border: none; padding: 0;">Surgeons</h2>
                        <p style="color: #666; margin-top: 5px;">Physicians who perform surgeries and review patient data</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal('surgeon')">+ Add Surgeon</button>
                </div>
                
                <div id="surgeonList" class="surgeon-list">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Staff Tab -->
        <div id="staff-tab" class="tab-content">
            <div class="settings-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0; border: none; padding: 0;">Nurses & Staff</h2>
                        <p style="color: #666; margin-top: 5px;">Clinical staff who can log RPM review time under physician supervision</p>
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal('staff')">+ Add Staff Member</button>
                </div>
                
                <div id="staffList" class="surgeon-list">
                    <p>Loading...</p>
                </div>
            </div>
            
            <div class="settings-section" style="background: #f8f9fa; border: 1px solid #e0e0e0;">
                <h3>ℹ️ RPM Time Documentation</h3>
                <p>CMS allows clinical staff (nurses, MAs) to log RPM review time under physician supervision. Each person should log in with their own account so time is properly documented.</p>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>All staff time counts toward the 20-minute threshold</li>
                    <li>The RPM report shows time breakdown by staff member</li>
                    <li>Keep records in case of audit</li>
                </ul>
            </div>
        </div>

        <!-- Clinic Tab -->
        <div id="clinic-tab" class="tab-content">
            <div class="settings-section">
                <h2>Clinic Information</h2>
                <div id="clinicInfo">Loading...</div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="userModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Team Member</h2>
                <button class="btn btn-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="handleSave(event)">
                    <input type="hidden" id="editId">
                    <input type="hidden" id="editRole">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="userFirst" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="userLast" required>
                        </div>
                    </div>
                    
                    <div class="form-group" id="roleGroup">
                        <label>Role *</label>
                        <select id="userRole" required>
                            <option value="surgeon">Surgeon</option>
                            <option value="nurse">Nurse (RN/LPN)</option>
                            <option value="ma">Medical Assistant (MA)</option>
                            <option value="staff">Other Clinical Staff</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="specialtyGroup">
                        <label>Specialty</label>
                        <select id="userSpecialty">
                            <option value="">Select specialty...</option>
                            <option value="Total Joint Replacement">Total Joint Replacement</option>
                            <option value="Sports Medicine">Sports Medicine</option>
                            <option value="Spine">Spine</option>
                            <option value="Hand & Upper Extremity">Hand & Upper Extremity</option>
                            <option value="Foot & Ankle">Foot & Ankle</option>
                            <option value="Trauma">Trauma</option>
                            <option value="General Orthopedics">General Orthopedics</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail">
                    </div>
                    
                    <div class="form-group" id="npiGroup">
                        <label>NPI (Physicians only)</label>
                        <input type="text" id="userNPI" maxlength="10" placeholder="10-digit NPI">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const CLINIC_ID = sessionStorage.getItem('clinicId') || '11111111-1111-1111-1111-111111111111';
        document.getElementById('userName').textContent = sessionStorage.getItem('userName') || 'User';
        
        let allUsers = [];
        let currentTab = 'surgeons';

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            loadClinicInfo();
        });

        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        async function loadUsers() {
            try {
                const res = await fetch(`/api/users?clinic_id=${CLINIC_ID}`);
                allUsers = await res.json();
                renderUsers();
            } catch (e) {
                console.error(e);
            }
        }

        function renderUsers() {
            // Surgeons
            const surgeons = allUsers.filter(u => u.role === 'surgeon');
            const surgeonDiv = document.getElementById('surgeonList');
            
            if (!surgeons.length) {
                surgeonDiv.innerHTML = '<p class="empty">No surgeons added yet.</p>';
            } else {
                surgeonDiv.innerHTML = surgeons.map(s => `
                    <div class="surgeon-card">
                        <div class="surgeon-info">
                            <h3>Dr. ${s.first_name} ${s.last_name}</h3>
                            <p>${s.specialty || 'No specialty'} ${s.npi ? '• NPI: ' + s.npi : ''}</p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="editUser('${s.id}')">Edit</button>
                            <button class="btn btn-sm" style="background: #dc3545; color: white;" onclick="deleteUser('${s.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Staff
            const staff = allUsers.filter(u => u.role !== 'surgeon');
            const staffDiv = document.getElementById('staffList');
            
            if (!staff.length) {
                staffDiv.innerHTML = '<p class="empty">No staff members added yet.</p>';
            } else {
                staffDiv.innerHTML = staff.map(s => `
                    <div class="surgeon-card">
                        <div class="surgeon-info">
                            <h3>${s.first_name} ${s.last_name}</h3>
                            <p>
                                <span class="role-badge role-${s.role}">${getRoleLabel(s.role)}</span>
                                ${s.email ? ' • ' + s.email : ''}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="editUser('${s.id}')">Edit</button>
                            <button class="btn btn-sm" style="background: #dc3545; color: white;" onclick="deleteUser('${s.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function getRoleLabel(role) {
            const labels = {
                'surgeon': 'Surgeon',
                'nurse': 'Nurse',
                'ma': 'Medical Assistant',
                'staff': 'Staff'
            };
            return labels[role] || role;
        }

        async function loadClinicInfo() {
            try {
                const res = await fetch(`/api/clinics/${CLINIC_ID}`);
                const clinic = await res.json();
                document.getElementById('clinicInfo').innerHTML = `
                    <p><strong>Name:</strong> ${clinic.name}</p>
                    <p><strong>Address:</strong> ${clinic.address || 'Not set'}</p>
                    <p><strong>Phone:</strong> ${clinic.phone || 'Not set'}</p>
                    <p><strong>Clinic ID:</strong> <code>${clinic.id}</code></p>
                `;
            } catch (e) {
                console.error(e);
            }
        }

        function openAddModal(type) {
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').textContent = type === 'surgeon' ? 'Add Surgeon' : 'Add Staff Member';
            document.getElementById('userForm').reset();
            
            // Set default role
            if (type === 'surgeon') {
                document.getElementById('userRole').value = 'surgeon';
                document.getElementById('roleGroup').style.display = 'none';
                document.getElementById('specialtyGroup').style.display = 'block';
                document.getElementById('npiGroup').style.display = 'block';
            } else {
                document.getElementById('userRole').value = 'nurse';
                document.getElementById('roleGroup').style.display = 'block';
                document.getElementById('specialtyGroup').style.display = 'none';
                document.getElementById('npiGroup').style.display = 'none';
            }
            
            document.getElementById('editRole').value = type;
            document.getElementById('userModal').style.display = 'flex';
        }

        function editUser(id) {
            const user = allUsers.find(u => u.id === id);
            if (!user) return;
            
            const isSurgeon = user.role === 'surgeon';
            
            document.getElementById('editId').value = id;
            document.getElementById('editRole').value = isSurgeon ? 'surgeon' : 'staff';
            document.getElementById('modalTitle').textContent = isSurgeon ? 'Edit Surgeon' : 'Edit Staff Member';
            
            document.getElementById('userFirst').value = user.first_name;
            document.getElementById('userLast').value = user.last_name;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userSpecialty').value = user.specialty || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userNPI').value = user.npi || '';
            
            document.getElementById('roleGroup').style.display = isSurgeon ? 'none' : 'block';
            document.getElementById('specialtyGroup').style.display = isSurgeon ? 'block' : 'none';
            document.getElementById('npiGroup').style.display = isSurgeon ? 'block' : 'none';
            
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        async function handleSave(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const editRole = document.getElementById('editRole').value;
            
            const data = {
                clinic_id: CLINIC_ID,
                first_name: document.getElementById('userFirst').value,
                last_name: document.getElementById('userLast').value,
                role: editRole === 'surgeon' ? 'surgeon' : document.getElementById('userRole').value,
                specialty: document.getElementById('userSpecialty').value || null,
                email: document.getElementById('userEmail').value || null,
                npi: document.getElementById('userNPI').value || null
            };
            
            try {
                if (editId) {
                    await fetch(`/api/users/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                closeModal();
                loadUsers();
            } catch (e) {
                alert('Error saving');
            }
        }

        async function deleteUser(id) {
            const user = allUsers.find(u => u.id === id);
            if (!confirm(`Delete ${user.first_name} ${user.last_name}?`)) return;
            
            try {
                await fetch(`/api/users/${id}`, { method: 'DELETE' });
                loadUsers();
            } catch (e) {
                alert('Error deleting');
            }
        }

        function logout() { sessionStorage.clear(); location.href = '/index.html'; }
    </script>
</body>
</html>
