<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surgical Prep | SRO Intelligence</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .prep-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .prep-tabs { display: flex; gap: 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 24px; overflow-x: auto; }
        .prep-tab { padding: 12px 16px; font-size: 0.9rem; font-weight: 600; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #6b7280; margin-bottom: -2px; white-space: nowrap; }
        .prep-tab.active { border-bottom-color: #2c5aa0; color: #2c5aa0; }
        .prep-panel { display: none; }
        .prep-panel.active { display: block; }
        
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 768px) { .calc-grid { grid-template-columns: 1fr; } }
        
        .input-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .input-card h3 { margin: 0 0 16px 0; font-size: 1.1rem; color: #1e293b; }
        
        .field-row { margin-bottom: 16px; }
        .field-row label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 6px; }
        .field-row input[type="number"] { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
        .field-row select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
        
        .radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .radio-btn { flex: 1; min-width: 100px; }
        .radio-btn input { display: none; }
        .radio-btn label { display: block; text-align: center; padding: 10px 14px; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; }
        .radio-btn input:checked + label { border-color: #2c5aa0; background: #eff6ff; color: #2c5aa0; font-weight: 700; }
        .radio-btn label:hover { border-color: #93c5fd; }
        
        .result-card { background: linear-gradient(135deg, #0f172a, #1e293b); border-radius: 12px; padding: 24px; color: white; }
        .result-card h3 { margin: 0 0 16px 0; font-size: 1.1rem; color: #e2e8f0; }
        
        .rec-main { font-size: 1.8rem; font-weight: 700; color: #60a5fa; margin-bottom: 8px; }
        .rec-sub { font-size: 1rem; color: #94a3b8; margin-bottom: 20px; }
        
        .rec-detail { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .rec-item { text-align: center; background: rgba(255,255,255,0.08); border-radius: 8px; padding: 12px 8px; }
        .rec-item-value { font-size: 1.1rem; font-weight: 700; }
        .rec-item-label { font-size: 0.65rem; color: #94a3b8; margin-top: 4px; }
        
        .equip-list { list-style: none; padding: 0; margin: 0; }
        .equip-list li { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; font-size: 0.9rem; }
        .equip-list li:last-child { border-bottom: none; }
        .equip-cat { color: #94a3b8; font-size: 0.75rem; }
        
        .reason-box { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; }
        .reason-box p { margin: 0; font-size: 0.85rem; color: #93c5fd; line-height: 1.5; }
        .reason-box strong { color: #60a5fa; }
        
        .print-bar { display: flex; gap: 10px; margin-top: 16px; }
        .print-bar .btn { padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; }
        
        .patient-header { background: #f8f9fa; border-radius: 12px; padding: 16px 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .patient-header h2 { margin: 0; font-size: 1.3rem; color: #1e293b; }
        .patient-header .meta { font-size: 0.85rem; color: #6b7280; }

        .code-badge { display:inline-block; background:#eff6ff; border:1px solid #bfdbfe; border-radius:6px; padding:4px 10px; font-family:monospace; font-size:0.95rem; font-weight:700; color:#1e40af; margin-right:6px; }
        .hard-stop { background:#fef2f2; border:2px solid #dc2626; border-radius:8px; padding:12px 16px; color:#991b1b; font-weight:600; margin-top:8px; }
        .xray-compartment-sub { margin-left:28px; padding:8px 12px; background:#f9fafb; border-left:3px solid #d1d5db; border-radius:0 6px 6px 0; margin-top:4px; margin-bottom:8px; }
        .xray-check { display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;font-size:0.85rem;transition:all 0.15s; }
        .xray-check:hover { background:#eff6ff;border-color:#93c5fd; }
        .xray-check input:checked + strong, .xray-check:has(input:checked) { background:#eff6ff; }
        .xray-comp-card { background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px; }
        .xray-comp-detail { display:none;margin-top:8px;display:flex;gap:8px;align-items:center; }
        .xray-comp-detail select { padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.8rem; }
        .xray-comp-detail input { padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:0.8rem; }

        .proceed-bar { display:flex; gap:10px; margin-top:24px; padding-top:16px; border-top:1px solid #e5e7eb; justify-content:flex-end; }
        .proceed-bar .btn { padding:10px 24px; border-radius:8px; font-size:0.95rem; font-weight:600; cursor:pointer; border:none; }
        .proceed-bar .btn-save { background:#2c5aa0; color:white; }
        .proceed-bar .btn-next { background:#059669; color:white; }

        @media print {
            .navbar, .prep-tabs, .print-bar, .btn, .proceed-bar { display: none !important; }
            .result-card { color: black !important; background: white !important; border: 2px solid #000 !important; }
            .rec-main, .rec-item-value { color: black !important; }
            .rec-item-label, .rec-sub, .reason-box p, .equip-cat { color: #333 !important; }
            .reason-box { background: #f0f0f0 !important; border-color: #999 !important; }
            .rec-item { background: #f0f0f0 !important; }
            .equip-list li { border-color: #ccc !important; color: black !important; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon">SRO</span>
            <span class="nav-title">SRO Intelligence</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/preop.html" class="nav-link">Pre-Op</a>
            <a href="/surgical-prep.html" class="nav-link active">Surg Prep</a>
            <a href="/nonop-plan.html" class="nav-link">Non-Op Plan</a>
            <a href="/analytics.html" class="nav-link">Analytics</a>
            <a href="/cms-compliance.html" class="nav-link">CMS Compliance</a>
            <a href="/rpm-report.html" class="nav-link">RPM Billing</a>
            <a href="/settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span id="userName">Loading...</span>
            <button class="btn btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="prep-container">
        <!-- Patient Header -->
        <div class="patient-header">
            <div>
                <h2 id="patientName">Select a Patient</h2>
                <span class="meta" id="patientMeta"></span>
            </div>
            <div>
                <select id="patientSelect" onchange="selectPatient()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.9rem;">
                    <option value="">Select patient...</option>
                </select>
            </div>
        </div>

        <!-- Tabs ‚Äî Hist/PE FIRST -->
        <div class="prep-tabs">
            <button class="prep-tab active" onclick="switchPrepTab('histpe')">üìã Hist/PE</button>
            <button class="prep-tab" onclick="switchPrepTab('prosthesis')">ü¶¥ Prosthesis</button>
            <button class="prep-tab" onclick="switchPrepTab('equipment')">üì¶ Equipment</button>
            <button class="prep-tab" onclick="switchPrepTab('precert')">üìã Precert</button>
            <button class="prep-tab" onclick="switchPrepTab('contract')">‚úçÔ∏è Contract</button>
            <button class="prep-tab" onclick="switchPrepTab('consent')">‚öïÔ∏è Consent</button>
            <button class="prep-tab" onclick="switchPrepTab('insurance')">üè• Insurance</button>
            <button class="prep-tab" onclick="switchPrepTab('disposition')">üè† Disposition</button>
            <button class="prep-tab" onclick="switchPrepTab('prehab')">üí™ Prehab/Prep</button>
            <button class="prep-tab" onclick="switchPrepTab('education')">üìö Patient Ed</button>
        </div>

        <!-- ============ TAB 1: HIST/PE ============ -->
        <div id="panelHistpe" class="prep-panel active">
            <div class="calc-grid">
                <div>
                    <!-- Planned Procedure & Diagnosis -->
                    <div class="input-card">
                        <h3>Planned Procedure & Diagnosis</h3>
                        <div class="field-row">
                            <label>Planned Procedure</label>
                            <select id="histProcedure" onchange="onProcedureChange()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                                <option value="">Select procedure...</option>
                                <option value="TKA">Total Knee Arthroplasty (TKA)</option>
                                <option value="Partial_Knee">Partial Knee / Unicompartmental (UKA)</option>
                                <option value="THA">Total Hip Arthroplasty (THA)</option>
                                <option value="Partial_Hip">Partial Hip / Hemiarthroplasty (degenerative)</option>
                                <option value="Hip_Fracture">Hip Fracture Hemiarthroplasty</option>
                                <option value="TSA">Total Shoulder Arthroplasty (TSA)</option>
                            </select>
                            <div id="histCPTBadge" style="margin-top:8px;"></div>
                        </div>
                        <div class="field-row">
                            <label>Primary Diagnosis (ICD-10)</label>
                            <select id="histDiagnosis" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                                <option value="">Select diagnosis...</option>
                                <optgroup label="Knee ‚Äî Primary Osteoarthritis">
                                    <option value="M17.11">M17.11 ‚Äî Primary OA, Right Knee</option>
                                    <option value="M17.12">M17.12 ‚Äî Primary OA, Left Knee</option>
                                </optgroup>
                                <optgroup label="Knee ‚Äî Post-traumatic OA">
                                    <option value="M17.31">M17.31 ‚Äî Post-traumatic OA, Right Knee</option>
                                    <option value="M17.32">M17.32 ‚Äî Post-traumatic OA, Left Knee</option>
                                </optgroup>
                                <optgroup label="Knee ‚Äî Rheumatoid Arthritis">
                                    <option value="M05.761">M05.761 ‚Äî RA, Right Knee</option>
                                    <option value="M05.762">M05.762 ‚Äî RA, Left Knee</option>
                                </optgroup>
                                <optgroup label="Knee ‚Äî AVN">
                                    <option value="M87.061">M87.061 ‚Äî AVN, Right Knee</option>
                                    <option value="M87.062">M87.062 ‚Äî AVN, Left Knee</option>
                                </optgroup>
                                <optgroup label="Hip ‚Äî Primary Osteoarthritis">
                                    <option value="M16.11">M16.11 ‚Äî Primary OA, Right Hip</option>
                                    <option value="M16.12">M16.12 ‚Äî Primary OA, Left Hip</option>
                                </optgroup>
                                <optgroup label="Hip ‚Äî Post-traumatic OA">
                                    <option value="M16.31">M16.31 ‚Äî Post-traumatic OA, Right Hip</option>
                                    <option value="M16.32">M16.32 ‚Äî Post-traumatic OA, Left Hip</option>
                                </optgroup>
                                <optgroup label="Hip ‚Äî Rheumatoid Arthritis">
                                    <option value="M05.751">M05.751 ‚Äî RA, Right Hip</option>
                                    <option value="M05.752">M05.752 ‚Äî RA, Left Hip</option>
                                </optgroup>
                                <optgroup label="Hip ‚Äî AVN">
                                    <option value="M87.051">M87.051 ‚Äî AVN, Right Hip</option>
                                    <option value="M87.052">M87.052 ‚Äî AVN, Left Hip</option>
                                </optgroup>
                                <optgroup label="Hip Fracture (TEAM-eligible)">
                                    <option value="S72.001A">S72.001A ‚Äî Fx Neck of Femur, Right</option>
                                    <option value="S72.002A">S72.002A ‚Äî Fx Neck of Femur, Left</option>
                                    <option value="S72.091A">S72.091A ‚Äî Other Fx Head/Neck Femur, Right</option>
                                    <option value="S72.092A">S72.092A ‚Äî Other Fx Head/Neck Femur, Left</option>
                                    <option value="S72.101A">S72.101A ‚Äî Unspecified Trochanteric Fx, Right</option>
                                    <option value="S72.102A">S72.102A ‚Äî Unspecified Trochanteric Fx, Left</option>
                                    <option value="S72.141A">S72.141A ‚Äî Displaced Intertrochanteric Fx, Right</option>
                                    <option value="S72.142A">S72.142A ‚Äî Displaced Intertrochanteric Fx, Left</option>
                                    <option value="S72.21XA">S72.21XA ‚Äî Subtrochanteric Fx, Right</option>
                                    <option value="S72.22XA">S72.22XA ‚Äî Subtrochanteric Fx, Left</option>
                                </optgroup>
                                <optgroup label="Shoulder ‚Äî Primary Osteoarthritis">
                                    <option value="M19.011">M19.011 ‚Äî Primary OA, Right Shoulder</option>
                                    <option value="M19.012">M19.012 ‚Äî Primary OA, Left Shoulder</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <!-- Surgical History -->
                    <div class="input-card" style="margin-top:16px;">
                        <h3>üìÅ Surgical History</h3>
                        <div id="historyEntries">
                            <div style="color:#6b7280;padding:12px;text-align:center;">No surgical history recorded. Click "Add Entry" below.</div>
                        </div>
                        <button class="btn" style="background:#2c5aa0;color:white;margin-top:12px;" onclick="addHistoryEntry('surgery')">+ Add Surgery</button>
                    </div>
                </div>

                <div>
                    <!-- Prior Injuries -->
                    <div class="input-card">
                        <h3>Previous Injuries to This Joint</h3>
                        <div class="field-row">
                            <label>Prior Injuries</label>
                            <textarea id="histPriorInjuries" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;" placeholder="ACL tear, meniscus tear, fracture, etc."></textarea>
                        </div>
                        <div class="field-row">
                            <label>Prior Treatments for This Joint</label>
                            <div style="display:flex;flex-direction:column;gap:6px;">
                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;">
                                    <input type="checkbox" id="histPT" onchange="togglePTWeeks()"> Physical Therapy and/or Formal Home Therapy/Exercises
                                </label>
                                <div id="histPTWeeksRow" style="display:none;margin-left:28px;">
                                    <label style="font-size:0.85rem;font-weight:500;">How many weeks? <input type="number" id="histPTWeeks" min="1" max="104" style="width:70px;padding:6px;border:1px solid #d1d5db;border-radius:6px;margin-left:6px;"></label>
                                </div>

                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;">
                                    <input type="checkbox" id="histInjCort" onchange="toggleSteroidCheck()"> Corticosteroid Injections
                                </label>
                                <div id="histSteroidDateRow" style="display:none;margin-left:28px;">
                                    <label style="font-size:0.85rem;font-weight:500;">Date of last injection: <input type="date" id="histSteroidDate" onchange="checkSteroid3Months()" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;margin-left:6px;"></label>
                                    <div id="histSteroidWarning" style="display:none;" class="hard-stop">
                                        ‚õî HARD STOP ‚Äî Surgery must be &gt;3 months after last corticosteroid injection. Current gap is insufficient. Postpone surgery date or confirm injection date.
                                    </div>
                                </div>

                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="histInjHA"> Hyaluronic Acid (Gel) Injections</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="histInjPRP"> PRP Injections</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="histArthroscopy"> Prior Arthroscopy</label>
                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="histBracing"> Bracing</label>

                                <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;">
                                    <input type="checkbox" id="histNSAIDs" onchange="toggleNSAIDAllergy()"> NSAIDs / Anti-inflammatory
                                </label>
                                <div id="histNSAIDAllergyRow" style="margin-left:28px;margin-top:4px;">
                                    <label style="font-size:0.85rem;font-weight:500;color:#dc2626;">
                                        Do you have an allergy to NSAIDs? 
                                        <select id="histNSAIDAllergy" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;margin-left:6px;">
                                            <option value="">Select...</option>
                                            <option value="no">No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Relevant History -->
                    <div class="input-card" style="margin-top:16px;">
                        <h3>Other Relevant History</h3>
                        <div class="field-row">
                            <label>Allergies (medications, latex, metals)</label>
                            <textarea id="histAllergies" rows="2" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;" placeholder="e.g., Penicillin ‚Äî hives, Latex ‚Äî anaphylaxis, Nickel ‚Äî rash"></textarea>
                        </div>
                        <div class="field-row">
                            <label>Current Medications</label>
                            <textarea id="histMedications" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;" placeholder="List current medications with doses..."></textarea>
                        </div>
                        <div class="field-row">
                            <label>Surgeon Notes</label>
                            <textarea id="histSurgeonNotes" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;" placeholder="Any additional clinical notes..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Physical Exam & X-Ray Findings ‚Äî opens in popup -->
            <div class="input-card" style="margin-top:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3>ü©ª Physical Exam &amp; X-Ray Findings</h3>
                    <button class="btn" style="background:#2c5aa0;color:white;padding:10px 20px;" onclick="openXrayModal()">Open X-Ray Assessment ‚Üó</button>
                </div>
                <div id="xraySummaryPreview" style="padding:12px;background:#f8fafc;border-radius:8px;margin-top:10px;font-size:0.85rem;color:#6b7280;">
                    No x-ray data entered yet. Click "Open X-Ray Assessment" above.
                </div>
            </div>

            <!-- Hist/PE Proceed -->
            <div class="proceed-bar">
                <button class="btn btn-save" onclick="saveHistory()">üíæ Save Hist/PE</button>
                <button class="btn btn-next" onclick="saveHistory();switchPrepTab('prosthesis')">Save &amp; Proceed to Prosthesis ‚Üí</button>
            </div>
        </div>

        <!-- Tab 1: Prosthesis Calculator -->
        <div id="panelProsthesis" class="prep-panel">
            <div class="calc-grid">
                <!-- Inputs -->
                <div>
                    <div class="input-card">
                        <h3>Patient Factors</h3>
                        <div class="field-row">
                            <label>Age</label>
                            <input type="number" id="calcAge" min="18" max="110" placeholder="e.g. 68" oninput="runCalculator()">
                        </div>
                        <div class="field-row">
                            <label>BMI</label>
                            <input type="number" id="calcBMI" min="15" max="80" step="0.1" placeholder="e.g. 32.4" oninput="runCalculator()">
                        </div>
                    </div>
                    
                    <div class="input-card" style="margin-top: 16px;">
                        <h3>Intraoperative Findings</h3>
                        <div class="field-row">
                            <label>Bone Quality</label>
                            <div class="radio-group">
                                <div class="radio-btn">
                                    <input type="radio" name="boneQuality" id="boneGood" value="good" checked onchange="runCalculator()">
                                    <label for="boneGood">Good</label>
                                </div>
                                <div class="radio-btn">
                                    <input type="radio" name="boneQuality" id="boneSoft" value="soft" onchange="runCalculator()">
                                    <label for="boneSoft">Soft</label>
                                </div>
                            </div>
                        </div>
                        <div class="field-row">
                            <label>PCL Status</label>
                            <div class="radio-group">
                                <div class="radio-btn">
                                    <input type="radio" name="pclStatus" id="pclIntact" value="intact" checked onchange="runCalculator()">
                                    <label for="pclIntact">Intact</label>
                                </div>
                                <div class="radio-btn">
                                    <input type="radio" name="pclStatus" id="pclDeficient" value="deficient" onchange="runCalculator()">
                                    <label for="pclDeficient">Deficient</label>
                                </div>
                            </div>
                        </div>
                        <div class="field-row">
                            <label>Collateral Ligaments</label>
                            <div class="radio-group">
                                <div class="radio-btn">
                                    <input type="radio" name="collaterals" id="collIntact" value="intact" checked onchange="runCalculator()">
                                    <label for="collIntact">Intact</label>
                                </div>
                                <div class="radio-btn">
                                    <input type="radio" name="collaterals" id="collTorn" value="torn" onchange="runCalculator()">
                                    <label for="collTorn">Torn</label>
                                </div>
                            </div>
                        </div>
                        <div class="field-row">
                            <label>Deformity (degrees)</label>
                            <input type="number" id="calcDeformity" min="0" max="60" step="1" value="0" oninput="runCalculator()">
                            <span id="deformitySource" style="font-size:0.8rem;color:#6b7280;font-style:italic;"></span>
                        </div>
                    </div>
                </div>

                <!-- Result -->
                <div>
                    <div class="result-card" id="resultCard">
                        <h3>Prosthesis Recommendation</h3>
                        <div id="calcResult">
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                Enter patient factors to generate recommendation
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="proceed-bar">
                <button class="btn btn-next" onclick="switchPrepTab('equipment')">Proceed to Equipment ‚Üí</button>
            </div>
        </div>


        <!-- Tab 2: Equipment List -->
        <div id="panelEquipment" class="prep-panel">
            <div class="input-card">
                <h3>üì¶ Equipment & Supply List for OR</h3>
                <div id="equipmentList" style="padding: 20px; color: #6b7280; text-align: center;">
                    Run the prosthesis calculator first to generate the equipment list.
                </div>
                <div class="print-bar" id="equipPrintBar" style="display: none;">
                    <button class="btn" style="background: #2c5aa0; color: white;" onclick="printEquipment()">üñ®Ô∏è Print Equipment List</button>
                </div>
            </div>
        
            <div class="proceed-bar">
                <button class="btn btn-next" onclick="switchPrepTab('precert')">Proceed to Precert ‚Üí</button>
            </div>
        </div>


        <!-- Tab 4: Precertification (modified ‚Äî CPT/ICD-10 + auto-pull X-ray) -->
        <div id="panelPrecert" class="prep-panel">
            <div class="calc-grid">
                <div>
                    <!-- Procedure Codes -->
                    <div class="input-card">
                        <h3>üìã Procedure & Diagnosis Codes</h3>
                        <div class="field-row">
                            <label>CPT Code (from Planned Procedure)</label>
                            <div id="precertCPT" style="font-size:1rem;padding:8px 0;">
                                <span style="color:#6b7280;">Select procedure on Hist/PE tab</span>
                            </div>
                        </div>
                        <div class="field-row">
                            <label>ICD-10 Diagnosis (from Hist/PE)</label>
                            <div id="precertICD" style="font-size:1rem;padding:8px 0;">
                                <span style="color:#6b7280;">Select diagnosis on Hist/PE tab</span>
                            </div>
                        </div>
                    </div>
                    <!-- Conservative Care auto-pulled -->
                    <div class="input-card" style="margin-top:16px;">
                        <h3>üìã Conservative Care Completed</h3>
                        <p style="font-size:0.8rem;color:#6b7280;margin:-8px 0 12px 0;">Auto-populated from Hist/PE tab. Check any additional items below.</p>
                        <div class="field-row">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
                                    <input type="checkbox" id="consPT" style="width:18px;height:18px;"> Physical Therapy (‚â•6 weeks)
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
                                    <input type="checkbox" id="consNSAIDs" style="width:18px;height:18px;"> NSAIDs / Anti-inflammatory
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
                                    <input type="checkbox" id="consInjections" style="width:18px;height:18px;"> Corticosteroid / HA Injections
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
                                    <input type="checkbox" id="consBracing" style="width:18px;height:18px;"> Bracing / Assistive Device
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
                                    <input type="checkbox" id="consActivity" style="width:18px;height:18px;"> Activity Modification
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;">
                                    <input type="checkbox" id="consWeight" style="width:18px;height:18px;"> Weight Loss Counseling
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <!-- X-Ray Summary from Hist/PE -->
                    <div class="input-card">
                        <h3>ü©ª X-Ray Summary <span style="font-size:0.8rem;font-weight:400;color:#6b7280;">(from Hist/PE)</span></h3>
                        <div id="precertXraySummary" style="background:#f9fafb;border-radius:8px;padding:16px;font-size:0.9rem;line-height:1.7;color:#374151;min-height:80px;">
                            Complete X-ray findings on the Hist/PE tab to auto-populate.
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-card" style="margin-top: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin:0;">Generated Precertification Summary</h3>
                    <button class="btn" style="background:#2c5aa0;color:white;padding:8px 16px;border-radius:8px;" onclick="generatePrecert()">Generate Summary</button>
                </div>
                <div id="precertOutput" style="background: #f8f9fa; border-radius: 8px; padding: 20px; font-size: 0.9rem; line-height: 1.7; color: #374151; white-space: pre-wrap;">
                    Click "Generate Summary" to create precertification document.
                </div>
                <div class="print-bar" id="precertPrintBar" style="display: none; margin-top: 12px;">
                    <button class="btn" style="background: #2c5aa0; color: white;" onclick="printPrecert()">üñ®Ô∏è Print Precertification</button>
                    <button class="btn" style="background: #059669; color: white;" onclick="copyPrecert()">üìã Copy to Clipboard</button>
                </div>
            </div>
            <div class="proceed-bar">
                <button class="btn btn-next" onclick="switchPrepTab('contract')">Proceed to Contract ‚Üí</button>
            </div>
        </div>

        <!-- Tab 4: Patient Contract (B2) -->
        <div id="panelContract" class="prep-panel">
            <div class="calc-grid">
                <div class="input-card">
                    <h3>‚úçÔ∏è Patient Agreement & Survey Commitment</h3>
                    <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:16px;margin-bottom:16px;line-height:1.7;font-size:0.9rem;color:#1e3a5f;">
                        <p style="font-weight:700;margin-bottom:8px;">I, <span id="contractPatientName" style="text-decoration:underline;">_______________</span>, understand and agree to the following:</p>
                        <div style="margin-left:12px;">
                            <p style="margin-bottom:6px;">1. I will complete all scheduled post-operative surveys (questionnaires about my pain and function) at the following intervals: <strong>6 weeks, 3 months, and 1 year</strong> after surgery.</p>
                            <p style="margin-bottom:6px;">2. I will complete daily check-ins through the SRO patient portal during my recovery period, reporting my pain level, physical therapy completion, and any concerns.</p>
                            <p style="margin-bottom:6px;">3. I will attend all scheduled follow-up appointments with my surgeon.</p>
                            <p style="margin-bottom:6px;">4. I will follow my prescribed physical therapy program and report any barriers to compliance.</p>
                            <p style="margin-bottom:6px;">5. I will notify my care team immediately if I experience any warning signs including: fever over 101.5¬∞F, increased redness/swelling/drainage at the incision, severe pain not controlled by medication, chest pain, shortness of breath, or calf pain/swelling.</p>
                            <p style="margin-bottom:6px;">6. I understand that my participation in these surveys helps my surgeon monitor my recovery and helps improve outcomes for future patients.</p>
                            <p>7. I understand that completing these surveys may be required by my insurance program (e.g., CMS TEAM, BPCI) and that non-completion may affect program participation.</p>
                        </div>
                    </div>
                    <div class="field-row">
                        <label>Patient Signature (type full name to sign)</label>
                        <input type="text" id="contractSignature" placeholder="Type full legal name here..." style="width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;font-size:1.1rem;font-family:'Brush Script MT',cursive,sans-serif;">
                    </div>
                    <div class="field-row">
                        <label>Date</label>
                        <input type="date" id="contractDate" style="padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem;">
                    </div>
                    <div id="contractSignedBadge" style="display:none;background:#dcfce7;border:1px solid #86efac;border-radius:8px;padding:12px;text-align:center;margin-top:12px;">
                        <span style="color:#166534;font-weight:700;font-size:1rem;">‚úÖ Contract Signed</span>
                        <span id="contractSignedInfo" style="color:#166534;font-size:0.85rem;margin-left:8px;"></span>
                    </div>
                </div>
                <div class="input-card">
                    <h3>Additional Commitments</h3>
                    <div class="field-row">
                        <label>Preferred Contact Method for Reminders</label>
                        <select id="contractContactMethod" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                            <option value="text">Text Message (SMS)</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone Call</option>
                            <option value="portal">Patient Portal Only</option>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Caregiver / Support Person</label>
                        <input type="text" id="contractCaregiver" placeholder="Name of person helping at home..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                    </div>
                    <div class="field-row">
                        <label>Caregiver Phone</label>
                        <input type="tel" id="contractCaregiverPhone" placeholder="555-123-4567" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                    </div>
                    <div class="field-row">
                        <label>Transportation Plan for Follow-ups</label>
                        <select id="contractTransport" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                            <option value="">Select...</option>
                            <option value="self">Self / Family Member</option>
                            <option value="ride_service">Ride Service (Uber, Lyft)</option>
                            <option value="medical_transport">Medical Transport</option>
                            <option value="needs_help">Needs Assistance</option>
                        </select>
                    </div>
                    <div style="margin-top:16px;display:flex;gap:10px;">
                        <button class="btn" style="background:#2c5aa0;color:white;" onclick="saveContract()">üíæ Save Contract</button>
                        <button class="btn" style="background:#059669;color:white;" onclick="printContract()">üñ®Ô∏è Print for Signature</button>
                    </div>
                </div>
            </div>
        
            <div class="proceed-bar">
                <button class="btn btn-save" onclick="saveContract()">üíæ Save Contract</button>
                <button class="btn btn-next" onclick="switchPrepTab('consent')">Proceed to Consent ‚Üí</button>
            </div>
        </div>


        <!-- Tab 5: Informed Consent (B3) -->
        <div id="panelConsent" class="prep-panel">
            <div class="calc-grid">
                <div class="input-card">
                    <h3>‚öïÔ∏è Informed Consent ‚Äî Procedure-Specific Risks</h3>
                    <div class="field-row">
                        <label>Procedure</label>
                        <div id="consentProcedure" style="font-weight:700;font-size:1.1rem;color:#1e40af;padding:8px 0;">Select a patient first</div>
                    </div>
                    <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:16px;margin-bottom:16px;">
                        <div style="font-weight:700;color:#92400e;margin-bottom:8px;">General Risks Discussed:</div>
                        <div style="display:flex;flex-direction:column;gap:6px;" id="consentGeneralRisks">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crInfection" style="width:16px;height:16px;"> Infection (superficial and deep)</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crDVT" style="width:16px;height:16px;"> DVT / Pulmonary Embolism (blood clots)</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crBleeding" style="width:16px;height:16px;"> Bleeding / Hematoma</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crNerve" style="width:16px;height:16px;"> Nerve or vessel injury</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crStiffness" style="width:16px;height:16px;"> Stiffness / Limited range of motion</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crPain" style="width:16px;height:16px;"> Continued pain after surgery</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crLoosening" style="width:16px;height:16px;"> Implant loosening / failure</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crFracture" style="width:16px;height:16px;"> Periprosthetic fracture</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crAnesthesia" style="width:16px;height:16px;"> Anesthesia risks</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crRevision" style="width:16px;height:16px;"> Need for future revision surgery</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crLegLength" style="width:16px;height:16px;"> Leg length discrepancy</label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;"><input type="checkbox" id="crDislocation" style="width:16px;height:16px;"> Dislocation (hip) / Instability (knee)</label>
                        </div>
                        <button style="margin-top:10px;padding:6px 14px;border:1px solid #d97706;border-radius:6px;background:white;cursor:pointer;font-size:0.8rem;color:#92400e;" onclick="checkAllConsent()">Check All</button>
                    </div>
                    <div class="field-row">
                        <label>Patient-Specific Risks (based on comorbidities)</label>
                        <div id="consentPatientRisks" style="background:#f8f9fa;border-radius:8px;padding:12px;font-size:0.9rem;color:#6b7280;min-height:40px;">
                            Select a patient to see personalized risks.
                        </div>
                    </div>
                    <div class="field-row">
                        <label>Additional Risks Discussed (free text)</label>
                        <textarea id="consentAdditional" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;" placeholder="Document any additional risks discussed with patient..."></textarea>
                    </div>
                </div>
                <div>
                    <div class="input-card">
                        <h3>Risk Statistics Shared</h3>
                        <div id="consentRiskStats" style="font-size:0.9rem;line-height:1.8;color:#374151;">
                            <p>Select a patient to populate risk statistics from their PreOp assessment.</p>
                        </div>
                    </div>
                    <div class="input-card" style="margin-top:16px;">
                        <h3>Consent Attestation</h3>
                        <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px;font-size:0.85rem;color:#1e3a5f;line-height:1.6;margin-bottom:12px;">
                            Patient has been informed of the nature of the procedure, expected benefits, material risks, alternatives (including non-operative management), and the risks of not having surgery. Patient has had the opportunity to ask questions and all questions have been answered to their satisfaction.
                        </div>
                        <div class="field-row">
                            <label>Patient Signature (type full name)</label>
                            <input type="text" id="consentPatientSig" placeholder="Patient types name here..." style="width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;font-size:1.1rem;font-family:'Brush Script MT',cursive,sans-serif;">
                        </div>
                        <div class="field-row">
                            <label>Witness</label>
                            <input type="text" id="consentWitness" placeholder="Witness name..." style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;">
                        </div>
                        <div class="field-row">
                            <label>Date</label>
                            <input type="date" id="consentDate" style="padding:10px;border:1px solid #d1d5db;border-radius:8px;">
                        </div>
                        <div id="consentSignedBadge" style="display:none;background:#dcfce7;border:1px solid #86efac;border-radius:8px;padding:12px;text-align:center;margin-top:8px;">
                            <span style="color:#166534;font-weight:700;">‚úÖ Consent Documented</span>
                            <span id="consentSignedInfo" style="color:#166534;font-size:0.85rem;margin-left:8px;"></span>
                        </div>
                        <div style="margin-top:12px;display:flex;gap:10px;">
                            <button class="btn" style="background:#2c5aa0;color:white;" onclick="saveConsent()">üíæ Save Consent</button>
                            <button class="btn" style="background:#059669;color:white;" onclick="printConsent()">üñ®Ô∏è Print Consent Form</button>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="proceed-bar">
                <button class="btn btn-save" onclick="saveConsent()">üíæ Save Consent</button>
                <button class="btn btn-next" onclick="switchPrepTab('insurance')">Proceed to Insurance ‚Üí</button>
            </div>
        </div>


        <!-- Tab 7: Insurance (simplified) -->
        <div id="panelInsurance" class="prep-panel">
            <div class="calc-grid">
                <div class="input-card">
                    <h3>üè• Insurance Information</h3>
                    <div class="field-row">
                        <label>Primary Plan Type</label>
                        <select id="insPlanType" onchange="onPlanTypeChange()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                            <option value="">Select...</option>
                            <option value="medicare_ffs">Medicare Fee-for-Service</option>
                            <option value="medicare_advantage">Medicare Advantage</option>
                            <option value="medicaid">Medicaid</option>
                            <option value="commercial_hmo">Commercial HMO</option>
                            <option value="commercial_ppo">Commercial PPO</option>
                            <option value="commercial_epo">Commercial EPO</option>
                            <option value="tricare">TRICARE</option>
                            <option value="workers_comp">Workers' Compensation</option>
                            <option value="self_pay">Self-Pay</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Secondary Insurance (if applicable)</label>
                        <input type="text" id="insSecondary" placeholder="Secondary carrier and ID..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                    </div>
                </div>
                <div>
                    <div class="input-card">
                        <h3>Quality Programs &amp; Bundles <span style="font-size:0.8rem;font-weight:400;color:#6b7280;">(auto-selected by plan type)</span></h3>
                        <div style="display:flex;flex-direction:column;gap:8px;" id="insQualityPrograms">
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="insTEAM" style="width:16px;height:16px;"> CMS TEAM (Transforming Episode Accountability Model)</label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="insBPCI" style="width:16px;height:16px;"> BPCI Advanced</label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="insCJR" style="width:16px;height:16px;"> CJR (Comprehensive Joint Replacement)</label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="insCommBundle" style="width:16px;height:16px;"> Commercial Bundle / COE</label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;"><input type="checkbox" id="insMSSP" style="width:16px;height:16px;"> MSSP / ACO</label>
                        </div>
                        <div class="field-row" style="margin-top:12px;">
                            <label>Program Notes</label>
                            <textarea id="insProgramNotes" rows="2" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;" placeholder="e.g., TEAM Episode Initiator, target price $25,000..."></textarea>
                        </div>
                    </div>
                    <div class="input-card" style="margin-top:16px;">
                        <h3>Prior Authorization <span id="insAuthRequiredNote" style="font-size:0.8rem;font-weight:400;color:#6b7280;"></span></h3>
                        <div class="field-row">
                            <label>Authorization Status</label>
                            <select id="insAuthStatus" onchange="updateAuthBadge()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                                <option value="not_submitted">Not Submitted</option>
                                <option value="submitted">Submitted ‚Äî Pending</option>
                                <option value="approved">Approved</option>
                                <option value="denied">Denied</option>
                                <option value="appeal">Under Appeal</option>
                                <option value="not_required">Not Required</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Authorization Number</label>
                            <input type="text" id="insAuthNum" placeholder="Auth number if approved..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;">
                        </div>
                        <div class="calc-grid" style="gap:12px;">
                            <div class="field-row">
                                <label>Auth Start Date</label>
                                <input type="date" id="insAuthStart" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;">
                            </div>
                            <div class="field-row">
                                <label>Auth End Date</label>
                                <input type="date" id="insAuthEnd" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;">
                            </div>
                        </div>
                        <div id="insAuthBadge" style="display:none;border-radius:8px;padding:10px;text-align:center;margin-top:8px;font-weight:700;"></div>
                    </div>
                </div>
            </div>
            <div class="proceed-bar">
                <button class="btn btn-save" onclick="saveInsurance()">üíæ Save Insurance Info</button>
                <button class="btn btn-next" onclick="saveInsurance();switchPrepTab('disposition')">Proceed to Disposition ‚Üí</button>
            </div>
        </div>

        <!-- Tab 8: Post-Op Disposition -->
        <div id="panelDisposition" class="prep-panel">
            <div class="input-card">
                <h3>üìã Surgical Setting & Post-Op Disposition</h3>
                <p style="color:#6b7280;font-size:0.85rem;margin-bottom:16px;">Determines ASC vs HOPD vs Inpatient setting AND post-op discharge destination. Based on published patient selection criteria (AAHKS 2024, Meneghini risk stratification, Bodrogi outpatient THA criteria).</p>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <h4 style="margin:0 0 12px 0;color:#1e3a5f;">Patient Assessment</h4>
                        <div class="field-row"><label>Age</label>
                            <select id="dispAge" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">&lt; 65 years</option>
                                <option value="1">65 ‚Äì 74 years</option>
                                <option value="2">75 ‚Äì 80 years</option>
                                <option value="3">&gt; 80 years</option>
                            </select>
                        </div>
                        <div class="field-row"><label>BMI</label>
                            <select id="dispBMI" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">&lt; 35</option>
                                <option value="1">35 ‚Äì 39.9</option>
                                <option value="2">40 ‚Äì 44.9</option>
                                <option value="3">‚â• 45</option>
                            </select>
                        </div>
                        <div class="field-row"><label>ASA Classification</label>
                            <select id="dispASA" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">ASA I ‚Äì II</option>
                                <option value="1">ASA III (well-controlled)</option>
                                <option value="2">ASA III (poorly controlled)</option>
                                <option value="3">ASA IV</option>
                            </select>
                        </div>
                        <div class="field-row"><label>TUG Test (Timed Up &amp; Go)</label>
                            <select id="dispTUG" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">&lt; 10 seconds (normal mobility)</option>
                                <option value="1">10 ‚Äì 14 seconds (mostly independent)</option>
                                <option value="2">15 ‚Äì 19 seconds (impaired, variable)</option>
                                <option value="3">‚â• 20 seconds (poor mobility / fall risk)</option>
                            </select>
                        </div>
                        <div class="field-row"><label>TUG Time (seconds)</label>
                            <input type="number" id="dispTUGsec" min="3" max="120" step="0.1" placeholder="e.g. 12.5" style="max-width:120px;">
                        </div>
                    </div>
                    <div>
                        <h4 style="margin:0 0 12px 0;color:#1e3a5f;">Social &amp; Functional</h4>
                        <div class="field-row"><label>Help at Home</label>
                            <select id="dispHome" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">Capable adult helper available 24‚Äì72 hrs</option>
                                <option value="1">Helper available but limited (elderly spouse, part-time)</option>
                                <option value="2">No help / lives alone</option>
                            </select>
                        </div>
                        <div class="field-row"><label>Contralateral Leg Status</label>
                            <select id="dispContra" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">Normal / mild arthritis</option>
                                <option value="1">Severe arthritis (limits weight-bearing)</option>
                                <option value="2">Amputee / non-weight-bearing</option>
                            </select>
                        </div>
                        <div class="field-row"><label>Cardiac / Pulmonary Status</label>
                            <select id="dispCardPulm" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">None or well-controlled mild disease</option>
                                <option value="1">Moderate (e.g. controlled CHF, stable COPD)</option>
                                <option value="2">Severe / uncontrolled (CHF EF&lt;40%, O2-dependent)</option>
                            </select>
                        </div>
                        <div class="field-row"><label>Senescence / Frailty Concern</label>
                            <select id="dispFrailty" onchange="runDisposition()">
                                <option value="">-- Select --</option>
                                <option value="0">No frailty concerns</option>
                                <option value="1">Mild frailty (slow gait, mild weakness)</option>
                                <option value="2">Moderate-severe frailty (poor endurance, sarcopenia)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Surgical Setting Result -->
            <div class="input-card" id="dispSettingResult" style="display:none;">
                <h3>‚öïÔ∏è Recommended Surgical Setting</h3>
                <div id="dispSettingContent"></div>
            </div>

            <!-- Post-Op Discharge Destination -->
            <div class="input-card">
                <h3>üè† Post-Op Discharge Destination</h3>
                <p style="color:#6b7280;font-size:0.85rem;margin-bottom:12px;">Select planned post-op care pathway. This drives check-in schedule and alert thresholds.</p>
                <div class="field-row"><label>Discharge Destination</label>
                    <select id="dispDestination" onchange="updateDischargeDetail()">
                        <option value="">-- Select --</option>
                        <option value="home_outpt_pt">Home ‚Üí Outpatient PT</option>
                        <option value="home_home_pt">Home ‚Üí Home PT (therapist comes to patient)</option>
                        <option value="home_health">Home Health (nursing + therapy visits)</option>
                        <option value="snf">Skilled Nursing Facility (SNF) / Inpatient Rehab</option>
                    </select>
                </div>
                <div id="dischargeDetail" style="display:none;margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;font-size:0.85rem;"></div>
            </div>

            <div class="proceed-bar">
                <button class="btn btn-save" onclick="saveDisposition()">üíæ Save Disposition</button>
                <button class="btn btn-next" onclick="saveDisposition();switchPrepTab('prehab')">Proceed to Prehab/Prep ‚Üí</button>
            </div>
        </div>

        <!-- Tab 9: Prehab & Patient Prep -->
        <div id="panelPrehab" class="prep-panel">
            <div class="input-card">
                <h3>üí™ Prehabilitation & Patient Preparation</h3>
                <p style="color:#6b7280;font-size:0.85rem;margin-bottom:12px;">Evidence-based recommendations generated from this patient's comorbidity profile. Print for patient handout.</p>
                <button class="btn" style="background:#2c5aa0;color:white;" onclick="generatePrehabPlan()">üîÑ Generate Prehab Plan from Patient Data</button>
            </div>

            <!-- Prehab Exercise Section -->
            <div class="input-card" id="prehabExerciseCard" style="display:none;">
                <h3>üèÉ Pre-Operative Exercise Program</h3>
                <div id="prehabExerciseContent"></div>
            </div>

            <!-- Supplement Section -->
            <div class="input-card" id="prehabSupplementCard" style="display:none;">
                <h3>üíä Supplement & Nutrition Recommendations</h3>
                <div id="prehabSupplementContent"></div>
            </div>

            <!-- Comorbidity-Driven Tests & Consults -->
            <div class="input-card" id="prehabTestsCard" style="display:none;">
                <h3>üî¨ Required Pre-Op Tests & Consults</h3>
                <p style="color:#6b7280;font-size:0.8rem;margin-bottom:8px;">Based on patient's comorbidity profile from PreOp assessment.</p>
                <div id="prehabTestsContent"></div>
            </div>

            <!-- Medication Management -->
            <div class="input-card" id="prehabMedsCard" style="display:none;">
                <h3>üíâ Medication Management Before Surgery</h3>
                <div id="prehabMedsContent"></div>
            </div>

            <!-- Print -->
            <div class="input-card" id="prehabPrintCard" style="display:none;">
                <div style="text-align:center;">
                    <button class="btn" style="background:#1e40af;color:white;font-size:1rem;padding:12px 32px;" onclick="printPrehab()">üñ®Ô∏è Print Patient Preparation Packet</button>
                </div>
            </div>

            <div class="proceed-bar">
                <button class="btn btn-save" onclick="savePrehab()">üíæ Save Prehab Plan</button>
            </div>
        </div>

        <!-- Tab 10: Patient Education -->
        <div id="panelEducation" class="prep-panel">
            <div class="input-card">
                <h3>üìö Pre-Operative Patient Education</h3>
                <p style="color:#6b7280;font-size:0.85rem;margin-bottom:16px;">Printable patient education materials. Review with patient and provide handout.</p>
                <button class="btn" style="background:#1e40af;color:white;padding:10px 20px;" onclick="printEducation()">üñ®Ô∏è Print Patient Education Packet</button>
            </div>

            <!-- Skin Care -->
            <div class="input-card" style="margin-top:16px;">
                <h3 style="color:#dc2626;">‚ö†Ô∏è Skin Care ‚Äî CRITICAL</h3>
                <div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:8px;padding:16px;margin-bottom:12px;">
                    <p style="font-weight:700;color:#991b1b;font-size:1rem;margin-bottom:8px;">YOUR SURGERY WILL BE CANCELLED IF:</p>
                    <div style="display:flex;flex-direction:column;gap:6px;font-size:0.9rem;color:#1e293b;">
                        <span>‚ùå Any open wounds, cuts, or scratches on or near the operative leg/hip</span>
                        <span>‚ùå Any pimples, boils, rashes, or skin irritation on the operative limb</span>
                        <span>‚ùå Any skin infections anywhere on the operative leg/hip</span>
                        <span>‚ùå Any severe infection anywhere on the body (UTI, dental abscess, cellulitis, etc.)</span>
                        <span>‚ùå Any insect bites that are infected or open on the operative area</span>
                    </div>
                </div>
                <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:16px;">
                    <p style="font-weight:700;color:#166534;margin-bottom:8px;">INSTRUCTIONS:</p>
                    <div style="display:flex;flex-direction:column;gap:6px;font-size:0.9rem;color:#1e293b;">
                        <span>‚úÖ Keep the operative leg/hip clean and moisturized ‚Äî use unscented lotion</span>
                        <span>‚úÖ Do NOT shave the operative leg for 2 weeks before surgery</span>
                        <span>‚úÖ Shower with Chlorhexidine (Hibiclens) soap the night before AND morning of surgery</span>
                        <span>‚úÖ Use fresh, clean bed linens the night before surgery</span>
                        <span>‚úÖ Wear clean, loose-fitting clothes to the hospital</span>
                        <span>‚úÖ Remove all nail polish, jewelry, and body piercings before arrival</span>
                        <span>‚úÖ Report ANY new skin issues to our office IMMEDIATELY ‚Äî even small ones</span>
                    </div>
                </div>
            </div>

            <!-- Nutrition -->
            <div class="input-card" style="margin-top:16px;">
                <h3>ü•ó Nutrition ‚Äî Before & After Surgery</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <h4 style="color:#059669;font-size:0.95rem;">Before Surgery (2-4 weeks prior)</h4>
                        <div style="display:flex;flex-direction:column;gap:6px;font-size:0.9rem;">
                            <span>ü•© <strong>High-protein diet:</strong> 1.2-1.5 g/kg/day ‚Äî chicken, fish, eggs, Greek yogurt, beans</span>
                            <span>ü•§ <strong>Protein supplement:</strong> 1-2 shakes daily (20-30g protein per serving)</span>
                            <span>ü•¶ <strong>Fruits & vegetables:</strong> Rich in Vitamin C for wound healing</span>
                            <span>üíß <strong>Hydration:</strong> At least 8 glasses of water daily</span>
                            <span>üö´ <strong>Limit:</strong> Processed foods, excess sugar, alcohol</span>
                        </div>
                    </div>
                    <div>
                        <h4 style="color:#2563eb;font-size:0.95rem;">After Surgery</h4>
                        <div style="display:flex;flex-direction:column;gap:6px;font-size:0.9rem;">
                            <span>ü•© <strong>Continue high protein</strong> ‚Äî critical for tissue healing and muscle recovery</span>
                            <span>ü•§ <strong>Protein shakes</strong> if appetite is low in first few days</span>
                            <span>ü•¨ <strong>High-fiber foods</strong> ‚Äî prevent constipation from pain medications</span>
                            <span>üíß <strong>Extra hydration</strong> ‚Äî dehydration increases fall risk</span>
                            <span>üçé <strong>Iron-rich foods</strong> if anemic ‚Äî spinach, red meat, fortified cereals</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supplements -->
            <div class="input-card" style="margin-top:16px;">
                <h3>üíä Supplements</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:0.9rem;">
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #f59e0b;">
                        <strong>Vitamin D3:</strong> 2,000 IU daily (or 50,000 IU/week if deficient). Target ‚â•30 ng/mL. Start 4-6 weeks before surgery.
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #3b82f6;">
                        <strong>Protein Supplement:</strong> 20-30g per serving, 1-2x daily. Whey, pea, or collagen protein. Start 2 weeks before.
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #10b981;">
                        <strong>Calcium:</strong> 1,200 mg daily (with Vitamin D). Especially if age >65 or female.
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #ef4444;">
                        <strong>Iron:</strong> 325 mg ferrous sulfate daily (ONLY if anemic). Take with Vitamin C for absorption. Take on empty stomach.
                    </div>
                </div>
            </div>

            <!-- Walking/Exercise -->
            <div class="input-card" style="margin-top:16px;">
                <h3>üö∂ Walking & Exercise ‚Äî Prehab Program</h3>
                <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:16px;margin-bottom:12px;">
                    <p style="font-weight:700;color:#1e40af;margin-bottom:8px;">Goal: Get as strong and fit as possible BEFORE surgery</p>
                    <p style="font-size:0.85rem;color:#374151;">Patients who do prehab exercises for 4+ weeks before surgery have shorter hospital stays, better pain control, and faster recovery.</p>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <h4 style="font-size:0.95rem;">Daily Walking</h4>
                        <div style="display:flex;flex-direction:column;gap:4px;font-size:0.9rem;">
                            <span>üìè Start: 10-15 minutes daily (or as tolerated)</span>
                            <span>üìè Goal: 30 minutes daily by surgery date</span>
                            <span>üëü Steps goal: 5,000-7,000 steps/day</span>
                            <span>‚ö†Ô∏è Use walker/cane if needed for safety</span>
                        </div>
                    </div>
                    <div>
                        <h4 style="font-size:0.95rem;">Exercises (2-3x daily)</h4>
                        <div style="display:flex;flex-direction:column;gap:4px;font-size:0.9rem;" id="eduExerciseList">
                            <span>‚Ä¢ Quad sets ‚Äî 10 reps, hold 5 sec</span>
                            <span>‚Ä¢ Straight leg raises ‚Äî 10 reps each</span>
                            <span>‚Ä¢ Heel slides ‚Äî 10 reps</span>
                            <span>‚Ä¢ Ankle pumps ‚Äî 20 reps</span>
                            <span>‚Ä¢ Mini squats (hold onto counter) ‚Äî 10 reps</span>
                        </div>
                    </div>
                </div>
                <p style="font-size:0.85rem;color:#6b7280;margin-top:12px;font-style:italic;">See Prehab/Prep tab for full, personalized exercise plan generated from patient data.</p>
            </div>

            <!-- Medications -->
            <div class="input-card" style="margin-top:16px;">
                <h3>üíâ Medications ‚Äî What to Keep & What to Stop</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <h4 style="color:#dc2626;font-size:0.95rem;">üõë STOP Before Surgery</h4>
                        <div style="display:flex;flex-direction:column;gap:6px;font-size:0.85rem;">
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>NSAIDs</strong> (Ibuprofen, Aleve, Meloxicam) ‚Äî STOP 7 days before</div>
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>Warfarin (Coumadin)</strong> ‚Äî STOP 5 days before; may need Lovenox bridge</div>
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>Eliquis/Xarelto/Pradaxa</strong> ‚Äî STOP 48-72 hours before (varies by drug)</div>
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>Methotrexate</strong> ‚Äî HOLD 1 week before; resume 2 weeks after wound healed</div>
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>Biologics</strong> (Humira, Enbrel) ‚Äî HOLD 1-2 dosing cycles per rheumatology</div>
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>GLP-1</strong> (Ozempic, Wegovy, Mounjaro) ‚Äî HOLD 1 week before (aspiration risk)</div>
                            <div style="background:#fef2f2;padding:8px;border-radius:6px;"><strong>Herbal/Supplements</strong> (fish oil, ginkgo, garlic) ‚Äî STOP 2 weeks before</div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color:#059669;font-size:0.95rem;">‚úÖ CONTINUE / Day-Of Instructions</h4>
                        <div style="display:flex;flex-direction:column;gap:6px;font-size:0.85rem;">
                            <div style="background:#f0fdf4;padding:8px;border-radius:6px;"><strong>Blood pressure meds</strong> ‚Äî TAKE morning of surgery with sip of water</div>
                            <div style="background:#f0fdf4;padding:8px;border-radius:6px;"><strong>Heart medications</strong> ‚Äî TAKE as usual unless told otherwise</div>
                            <div style="background:#f0fdf4;padding:8px;border-radius:6px;"><strong>Aspirin 81mg</strong> ‚Äî CONTINUE unless surgeon says stop</div>
                            <div style="background:#fffbeb;padding:8px;border-radius:6px;"><strong>Metformin</strong> ‚Äî HOLD day of surgery and 48 hours after</div>
                            <div style="background:#fffbeb;padding:8px;border-radius:6px;"><strong>Insulin</strong> ‚Äî HALF dose morning of surgery; bring insulin to hospital</div>
                            <div style="background:#f0fdf4;padding:8px;border-radius:6px;"><strong>Anxiety/Depression meds</strong> ‚Äî TAKE as usual</div>
                            <div style="background:#f0fdf4;padding:8px;border-radius:6px;"><strong>Thyroid medication</strong> ‚Äî TAKE morning of surgery with sip of water</div>
                        </div>
                    </div>
                </div>
                <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:8px;padding:12px;margin-top:12px;">
                    <p style="font-weight:700;color:#92400e;margin-bottom:4px;">‚ö†Ô∏è IMPORTANT: Bring ALL medications to the hospital</p>
                    <p style="font-size:0.85rem;color:#78350f;">Bring the actual bottles so the surgical team can verify names, doses, and medications. If you are unsure about ANY medication, call our office before surgery.</p>
                </div>
            </div>

            <!-- Joint Class / Resources -->
            <div class="input-card" style="margin-top:16px;">
                <h3>üéì Joint Replacement Class & Resources</h3>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #2c5aa0;">
                        <strong>Joint Replacement Education Class</strong> ‚Äî Attendance required before surgery<br>
                        <span style="font-size:0.85rem;color:#6b7280;">Contact our office for schedule. Available in-person and virtual. Covers: what to expect, home preparation, exercises, recovery timeline.</span>
                        <div class="field-row" style="margin-top:8px;">
                            <label style="font-size:0.85rem;">Class Link/URL (optional):</label>
                            <input type="text" id="eduClassLink" placeholder="https://... or 'In-person ‚Äî see schedule'" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;">
                        </div>
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #059669;">
                        <strong>Home Preparation Checklist:</strong><br>
                        <span style="font-size:0.85rem;">‚òê Raised toilet seat &nbsp; ‚òê Grab bars in shower &nbsp; ‚òê Remove trip hazards (rugs, cords) &nbsp; ‚òê Stock easy-to-prepare meals &nbsp; ‚òê Arrange ride home and help for first 1-2 weeks &nbsp; ‚òê Ice machine or ice packs &nbsp; ‚òê Walker/crutches available</span>
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:4px solid #f59e0b;">
                        <strong>Nothing to Eat or Drink After Midnight</strong> the night before surgery (unless specifically instructed otherwise by anesthesia).
                    </div>
                </div>
            </div>

            <div class="proceed-bar">
                <button class="btn" style="background:#1e40af;color:white;padding:10px 20px;" onclick="printEducation()">üñ®Ô∏è Print Patient Education Packet</button>
            </div>
        </div>
    </div>

    <!-- X-Ray Assessment Modal -->
    <div id="xrayModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;overflow-y:auto;">
        <div style="max-width:900px;margin:30px auto;background:white;border-radius:12px;overflow:hidden;">
            <div style="background:linear-gradient(135deg,#1e3a5f,#2c5aa0);color:white;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;">
                <h2 style="margin:0;font-size:1.2rem;">ü©ª X-Ray & Physical Exam Assessment</h2>
                <button onclick="closeXrayModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:1rem;">‚úï Close</button>
            </div>
            <div style="padding:24px;">
                <!-- Knee-specific X-ray Findings -->
                <div id="xrayKneeSection">
                    <h3 style="color:#1e3a5f;border-bottom:2px solid #e5e7eb;padding-bottom:6px;">Knee X-Ray Findings</h3>

                    <!-- Alignment ‚Äî radio buttons all visible -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Alignment</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;" id="xrayAlignmentGroup">
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="" checked> Not assessed</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="neutral"> Neutral</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="varus_mild"> Mild Varus</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="varus_moderate"> Moderate Varus</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="varus_severe"> Severe Varus</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="valgus_mild"> Mild Valgus</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="valgus_moderate"> Moderate Valgus</label>
                            <label class="xray-check"><input type="radio" name="xrayAlign" value="valgus_severe"> Severe Valgus</label>
                        </div>
                    </div>

                    <!-- Joint Space Narrowing ‚Äî compartment checkboxes -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Joint Space Narrowing</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                            <div class="xray-comp-card">
                                <label class="xray-check"><input type="checkbox" id="xmNarrowMedial" onchange="xrayModalChanged()"> <strong>Medial</strong></label>
                                <div class="xray-comp-detail" id="xmNarrowMedialD">
                                    <select id="xmNarrowMedialSev"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe (Bone-on-Bone)</option></select>
                                    <input type="number" id="xmNarrowMedialMM" placeholder="mm" min="0" max="10" step="0.5" style="width:60px;">
                                </div>
                            </div>
                            <div class="xray-comp-card">
                                <label class="xray-check"><input type="checkbox" id="xmNarrowLateral" onchange="xrayModalChanged()"> <strong>Lateral</strong></label>
                                <div class="xray-comp-detail" id="xmNarrowLateralD">
                                    <select id="xmNarrowLateralSev"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe (Bone-on-Bone)</option></select>
                                    <input type="number" id="xmNarrowLateralMM" placeholder="mm" min="0" max="10" step="0.5" style="width:60px;">
                                </div>
                            </div>
                            <div class="xray-comp-card">
                                <label class="xray-check"><input type="checkbox" id="xmNarrowPF" onchange="xrayModalChanged()"> <strong>Patellofemoral</strong></label>
                                <div class="xray-comp-detail" id="xmNarrowPFD">
                                    <select id="xmNarrowPFSev"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe (Bone-on-Bone)</option></select>
                                    <input type="number" id="xmNarrowPFMM" placeholder="mm" min="0" max="10" step="0.5" style="width:60px;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Osteophytes ‚Äî compartment checkboxes -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Osteophytes</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                            <div class="xray-comp-card">
                                <label class="xray-check"><input type="checkbox" id="xmOsteoMedial" onchange="xrayModalChanged()"> <strong>Medial</strong></label>
                                <div class="xray-comp-detail" id="xmOsteoMedialD">
                                    <select id="xmOsteoMedialSev"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe</option></select>
                                </div>
                            </div>
                            <div class="xray-comp-card">
                                <label class="xray-check"><input type="checkbox" id="xmOsteoLateral" onchange="xrayModalChanged()"> <strong>Lateral</strong></label>
                                <div class="xray-comp-detail" id="xmOsteoLateralD">
                                    <select id="xmOsteoLateralSev"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe</option></select>
                                </div>
                            </div>
                            <div class="xray-comp-card">
                                <label class="xray-check"><input type="checkbox" id="xmOsteoPF" onchange="xrayModalChanged()"> <strong>Patellofemoral</strong></label>
                                <div class="xray-comp-detail" id="xmOsteoPFD">
                                    <select id="xmOsteoPFSev"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe</option></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sclerosis ‚Äî simple checkboxes -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Subchondral Sclerosis</label>
                        <div style="display:flex;gap:16px;">
                            <label class="xray-check"><input type="checkbox" id="xmSclerosisMedial"> Medial</label>
                            <label class="xray-check"><input type="checkbox" id="xmSclerosisLateral"> Lateral</label>
                            <label class="xray-check"><input type="checkbox" id="xmSclerosisPF"> Patellofemoral</label>
                        </div>
                    </div>
                </div>

                <!-- Hip-specific X-ray Findings -->
                <div id="xrayHipSection" style="display:none;">
                    <h3 style="color:#1e3a5f;border-bottom:2px solid #e5e7eb;padding-bottom:6px;">Hip X-Ray Findings</h3>

                    <!-- Joint Space -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Joint Space Narrowing</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label class="xray-check"><input type="radio" name="hipNarrow" value=""> Not assessed</label>
                            <label class="xray-check"><input type="radio" name="hipNarrow" value="none"> Normal</label>
                            <label class="xray-check"><input type="radio" name="hipNarrow" value="superior_mild"> Superior ‚Äî Mild</label>
                            <label class="xray-check"><input type="radio" name="hipNarrow" value="superior_severe"> Superior ‚Äî Severe/Bone-on-Bone</label>
                            <label class="xray-check"><input type="radio" name="hipNarrow" value="medial_mild"> Medial ‚Äî Mild</label>
                            <label class="xray-check"><input type="radio" name="hipNarrow" value="medial_severe"> Medial ‚Äî Severe</label>
                            <label class="xray-check"><input type="radio" name="hipNarrow" value="global"> Global Narrowing</label>
                        </div>
                    </div>

                    <!-- Femoral Head -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Femoral Head</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label class="xray-check"><input type="radio" name="hipFemHead" value=""> Not assessed</label>
                            <label class="xray-check"><input type="radio" name="hipFemHead" value="round"> Round (normal)</label>
                            <label class="xray-check"><input type="radio" name="hipFemHead" value="flattened"> Flattened</label>
                            <label class="xray-check"><input type="radio" name="hipFemHead" value="collapsed"> Collapsed (AVN)</label>
                            <label class="xray-check"><input type="radio" name="hipFemHead" value="large_cysts"> Large subchondral cysts</label>
                        </div>
                    </div>

                    <!-- Acetabulum -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Acetabular Changes</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label class="xray-check"><input type="checkbox" id="hipAcetSclerosis"> Sclerosis</label>
                            <label class="xray-check"><input type="checkbox" id="hipAcetCysts"> Subchondral cysts</label>
                            <label class="xray-check"><input type="checkbox" id="hipAcetOsteo"> Osteophytes</label>
                            <label class="xray-check"><input type="checkbox" id="hipProtrusio"> Protrusio acetabuli</label>
                            <label class="xray-check"><input type="checkbox" id="hipDysplasia"> Dysplasia</label>
                        </div>
                    </div>

                    <!-- Femoral Osteophytes -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Femoral Osteophytes</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label class="xray-check"><input type="checkbox" id="hipFemOsteo"> Present</label>
                            <label class="xray-check"><input type="checkbox" id="hipFemSclerosis"> Femoral neck sclerosis</label>
                        </div>
                    </div>

                    <!-- Additional Hip findings -->
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:600;display:block;margin-bottom:6px;">Additional Findings</label>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label class="xray-check"><input type="checkbox" id="hipHO"> Heterotopic ossification</label>
                            <label class="xray-check"><input type="checkbox" id="hipLLD"> Leg length discrepancy</label>
                            <label class="xray-check"><input type="checkbox" id="hipCAM"> CAM impingement</label>
                            <label class="xray-check"><input type="checkbox" id="hipPincer"> Pincer impingement</label>
                        </div>
                        <div style="margin-top:8px;">
                            <label style="font-size:0.85rem;">Leg length difference (mm): <input type="number" id="hipLLDmm" min="0" max="50" step="1" style="width:70px;padding:5px;border:1px solid #d1d5db;border-radius:6px;"></label>
                        </div>
                    </div>
                </div>

                <!-- Shared: KL Grade & Other Findings -->
                <div style="margin-top:16px;border-top:2px solid #e5e7eb;padding-top:16px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;">Kellgren-Lawrence Grade</label>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">
                                <label class="xray-check"><input type="radio" name="klGrade" value=""> N/A</label>
                                <label class="xray-check"><input type="radio" name="klGrade" value="1"> I ‚Äî Doubtful</label>
                                <label class="xray-check"><input type="radio" name="klGrade" value="2"> II ‚Äî Minimal</label>
                                <label class="xray-check"><input type="radio" name="klGrade" value="3"> III ‚Äî Moderate</label>
                                <label class="xray-check"><input type="radio" name="klGrade" value="4"> IV ‚Äî Severe</label>
                            </div>
                        </div>
                        <div>
                            <label style="font-weight:600;display:block;margin-bottom:6px;">Additional Findings</label>
                            <textarea id="xmAdditionalFindings" rows="3" placeholder="e.g., loose bodies, AVN changes, hardware from prior surgery..." style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:0.9rem;resize:vertical;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action buttons -->
                <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end;">
                    <button class="btn" style="background:#059669;color:white;padding:10px 24px;" onclick="saveXrayFromModal()">üíæ Save & Close</button>
                    <button class="btn" style="background:#6b7280;color:white;padding:10px 24px;" onclick="closeXrayModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLINIC_ID = sessionStorage.getItem('clinicId') || '11111111-1111-1111-1111-111111111111';
        const USER_NAME = sessionStorage.getItem('userName') || 'User';
        const USER_ROLE = sessionStorage.getItem('userRole') || 'surgeon';
        
        let patients = [];
        let currentPatient = null;
        let currentPreop = null;
        let lastRecommendation = null;

        // CPT code mapping
        const CPT_MAP = {
            'TKA': { code: '27447', desc: 'Total Knee Arthroplasty' },
            'Partial_Knee': { code: '27446', desc: 'Unicompartmental Knee Arthroplasty' },
            'THA': { code: '27130', desc: 'Total Hip Arthroplasty' },
            'Partial_Hip': { code: '27125', desc: 'Hemiarthroplasty, Hip (degenerative)' },
            'Hip_Fracture': { code: '27236', desc: 'Hemiarthroplasty for Hip Fracture' },
            'TSA': { code: '23472', desc: 'Total Shoulder Arthroplasty' }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            if (!CLINIC_ID) { window.location.href = '/index.html'; return; }
            
            const roleLabels = { surgeon: 'Surgeon', nurse: 'Nurse', admin: 'Admin' };
            const roleColors = { surgeon: '#2c5aa0', nurse: '#059669', admin: '#7c3aed' };
            document.getElementById('userName').innerHTML = USER_NAME + 
                ' <span style="background:' + (roleColors[USER_ROLE] || '#6b7280') + 
                ';color:white;padding:2px 8px;border-radius:10px;font-size:0.75rem;margin-left:6px;">' + 
                (roleLabels[USER_ROLE] || USER_ROLE) + '</span>';
            
            document.querySelectorAll('.nav-link').forEach(link => {
                const href = link.getAttribute('href');
                if (USER_ROLE === 'nurse') {
                    if (href === '/analytics.html' || href === '/settings.html') link.style.display = 'none';
                } else if (USER_ROLE === 'surgeon') {
                    if (href === '/rpm-report.html' || href === '/settings.html') link.style.display = 'none';
                }
            });
            
            await loadPatients();
            
            const params = new URLSearchParams(window.location.search);
            const patientId = params.get('patient');
            if (patientId) {
                document.getElementById('patientSelect').value = patientId;
                selectPatient();
            }
            // Initialize NSAID allergy visibility
            toggleNSAIDAllergy();
        });

        async function loadPatients() {
            try {
                const resp = await fetch(`/api/patients?clinic_id=${CLINIC_ID}`);
                patients = await resp.json();
                const select = document.getElementById('patientSelect');
                select.innerHTML = '<option value="">Select patient...</option>';
                patients.filter(p => p.episode_id).forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = `${p.last_name}, ${p.first_name}${p.mrn ? ' [' + p.mrn + ']' : ''} ‚Äî ${p.surgery_type || 'No surgery'}`;
                    select.appendChild(opt);
                });
            } catch(e) { console.error('Error loading patients:', e); }
        }

        async function selectPatient() {
            const id = document.getElementById('patientSelect').value;
            if (!id) { currentPatient = null; currentPreop = null; document.getElementById('patientName').textContent = 'Select a Patient'; document.getElementById('patientMeta').textContent = ''; return; }
            
            currentPatient = patients.find(p => p.id === id);
            if (!currentPatient) return;
            
            surgPrepId = null;
            historyEntries = [];
            renderHistoryEntries();
            
            // Clear all form fields
            ['contractSignature','contractCaregiver','contractCaregiverPhone','consentPatientSig','consentWitness','consentAdditional',
             'histPriorInjuries','histAllergies','histMedications','histSurgeonNotes','insSecondary','insProgramNotes','insAuthNum'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
            ['contractContactMethod','contractTransport','insPlanType','insAuthStatus','histProcedure','histDiagnosis',
             'histNSAIDAllergy'].forEach(id => {
                const el = document.getElementById(id); if (el) el.selectedIndex = 0;
            });
            ['histPT','histInjCort','histInjHA','histInjPRP','histArthroscopy','histBracing','histNSAIDs',
             'insTEAM','insBPCI','insCJR','insCommBundle','insMSSP',
             'xmNarrowMedial','xmNarrowLateral','xmNarrowPF','xmOsteoMedial','xmOsteoLateral','xmOsteoPF',
             'xmSclerosisMedial','xmSclerosisLateral','xmSclerosisPF',
             'hipAcetSclerosis','hipAcetCysts','hipAcetOsteo','hipProtrusio','hipDysplasia',
             'hipFemOsteo','hipFemSclerosis','hipHO','hipLLD','hipCAM','hipPincer'].forEach(id => {
                const el = document.getElementById(id); if (el) el.checked = false;
            });
            // Reset x-ray radio buttons
            document.querySelectorAll('input[name="xrayAlign"], input[name="hipNarrow"], input[name="hipFemHead"], input[name="klGrade"]').forEach(r => { if (r.value === '') r.checked = true; else r.checked = false; });
            document.querySelectorAll('#consentGeneralRisks input').forEach(cb => cb.checked = false);
            ['contractSignedBadge','consentSignedBadge','insAuthBadge'].forEach(id => {
                const el = document.getElementById(id); if (el) el.style.display = 'none';
            });
            // Hide sub-sections
            ['histPTWeeksRow','histSteroidDateRow'].forEach(id => {
                const el = document.getElementById(id); if (el) el.style.display = 'none';
            });
            ['histPTWeeks','histSteroidDate','insAuthStart','insAuthEnd',
             'xmNarrowMedialMM','xmNarrowLateralMM','xmNarrowPFMM','hipLLDmm','xmAdditionalFindings'].forEach(id => {
                const el = document.getElementById(id); if (el) el.value = '';
            });
            // Clear dynamic displays
            ['histCPTBadge','precertCPT','precertICD','deformitySource','insAuthRequiredNote','histSteroidWarning'].forEach(id => {
                const el = document.getElementById(id); if (el) { el.innerHTML = ''; if(el.style) el.style.display = (id === 'histSteroidWarning') ? 'none' : ''; }
            });
            document.getElementById('histNSAIDAllergyRow').style.display = 'block'; // shown by default (no NSAIDs)
            
            document.getElementById('patientName').innerHTML = `${currentPatient.first_name} ${currentPatient.last_name}` +
                (currentPatient.mrn ? ` <span style="font-size:0.85rem;color:#94a3b8;font-weight:400;">[${currentPatient.mrn}]</span>` : '');
            const daysPostOp = currentPatient.surgery_date ? Math.floor((Date.now() - new Date(currentPatient.surgery_date)) / (1000*60*60*24)) : null;
            document.getElementById('patientMeta').textContent = 
                `${currentPatient.surgery_type || ''} ¬∑ ${currentPatient.surgeon_first_name ? 'Dr. ' + currentPatient.surgeon_last_name : ''} ¬∑ ${daysPostOp !== null && daysPostOp >= 0 ? 'Day ' + daysPostOp + ' post-op' : currentPatient.surgery_date ? Math.abs(daysPostOp) + ' days to surgery' : 'No surgery date'}`;
            
            // Auto-set procedure from surgery_type and LOCK it
            const stMap = {'Total Knee Arthroplasty':'TKA','TKA':'TKA','Total Hip Arthroplasty':'THA','THA':'THA','Total Shoulder Arthroplasty':'TSA','TSA':'TSA','Partial Knee':'Partial_Knee','UKA':'Partial_Knee','Partial_Knee':'Partial_Knee','Partial Hip':'Partial_Hip','Partial_Hip':'Partial_Hip','Hemiarthroplasty':'Partial_Hip','Hip Fracture':'Hip_Fracture','Hip_Fracture':'Hip_Fracture','Revision TKA':'TKA','Revision THA':'THA'};
            const mapped = stMap[currentPatient.surgery_type];
            const procSelect = document.getElementById('histProcedure');
            if (mapped) {
                procSelect.value = mapped;
                // Lock procedure ‚Äî disable options that don't match the episode
                Array.from(procSelect.options).forEach(opt => {
                    if (opt.value && opt.value !== mapped) opt.disabled = true;
                });
                onProcedureChange();
            }
            
            // Load preop data
            try {
                const resp = await fetch(`/api/preop-postop-comparison/${id}`);
                const data = await resp.json();
                if (data.hasPreop) {
                    currentPreop = data.preop;
                    const fullResp = await fetch(`/api/preop-assessments?patient_id=${id}`);
                    const fullList = await fullResp.json();
                    if (fullList.length > 0) {
                        const latest = fullList.sort((a,b) => new Date(b.assessed_at) - new Date(a.assessed_at))[0];
                        currentPreop = { ...currentPreop, ...latest };
                    }
                }
            } catch(e) {}
            
            if (currentPreop?.age) document.getElementById('calcAge').value = currentPreop.age;
            else if (currentPatient.date_of_birth) {
                const age = Math.floor((Date.now() - new Date(currentPatient.date_of_birth)) / (365.25*24*60*60*1000));
                document.getElementById('calcAge').value = age;
            }
            if (currentPreop?.bmi) document.getElementById('calcBMI').value = parseFloat(currentPreop.bmi).toFixed(1);
            
            runCalculator();
            await loadSurgPrepData(id);
            // Auto-populate disposition from preop if fields are empty
            autoPopulateDisposition();
        }

        // ============ PROCEDURE / DIAGNOSIS HELPERS ============
        function onProcedureChange() {
            const proc = document.getElementById('histProcedure').value;
            const badge = document.getElementById('histCPTBadge');
            if (proc && CPT_MAP[proc]) {
                badge.innerHTML = '<span class="code-badge">CPT ' + CPT_MAP[proc].code + '</span> <span style="font-size:0.85rem;color:#374151;">' + CPT_MAP[proc].desc + '</span>';
            } else {
                badge.innerHTML = '';
            }
            // Toggle knee vs hip x-ray sections in modal
            const isHip = ['THA','Partial_Hip','Hip_Fracture'].includes(proc);
            const kneeSection = document.getElementById('xrayKneeSection');
            const hipSection = document.getElementById('xrayHipSection');
            if (kneeSection) kneeSection.style.display = isHip ? 'none' : 'block';
            if (hipSection) hipSection.style.display = isHip ? 'block' : 'none';
            // Toggle knee-specific prosthesis fields
            const pclRow = document.querySelector('[name="pclStatus"]')?.closest('.field-row');
            const collRow = document.querySelector('[name="collaterals"]')?.closest('.field-row');
            if (pclRow) pclRow.style.display = isHip ? 'none' : 'block';
            if (collRow) collRow.style.display = isHip ? 'none' : 'block';
            // Update education exercises for hip
            const exList = document.getElementById('eduExerciseList');
            if (exList) {
                if (isHip) {
                    exList.innerHTML = '<span>‚Ä¢ Glute bridges ‚Äî 10 reps, hold 5 sec</span><span>‚Ä¢ Clamshells ‚Äî 10 reps each side</span><span>‚Ä¢ Hip abduction (side lying) ‚Äî 10 reps</span><span>‚Ä¢ Ankle pumps ‚Äî 20 reps</span><span>‚Ä¢ Seated marching ‚Äî 10 reps each</span>';
                } else {
                    exList.innerHTML = '<span>‚Ä¢ Quad sets ‚Äî 10 reps, hold 5 sec</span><span>‚Ä¢ Straight leg raises ‚Äî 10 reps each</span><span>‚Ä¢ Heel slides ‚Äî 10 reps</span><span>‚Ä¢ Ankle pumps ‚Äî 20 reps</span><span>‚Ä¢ Mini squats (hold onto counter) ‚Äî 10 reps</span>';
                }
            }
        }

        // ============ TOGGLE HELPERS ============
        function togglePTWeeks() {
            document.getElementById('histPTWeeksRow').style.display = document.getElementById('histPT').checked ? 'block' : 'none';
        }

        function toggleSteroidCheck() {
            const show = document.getElementById('histInjCort').checked;
            document.getElementById('histSteroidDateRow').style.display = show ? 'block' : 'none';
            if (!show) document.getElementById('histSteroidWarning').style.display = 'none';
        }

        function checkSteroid3Months() {
            const injDate = document.getElementById('histSteroidDate').value;
            const surgDate = currentPatient?.surgery_date;
            const warn = document.getElementById('histSteroidWarning');
            if (!injDate || !surgDate) { warn.style.display = 'none'; return; }
            const inj = new Date(injDate);
            const surg = new Date(surgDate);
            const diffDays = (surg - inj) / (1000*60*60*24);
            if (diffDays < 90) {
                warn.style.display = 'block';
                warn.innerHTML = '‚õî HARD STOP ‚Äî Surgery date (' + surgDate + ') is only ' + Math.round(diffDays) + ' days after last corticosteroid injection (' + injDate + '). Must be >90 days (3 months). Postpone surgery or verify injection date.';
            } else {
                warn.style.display = 'none';
            }
        }

        function toggleNSAIDAllergy() {
            // Show allergy question when NSAIDs NOT checked
            document.getElementById('histNSAIDAllergyRow').style.display = document.getElementById('histNSAIDs').checked ? 'none' : 'block';
        }

        function toggleXraySub() {} // No-op ‚Äî x-ray now in modal
        function toggleCompartmentDetail() {} // No-op ‚Äî x-ray now in modal
        function xrayChanged() { updatePrecertXraySummary(); } // Delegate to precert update

        function updatePrecertXraySummary() {
            const d = getXrayData();
            let parts = [];
            const alignText = { neutral:'neutral alignment', varus_mild:'mild varus', varus_moderate:'moderate varus', varus_severe:'severe varus', valgus_mild:'mild valgus', valgus_moderate:'moderate valgus', valgus_severe:'severe valgus' };
            if (d.alignment) parts.push('Alignment: ' + (alignText[d.alignment] || d.alignment));
            
            // Knee narrowing
            const narrowComps = [];
            ['medial','lateral','pf'].forEach(c => {
                if (d['narrow_' + c]) {
                    const capC = c === 'pf' ? 'patellofemoral' : c;
                    let t = d['narrow_' + c + '_sev'] || 'present';
                    if (t === 'severe') t = 'severe (bone-on-bone)';
                    let mm = d['narrow_' + c + '_mm'];
                    narrowComps.push(capC + ': ' + t + (mm ? ', ' + mm + 'mm remaining' : ''));
                }
            });
            if (narrowComps.length) parts.push('Joint space narrowing ‚Äî ' + narrowComps.join('; '));

            // Knee osteophytes
            const osteoComps = [];
            ['medial','lateral','pf'].forEach(c => {
                if (d['osteo_' + c]) {
                    const capC = c === 'pf' ? 'patellofemoral' : c;
                    osteoComps.push(capC + ': ' + (d['osteo_' + c + '_sev'] || 'present'));
                }
            });
            if (osteoComps.length) parts.push('Osteophytes ‚Äî ' + osteoComps.join('; '));

            // Knee sclerosis
            const sclerosisComps = [];
            ['medial','lateral','pf'].forEach(c => {
                if (d['sclerosis_' + c]) sclerosisComps.push(c === 'pf' ? 'patellofemoral' : c);
            });
            if (sclerosisComps.length) parts.push('Subchondral sclerosis in ' + sclerosisComps.join(', ') + ' compartment(s)');

            // Hip findings
            if (d.hip_narrowing) parts.push('Hip narrowing: ' + d.hip_narrowing.replace(/_/g, ' '));
            if (d.hip_femoral_head && d.hip_femoral_head !== 'round') parts.push('Femoral head: ' + d.hip_femoral_head);
            const hipFindings = [];
            if (d.hip_acet_sclerosis) hipFindings.push('acetabular sclerosis');
            if (d.hip_acet_cysts) hipFindings.push('subchondral cysts');
            if (d.hip_acet_osteo) hipFindings.push('acetabular osteophytes');
            if (d.hip_protrusio) hipFindings.push('protrusio');
            if (d.hip_dysplasia) hipFindings.push('dysplasia');
            if (d.hip_fem_osteo) hipFindings.push('femoral osteophytes');
            if (d.hip_ho) hipFindings.push('heterotopic ossification');
            if (d.hip_lld) hipFindings.push('leg length discrepancy' + (d.hip_lld_mm ? ' (' + d.hip_lld_mm + 'mm)' : ''));
            if (hipFindings.length) parts.push('Hip: ' + hipFindings.join(', '));

            if (d.kl_grade) parts.push('Kellgren-Lawrence Grade ' + d.kl_grade);
            if (d.additional) parts.push('Notes: ' + d.additional.substring(0, 80));
            
            const el = document.getElementById('precertXraySummary');
            if (el) el.innerHTML = parts.length > 0 ? parts.map(p => '<div style="margin-bottom:6px;">‚Ä¢ ' + p + '</div>').join('') : '<span style="color:#6b7280;">Complete X-ray findings on the Hist/PE tab to auto-populate.</span>';
        }

        // ============ TAB SWITCHING ============
        function switchPrepTab(tab) {
            document.querySelectorAll('.prep-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.prep-panel').forEach(p => p.classList.remove('active'));
            
            const panels = { histpe:'panelHistpe', prosthesis:'panelProsthesis', equipment:'panelEquipment', precert:'panelPrecert', contract:'panelContract', consent:'panelConsent', insurance:'panelInsurance', disposition:'panelDisposition', prehab:'panelPrehab', education:'panelEducation' };
            document.getElementById(panels[tab]).classList.add('active');
            
            const tabOrder = ['histpe','prosthesis','equipment','precert','contract','consent','insurance','disposition','prehab','education'];
            const tabs = document.querySelectorAll('.prep-tab');
            const idx = tabOrder.indexOf(tab);
            if (idx >= 0 && tabs[idx]) tabs[idx].classList.add('active');
            
            if (tab === 'contract') populateContract();
            if (tab === 'consent') populateConsent();
            if (tab === 'insurance') updateAuthBadge();
            if (tab === 'precert') {
                updatePrecertXraySummary();
                updatePrecertCodes();
                // Auto-check conservative care from history
                if (document.getElementById('histPT').checked) document.getElementById('consPT').checked = true;
                if (document.getElementById('histNSAIDs').checked) document.getElementById('consNSAIDs').checked = true;
                if (document.getElementById('histInjCort').checked || document.getElementById('histInjHA').checked) document.getElementById('consInjections').checked = true;
                if (document.getElementById('histBracing').checked) document.getElementById('consBracing').checked = true;
            }
        }

        function updatePrecertCodes() {
            const proc = document.getElementById('histProcedure').value;
            const diag = document.getElementById('histDiagnosis');
            const cptDiv = document.getElementById('precertCPT');
            const icdDiv = document.getElementById('precertICD');
            
            if (proc && CPT_MAP[proc]) {
                cptDiv.innerHTML = '<span class="code-badge">CPT ' + CPT_MAP[proc].code + '</span> ' + CPT_MAP[proc].desc;
            } else {
                cptDiv.innerHTML = '<span style="color:#6b7280;">Select procedure on Hist/PE tab</span>';
            }
            if (diag.value) {
                const txt = diag.options[diag.selectedIndex].textContent;
                icdDiv.innerHTML = '<span class="code-badge">' + diag.value + '</span> ' + txt.split(' ‚Äî ')[1];
            } else {
                icdDiv.innerHTML = '<span style="color:#6b7280;">Select diagnosis on Hist/PE tab</span>';
            }
        }

        // ============ INSURANCE HELPERS ============
        function onPlanTypeChange() {
            const plan = document.getElementById('insPlanType').value;
            // Auto-select quality programs
            ['insTEAM','insBPCI','insCJR','insCommBundle','insMSSP'].forEach(id => document.getElementById(id).checked = false);
            const note = document.getElementById('insAuthRequiredNote');
            const authStatus = document.getElementById('insAuthStatus');
            
            if (plan === 'medicare_ffs') {
                document.getElementById('insTEAM').checked = true;
                document.getElementById('insBPCI').checked = true;
                note.textContent = '(typically not required for Medicare FFS)';
                authStatus.value = 'not_required';
            } else if (plan === 'medicare_advantage') {
                note.textContent = '(prior auth typically required)';
                authStatus.value = 'not_submitted';
            } else if (plan === 'commercial_hmo') {
                document.getElementById('insCommBundle').checked = true;
                note.textContent = '(prior auth typically required)';
                authStatus.value = 'not_submitted';
            } else if (plan === 'commercial_ppo' || plan === 'commercial_epo') {
                document.getElementById('insCommBundle').checked = true;
                note.textContent = '(prior auth may be required)';
                authStatus.value = 'not_submitted';
            } else if (plan === 'workers_comp' || plan === 'medicaid') {
                note.textContent = '(prior auth typically required)';
                authStatus.value = 'not_submitted';
            } else if (plan === 'tricare') {
                note.textContent = '(referral/auth may be needed)';
                authStatus.value = 'not_submitted';
            } else if (plan === 'self_pay') {
                note.textContent = '(not applicable)';
                authStatus.value = 'not_required';
            } else {
                note.textContent = '';
            }
            updateAuthBadge();
        }

        function updateAuthBadge() {
            const status = document.getElementById('insAuthStatus').value;
            const badge = document.getElementById('insAuthBadge');
            const colors = { approved:{bg:'#dcfce7',border:'#86efac',color:'#166534',text:'‚úÖ APPROVED'}, denied:{bg:'#fee2e2',border:'#fca5a5',color:'#991b1b',text:'‚ùå DENIED'}, submitted:{bg:'#fef3c7',border:'#fde68a',color:'#92400e',text:'‚è≥ PENDING'}, appeal:{bg:'#fef3c7',border:'#fde68a',color:'#92400e',text:'‚è≥ UNDER APPEAL'}, not_required:{bg:'#f0f9ff',border:'#bae6fd',color:'#1e40af',text:'‚ÑπÔ∏è NOT REQUIRED'} };
            const c = colors[status];
            if (c) {
                badge.style.display = 'block';
                badge.style.background = c.bg;
                badge.style.border = '1px solid ' + c.border;
                badge.style.color = c.color;
                badge.textContent = c.text;
                if (status === 'approved') {
                    const num = document.getElementById('insAuthNum').value;
                    const start = document.getElementById('insAuthStart').value;
                    const end = document.getElementById('insAuthEnd').value;
                    if (num) badge.textContent += ' ‚Äî #' + num;
                    if (start && end) badge.textContent += ' (' + start + ' to ' + end + ')';
                    else if (end) badge.textContent += ' (expires ' + end + ')';
                }
            } else { badge.style.display = 'none'; }
        }

        // ============ PROSTHESIS CALCULATOR ============
        function runCalculator() {
            const age = parseFloat(document.getElementById('calcAge').value);
            const bmi = parseFloat(document.getElementById('calcBMI').value);
            const bone = document.querySelector('input[name="boneQuality"]:checked')?.value || 'good';
            const pcl = document.querySelector('input[name="pclStatus"]:checked')?.value || 'intact';
            const coll = document.querySelector('input[name="collaterals"]:checked')?.value || 'intact';
            const deformity = parseFloat(document.getElementById('calcDeformity').value) || 0;
            const proc = document.getElementById('histProcedure').value;
            const isHip = ['THA','Partial_Hip','Hip_Fracture'].includes(proc);
            
            if (!age || !bmi) {
                document.getElementById('calcResult').innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;">Enter age and BMI to generate recommendation</div>';
                return;
            }
            
            let fixation, bearing, stem, constraint, reasons = [];

            if (isHip) {
                // ===== HIP PROSTHESIS LOGIC =====
                let headSize = '32mm';
                let bearingSurface = 'Cobalt-Chrome on Highly Cross-linked Poly';
                let cupType = 'Uncemented Porous-Coated';
                let stemType = 'Standard Taper';
                
                // Fixation decision
                if (age >= 75 || bone === 'soft') {
                    fixation = 'Cemented'; stem = 'Polished Taper';
                    reasons.push(age >= 75 ? `Age ${age} (‚â•75) ‚Äî cemented stem for reliable fixation` : 'Soft bone ‚Äî cemented stem for immediate stability');
                } else if (age < 55 && bone === 'good' && bmi <= 35) {
                    fixation = 'Uncemented'; stem = 'Short Stem';
                    reasons.push(`Age ${age} (<55) ‚Äî bone-preserving short stem with biological fixation`);
                    reasons.push('Good bone quality supports press-fit');
                } else {
                    fixation = 'Uncemented'; stem = 'Standard Taper';
                    reasons.push('Standard uncemented tapered stem ‚Äî workhorse for most patients');
                    if (bone === 'good') reasons.push('Good bone quality supports biological fixation');
                }
                
                // Bearing surface
                if (age < 55) {
                    bearingSurface = 'Ceramic on Highly Cross-linked Poly';
                    headSize = '36mm';
                    reasons.push(`Age ${age} (<55) ‚Äî ceramic head for lower wear in active patient`);
                    reasons.push('36mm head for improved stability and range of motion');
                } else if (age >= 75) {
                    headSize = '36mm';
                    bearingSurface = 'Cobalt-Chrome on Highly Cross-linked Poly';
                    reasons.push('36mm head ‚Äî reduces dislocation risk in elderly');
                } else {
                    headSize = '32mm';
                    reasons.push('Standard 32mm cobalt-chrome head on highly cross-linked poly');
                }
                
                // BMI adjustments
                if (bmi > 40) {
                    headSize = '36mm';
                    if (fixation === 'Uncemented') { fixation = 'Cemented'; stem = 'Polished Taper'; }
                    reasons.push(`BMI ${bmi.toFixed(1)} (>40) ‚Äî cemented stem, larger head for stability under high load`);
                } else if (bmi > 35) {
                    headSize = '36mm';
                    reasons.push(`BMI ${bmi.toFixed(1)} (>35) ‚Äî 36mm head for enhanced stability`);
                }
                
                // Cup ‚Äî always uncemented unless very poor bone
                if (bone === 'soft' && age >= 80) {
                    cupType = 'Cemented All-Poly';
                    reasons.push('Very elderly + soft bone ‚Äî cemented all-poly cup');
                }
                
                bearing = bearingSurface;
                constraint = headSize;
                lastRecommendation = { fixation, bearing, stem, constraint, reasons, age, bmi, bone, isHip: true, headSize, cupType, bearingSurface, stemType: stem };
                
                const mainLabel = `${fixation} THA ‚Äî ${headSize} Head`;
                const subLabel = `${stem} Stem ¬∑ ${cupType}`;
                
                let html = `
                    <div class="rec-main">${mainLabel}</div>
                    <div class="rec-sub">${subLabel}</div>
                    <div class="rec-sub" style="margin-top:4px;font-size:0.8rem;color:#059669;">${bearingSurface}</div>
                    <div style="margin-top: 16px; text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Clinical Rationale:</div>
                        ${reasons.map(r => '<div style="padding: 4px 0; font-size: 0.85rem; color: #374151;">‚Ä¢ ' + r + '</div>').join('')}
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn" style="background: #059669; color: white;" onclick="generateEquipmentList();switchPrepTab('equipment')">üì¶ Generate Equipment List</button>
                    </div>`;
                document.getElementById('calcResult').innerHTML = html;
                generateEquipmentList();
                return;
            }
            
            // ===== KNEE PROSTHESIS LOGIC (existing) =====
            // Decision tree (priority order ‚Äî most constrained first)
            
            if (coll === 'torn') {
                // Collaterals torn ‚Äî maximum constraint needed
                fixation = 'Cemented';
                bearing = 'PS';
                stem = 'Tibial Stem';
                constraint = 'Max CCK Poly';
                reasons.push('Collateral ligaments torn ‚Äî requires maximum constraint (CCK) for stability');
                reasons.push('Posterior stabilized design compensates for ligament deficiency');
                reasons.push('Tibial stem provides additional fixation for constrained construct');
                reasons.push('Cemented fixation required for constrained implant');
            } else if (bmi > 35 && deformity > 10) {
                // Obese + significant deformity
                fixation = 'Cemented';
                bearing = 'PS';
                stem = 'Tibial Stem';
                constraint = 'Standard PS';
                reasons.push(`BMI ${bmi.toFixed(1)} (>35) ‚Äî increased load requires cemented fixation with stem`);
                reasons.push(`Deformity ${deformity}¬∞ (>10¬∞) ‚Äî posterior stabilized needed for correction`);
                reasons.push('Tibial stem provides additional stability under high load + deformity correction');
            } else if (bmi > 35) {
                // Obese, no significant deformity
                fixation = 'Cemented';
                bearing = 'CR';
                stem = 'Tibial Stem';
                constraint = 'Standard';
                reasons.push(`BMI ${bmi.toFixed(1)} (>35) ‚Äî increased mechanical load requires cemented fixation`);
                reasons.push('Tibial stem provides additional fixation to handle higher body weight forces');
                if (pcl === 'intact') reasons.push('PCL intact ‚Äî cruciate retaining design appropriate');
                if (pcl === 'deficient') {
                    bearing = 'PS';
                    reasons.push('PCL deficient ‚Äî upgraded to posterior stabilized');
                }
            } else if (pcl === 'deficient') {
                // PCL deficient, normal BMI
                fixation = 'Cemented';
                bearing = 'PS';
                stem = 'None';
                constraint = 'Standard PS';
                reasons.push('PCL deficient ‚Äî posterior stabilized design required');
                reasons.push('Cemented fixation for PS implant stability');
                if (age >= 65) reasons.push(`Age ${age} ‚Äî cemented fixation appropriate`);
            } else if (age < 65 && bone === 'good' && bmi <= 35) {
                // Young, good bone, intact PCL, normal BMI ‚Äî press-fit
                fixation = 'Press-fit';
                bearing = 'CR';
                stem = 'None';
                constraint = 'Standard';
                reasons.push(`Age ${age} (<65) ‚Äî young patient with biological fixation potential`);
                reasons.push('Good bone quality supports uncemented press-fit fixation');
                reasons.push('PCL intact ‚Äî cruciate retaining design preserves natural kinematics');
                reasons.push(`BMI ${bmi.toFixed(1)} (‚â§35) ‚Äî within range for press-fit`);
            } else {
                // Age ‚â•65 or soft bone, normal BMI, intact PCL
                fixation = 'Cemented';
                bearing = 'CR';
                stem = 'None';
                constraint = 'Standard';
                if (age >= 65) reasons.push(`Age ${age} (‚â•65) ‚Äî cemented fixation for reliable osseointegration`);
                if (bone === 'soft') reasons.push('Soft bone quality ‚Äî cemented fixation for immediate stability');
                reasons.push('PCL intact ‚Äî cruciate retaining design appropriate');
                reasons.push(`BMI ${bmi.toFixed(1)} (‚â§35) ‚Äî standard implant sufficient`);
            }
            
            lastRecommendation = { fixation, bearing, stem, constraint, reasons, age, bmi, bone, pcl, coll, deformity };
            
            // Render result
            const bearingFull = bearing === 'CR' ? 'Cruciate Retaining' : 'Posterior Stabilized';
            const mainLabel = fixation === 'Press-fit' ? 'Press-Fit CR' : 
                             constraint === 'Max CCK Poly' ? 'Cemented PS + CCK' :
                             `${fixation} ${bearing}`;
            
            let html = `
                <div class="rec-main">${mainLabel}</div>
                <div class="rec-sub">${stem !== 'None' ? '+ ' + stem : 'Standard Components'}</div>
                
                <div class="rec-detail">
                    <div class="rec-item">
                        <div class="rec-item-value" style="color: ${fixation === 'Press-fit' ? '#22c55e' : '#60a5fa'};">${fixation}</div>
                        <div class="rec-item-label">FIXATION</div>
                    </div>
                    <div class="rec-item">
                        <div class="rec-item-value" style="color: ${bearing === 'PS' ? '#f59e0b' : '#22c55e'};">${bearingFull}</div>
                        <div class="rec-item-label">BEARING</div>
                    </div>
                    <div class="rec-item">
                        <div class="rec-item-value" style="color: ${stem !== 'None' ? '#f59e0b' : '#22c55e'};">${stem}</div>
                        <div class="rec-item-label">STEM</div>
                    </div>
                    <div class="rec-item">
                        <div class="rec-item-value" style="color: ${constraint.includes('CCK') ? '#ef4444' : '#22c55e'};">${constraint}</div>
                        <div class="rec-item-label">CONSTRAINT</div>
                    </div>
                </div>
                
                <div class="reason-box">
                    <strong>Clinical Rationale:</strong>
                    ${reasons.map(r => '<p>‚Ä¢ ' + r + '</p>').join('')}
                </div>
                
                <div class="print-bar">
                    <button class="btn" style="background: #3b82f6; color: white;" onclick="window.print()">üñ®Ô∏è Print</button>
                    <button class="btn" style="background: #059669; color: white;" onclick="switchPrepTab('equipment')">üì¶ View Equipment List</button>
                </div>
            `;
            
            document.getElementById('calcResult').innerHTML = html;
            generateEquipmentList();
        }

        // ============ EQUIPMENT LIST ============
        function generateEquipmentList() {
            if (!lastRecommendation) return;
            const r = lastRecommendation;
            
            let items = [];
            
            if (r.isHip) {
                // ===== HIP EQUIPMENT =====
                items.push({ cat: 'Implant System', item: 'Primary THA System Tray' });
                items.push({ cat: 'Implant System', item: `Acetabular Cup ‚Äî ${r.cupType}` });
                items.push({ cat: 'Implant System', item: `Acetabular Liner ‚Äî ${r.bearingSurface}` });
                items.push({ cat: 'Implant System', item: `Femoral Head ‚Äî ${r.headSize} (sized intraop)` });
                items.push({ cat: 'Implant System', item: `Femoral Stem ‚Äî ${r.stemType} (${r.fixation})` });
                
                if (r.fixation === 'Cemented') {
                    items.push({ cat: 'Cement', item: 'Bone Cement (PMMA) ‚Äî Antibiotic-loaded' });
                    items.push({ cat: 'Cement', item: 'Cement Mixing System' });
                    items.push({ cat: 'Cement', item: 'Cement Gun + Nozzles' });
                    items.push({ cat: 'Cement', item: 'Cement Restrictor' });
                    items.push({ cat: 'Cement', item: 'Femoral Canal Brush + Lavage' });
                }
                
                items.push({ cat: 'Instruments', item: 'Acetabular Reamers (sequential sizes)' });
                items.push({ cat: 'Instruments', item: 'Cup Impactor' });
                items.push({ cat: 'Instruments', item: 'Acetabular Screws (backup, 2-3)' });
                items.push({ cat: 'Instruments', item: 'Femoral Broaches (sequential sizes)' });
                items.push({ cat: 'Instruments', item: 'Femoral Offset / Neck Length Trials' });
                items.push({ cat: 'Instruments', item: 'Head-Neck Trial Set' });
                items.push({ cat: 'Instruments', item: 'Leg Length Measurement Device / Caliper' });
                
                items.push({ cat: 'Surgical Supplies', item: 'Pulse Lavage + Saline (3L)' });
                items.push({ cat: 'Surgical Supplies', item: 'Drain (if surgeon preference)' });
                items.push({ cat: 'Surgical Supplies', item: 'Wound Closure (staples + steri-strips)' });
                items.push({ cat: 'Surgical Supplies', item: 'Sterile Dressing + ABD Pad' });
                items.push({ cat: 'Surgical Supplies', item: 'Hip Abduction Pillow (post-op)' });
            } else {
                // ===== KNEE EQUIPMENT (existing) =====
            items.push({ cat: 'Implant System', item: 'Primary TKA System Tray' });
            items.push({ cat: 'Implant System', item: 'Femoral Component (sized intraop)' });
            items.push({ cat: 'Implant System', item: 'Tibial Baseplate (sized intraop)' });
            items.push({ cat: 'Implant System', item: `Poly Insert ‚Äî ${r.bearing === 'CR' ? 'CR' : 'PS'} ${r.constraint === 'Max CCK Poly' ? '(CCK Constrained)' : ''}` });
            
            if (r.fixation === 'Cemented') {
                items.push({ cat: 'Cement', item: 'Bone Cement (PMMA) ‚Äî Antibiotic-loaded' });
                items.push({ cat: 'Cement', item: 'Cement Mixing System' });
                items.push({ cat: 'Cement', item: 'Cement Gun + Nozzles' });
                items.push({ cat: 'Cement', item: 'Cement Restrictor (if applicable)' });
            }
            
            if (r.stem !== 'None') {
                items.push({ cat: 'Augments / Stems', item: 'Tibial Stem Extension Set' });
                items.push({ cat: 'Augments / Stems', item: 'Stem Cement Adapter' });
            }
            
            if (r.constraint === 'Max CCK Poly') {
                items.push({ cat: 'Constraint', item: 'CCK (Constrained Condylar Knee) Poly Insert' });
                items.push({ cat: 'Constraint', item: 'CCK Femoral Box Augment (if needed)' });
            }
            
            if (r.bearing === 'PS') {
                items.push({ cat: 'Instrumentation', item: 'PS Femoral Box Cut Guide' });
                items.push({ cat: 'Instrumentation', item: 'PS Trial Components' });
            }
            
            // Standard surgical supplies
            items.push({ cat: 'Instruments', item: 'Cutting Guides (Femoral + Tibial)' });
            items.push({ cat: 'Instruments', item: 'Oscillating Saw + Blades' });
            items.push({ cat: 'Instruments', item: 'Trial Components (full set)' });
            items.push({ cat: 'Instruments', item: 'Alignment Rod / Navigation (if used)' });
            
            items.push({ cat: 'Surgical Supplies', item: 'Tourniquet' });
            items.push({ cat: 'Surgical Supplies', item: 'Pulse Lavage + Saline (3L)' });
            items.push({ cat: 'Surgical Supplies', item: 'Drain (if surgeon preference)' });
            items.push({ cat: 'Surgical Supplies', item: 'Wound Closure (staples + steri-strips)' });
            items.push({ cat: 'Surgical Supplies', item: 'Sterile Dressing + ACE Wrap' });
            } // end knee/hip branch
            
            const el = document.getElementById('equipmentList');
            const grouped = {};
            items.forEach(i => {
                if (!grouped[i.cat]) grouped[i.cat] = [];
                grouped[i.cat].push(i.item);
            });
            
            const patientName = currentPatient ? `${currentPatient.first_name} ${currentPatient.last_name}` : 'Unknown';
            const surgeryType = currentPatient?.surgery_type || 'TKA';
            const bearingFull = r.bearing === 'CR' ? 'Cruciate Retaining' : 'Posterior Stabilized';
            
            el.innerHTML = `
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb;">
                    <strong style="font-size: 1.1rem;">${patientName}</strong> ‚Äî ${surgeryType}<br>
                    <span style="color: #6b7280; font-size: 0.85rem;">
                        ${r.fixation} | ${bearingFull} | ${r.stem !== 'None' ? r.stem : 'No Stem'} | ${r.constraint}
                    </span>
                </div>
                ${Object.entries(grouped).map(([cat, list]) => `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 700; font-size: 0.85rem; color: #2c5aa0; margin-bottom: 4px; text-transform: uppercase;">${cat}</div>
                        <ul class="equip-list" style="list-style:none;padding:0;margin:0;">
                            ${list.map(item => `<li style="padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:0.9rem;">‚òê ${item}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}
            `;
            
            document.getElementById('equipPrintBar').style.display = 'flex';
        }

        
        // ============ PRECERTIFICATION ============
        function generatePrecert() {
            const patientName = currentPatient ? `${currentPatient.first_name} ${currentPatient.last_name}` : '[Patient Name]';
            const dob = currentPatient?.date_of_birth || '[DOB]';
            const mrn = currentPatient?.mrn || '[MRN]';
            const surgeonName = currentPatient?.surgeon_first_name ? `Dr. ${currentPatient.surgeon_first_name} ${currentPatient.surgeon_last_name}` : '[Surgeon]';
            
            const proc = document.getElementById('histProcedure').value;
            const procName = proc && CPT_MAP[proc] ? CPT_MAP[proc].desc : (currentPatient?.surgery_type || 'Arthroplasty');
            const cptCode = proc && CPT_MAP[proc] ? CPT_MAP[proc].code : '[CPT]';
            const diagSelect = document.getElementById('histDiagnosis');
            const icdCode = diagSelect.value || '[ICD-10]';
            const icdDesc = diagSelect.value ? diagSelect.options[diagSelect.selectedIndex].textContent.split(' ‚Äî ')[1] : '[Diagnosis]';
            
            const age = document.getElementById('calcAge').value || '[Age]';
            const bmi = document.getElementById('calcBMI').value || '[BMI]';
            const joint = procName.includes('Hip') || procName.includes('hip') ? 'hip' : procName.includes('Shoulder') ? 'shoulder' : 'knee';
            
            // Conservative care
            const cons = [];
            if (document.getElementById('consPT').checked) {
                const weeks = document.getElementById('histPTWeeks')?.value;
                cons.push('Physical therapy' + (weeks ? ' (' + weeks + ' weeks)' : ' (‚â•6 weeks)'));
            }
            if (document.getElementById('consNSAIDs').checked) cons.push('NSAIDs / Anti-inflammatory medications');
            if (document.getElementById('consInjections').checked) cons.push('Corticosteroid / hyaluronic acid injections');
            if (document.getElementById('consBracing').checked) cons.push('Bracing / assistive device');
            if (document.getElementById('consActivity').checked) cons.push('Activity modification');
            if (document.getElementById('consWeight').checked) cons.push('Weight loss counseling');
            
            // X-ray ‚Äî build from Hist/PE data
            const xd = getXrayData();
            const alignText = { neutral:'neutral alignment', varus_mild:'mild varus deformity', varus_moderate:'moderate varus deformity', varus_severe:'severe varus deformity', valgus_mild:'mild valgus deformity', valgus_moderate:'moderate valgus deformity', valgus_severe:'severe valgus deformity' };
            
            let narrowParts = [];
            ['medial','lateral','pf'].forEach(c => {
                if (xd['narrow_' + c]) {
                    const name = c === 'pf' ? 'patellofemoral' : c;
                    let sev = xd['narrow_' + c + '_sev'] || '';
                    if (sev === 'severe') sev = 'severe (bone-on-bone)';
                    let mm = xd['narrow_' + c + '_mm'];
                    narrowParts.push(sev + ' joint space narrowing in the ' + name + ' compartment' + (mm ? ' with ' + mm + 'mm remaining clear space' : ''));
                }
            });
            let osteoParts = [];
            ['medial','lateral','pf'].forEach(c => {
                if (xd['osteo_' + c]) {
                    const name = c === 'pf' ? 'patellofemoral' : c;
                    osteoParts.push(xd['osteo_' + c + '_sev'] + ' osteophyte formation in the ' + name + ' compartment');
                }
            });
            let sclerosisParts = [];
            ['medial','lateral','pf'].forEach(c => {
                if (xd['sclerosis_' + c]) sclerosisParts.push(c === 'pf' ? 'patellofemoral' : c);
            });
            
            let xrayLine = 'Weight-bearing radiographs demonstrate ';
            const xrayItems = [];
            if (narrowParts.length) xrayItems.push(narrowParts.join(', '));
            if (osteoParts.length) xrayItems.push(osteoParts.join(', '));
            if (sclerosisParts.length) xrayItems.push('subchondral sclerosis in the ' + sclerosisParts.join(', ') + ' compartment(s)');
            if (xd.alignment) xrayItems.push(alignText[xd.alignment] || xd.alignment);
            xrayLine += xrayItems.length ? xrayItems.join(', ') + '.' : '[radiographic findings].';
            
            // PROM scores
            let promText = '';
            if (currentPreop?.joint_score_preop) {
                const scoreType = currentPreop.joint_score_type === 'koos_jr' ? 'KOOS Jr' : 'HOOS Jr';
                promText = `Pre-operative ${scoreType} score: ${Math.round(currentPreop.joint_score_preop)}/100 (projected post-operative: ${Math.round(currentPreop.projected_postop_score || 0)}/100, expected improvement: +${Math.round(currentPreop.expected_improvement || 0)} points).`;
            }
            
            let prosthesisText = '';
            if (lastRecommendation) {
                const r = lastRecommendation;
                const bearingFull = r.bearing === 'CR' ? 'cruciate retaining' : 'posterior stabilized';
                prosthesisText = `Planned implant: ${r.fixation.toLowerCase()} ${bearingFull}${r.stem !== 'None' ? ' with tibial stem extension' : ''}${r.constraint === 'Max CCK Poly' ? ' with constrained condylar knee (CCK) polyethylene' : ''}.`;
            }
            
            const output = `PRECERTIFICATION REQUEST ‚Äî ${procName.toUpperCase()}

CPT Code: ${cptCode} ‚Äî ${procName}
ICD-10 Diagnosis: ${icdCode} ‚Äî ${icdDesc}

Patient: ${patientName}
DOB: ${dob}
MRN: ${mrn}
Surgeon: ${surgeonName}
Date: ${new Date().toLocaleDateString()}

CLINICAL HISTORY:
${age}-year-old patient with BMI ${bmi} presenting with ${icdDesc || 'end-stage degenerative joint disease'} of the ${joint} refractory to conservative management.

CONSERVATIVE TREATMENTS COMPLETED:
${cons.length > 0 ? cons.map(c => '‚Ä¢ ' + c).join('\n') : '‚Ä¢ [No conservative treatments documented]'}

Patient has exhausted conservative treatment options over a period of at least 3 months without adequate relief of pain and functional limitation.

RADIOGRAPHIC FINDINGS:
${xrayLine}

FUNCTIONAL ASSESSMENT:
${promText || 'Functional outcome scores documented in pre-operative assessment.'}

Patient reports significant limitations in activities of daily living including walking, stair climbing, and sleep disturbance due to pain.

SURGICAL PLAN:
${procName} (CPT ${cptCode}) is medically necessary to restore function and alleviate pain that has not responded to conservative treatment.
${prosthesisText}

MEDICAL JUSTIFICATION:
This procedure meets medical necessity criteria based on:
1. Failed conservative management (‚â•3 months)
2. Radiographic evidence of advanced degenerative joint disease
3. Significant functional impairment documented by validated patient-reported outcome measures
4. Pain refractory to non-operative interventions

Requesting authorization for ${procName} (CPT ${cptCode}) with ICD-10 diagnosis ${icdCode}.

${surgeonName}
[Signature]`;
            
            document.getElementById('precertOutput').textContent = output;
            document.getElementById('precertPrintBar').style.display = 'flex';
        }

// ============ SURGICAL PREP DATA PERSISTENCE ============
        let surgPrepId = null;

        async function loadSurgPrepData(patientId) {
            try {
                const resp = await fetch(`/api/surgical-prep?patient_id=${patientId}`);
                const list = await resp.json();
                if (list.length > 0) {
                    const data = list[0];
                    surgPrepId = data.id;
                    if (data.contract_data) restoreContract(JSON.parse(data.contract_data), data.contract_signed_at);
                    if (data.consent_data) restoreConsent(JSON.parse(data.consent_data), data.consent_signed_at);
                    if (data.history_data) restoreHistory(JSON.parse(data.history_data));
                    if (data.insurance_data) restoreInsurance(JSON.parse(data.insurance_data));
                    if (data.disposition_data) restoreDisposition(JSON.parse(data.disposition_data));
                } else {
                    surgPrepId = null;
                }
            } catch(e) { console.error('Load surgical prep error:', e); }
        }

        async function saveSurgPrepField(field, value, signedField) {
            if (!currentPatient) { alert('Select a patient first.'); return; }
            const body = {
                patient_id: currentPatient.id,
                episode_id: currentPatient.episode_id || null,
                clinic_id: CLINIC_ID
            };
            // Load existing data first to avoid overwriting other fields
            if (surgPrepId) {
                try {
                    const resp = await fetch(`/api/surgical-prep?patient_id=${currentPatient.id}`);
                    const list = await resp.json();
                    if (list.length > 0) {
                        const existing = list[0];
                        body.contract_data = existing.contract_data;
                        body.consent_data = existing.consent_data;
                        body.history_data = existing.history_data;
                        body.insurance_data = existing.insurance_data;
                        body.disposition_data = existing.disposition_data;
                        body.prehab_data = existing.prehab_data;
                        body.contract_signed_at = existing.contract_signed_at;
                        body.consent_signed_at = existing.consent_signed_at;
                    }
                } catch(e) {}
            }
            body[field] = JSON.stringify(value);
            if (signedField) body[signedField] = new Date().toISOString();
            
            const method = surgPrepId ? 'PUT' : 'POST';
            const url = surgPrepId ? `/api/surgical-prep/${surgPrepId}` : '/api/surgical-prep';
            const resp = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
            const result = await resp.json();
            if (result.success) surgPrepId = result.id;
            return result;
        }

        // ============ CONTRACT (B2) ============
        function populateContract() {
            if (currentPatient) {
                document.getElementById('contractPatientName').textContent = `${currentPatient.first_name} ${currentPatient.last_name}`;
            }
            if (!document.getElementById('contractDate').value) {
                document.getElementById('contractDate').value = new Date().toISOString().split('T')[0];
            }
        }

        async function saveContract() {
            const sig = document.getElementById('contractSignature').value.trim();
            if (!sig) { alert('Patient must type their name to sign.'); return; }
            const data = {
                signature: sig,
                date: document.getElementById('contractDate').value,
                contact_method: document.getElementById('contractContactMethod').value,
                caregiver: document.getElementById('contractCaregiver').value,
                caregiver_phone: document.getElementById('contractCaregiverPhone').value,
                transport: document.getElementById('contractTransport').value
            };
            const result = await saveSurgPrepField('contract_data', data, 'contract_signed_at');
            if (result.success) {
                document.getElementById('contractSignedBadge').style.display = 'block';
                document.getElementById('contractSignedInfo').textContent = `by ${sig} on ${data.date}`;
            }
        }

        function restoreContract(data, signedAt) {
            if (data.signature) document.getElementById('contractSignature').value = data.signature;
            if (data.date) document.getElementById('contractDate').value = data.date;
            if (data.contact_method) document.getElementById('contractContactMethod').value = data.contact_method;
            if (data.caregiver) document.getElementById('contractCaregiver').value = data.caregiver;
            if (data.caregiver_phone) document.getElementById('contractCaregiverPhone').value = data.caregiver_phone;
            if (data.transport) document.getElementById('contractTransport').value = data.transport;
            if (signedAt) {
                document.getElementById('contractSignedBadge').style.display = 'block';
                document.getElementById('contractSignedInfo').textContent = `by ${data.signature} on ${data.date}`;
            }
        }

        function printContract() {
            const name = currentPatient ? `${currentPatient.first_name} ${currentPatient.last_name}` : '_______________';
            const procedure = currentPatient?.surgery_type || 'Total Joint Arthroplasty';
            const surgeon = currentPatient?.surgeon_last_name ? `Dr. ${currentPatient.surgeon_first_name} ${currentPatient.surgeon_last_name}` : '_______________';
            const sig = document.getElementById('contractSignature').value || '_______________';
            const dt = document.getElementById('contractDate').value || '_______________';
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Patient Agreement</title><style>body{font-family:Arial,sans-serif;padding:40px;line-height:1.8;} h2{text-align:center;} .sig{margin-top:40px;border-top:1px solid #000;width:300px;padding-top:4px;}</style></head><body>
<h2>Patient Agreement & Survey Commitment</h2>
<p><strong>Patient:</strong> ${name}<br><strong>Procedure:</strong> ${procedure}<br><strong>Surgeon:</strong> ${surgeon}</p>
<p>I, <strong>${name}</strong>, understand and agree to the following:</p>
<ol>
<li>I will complete all scheduled post-operative surveys at 6 weeks, 3 months, and 1 year after surgery.</li>
<li>I will complete daily check-ins through the SRO patient portal during my recovery period.</li>
<li>I will attend all scheduled follow-up appointments.</li>
<li>I will follow my prescribed physical therapy program.</li>
<li>I will notify my care team immediately if I experience warning signs.</li>
<li>My participation helps my surgeon monitor my recovery and improve outcomes.</li>
<li>Completing surveys may be required by my insurance program.</li>
</ol>
<br><div class="sig"><strong>${sig}</strong><br>Patient Signature &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date: ${dt}</div>
</body></html>`);
            w.document.close();
            w.print();
        }

        // ============ INFORMED CONSENT (B3) ============
        function populateConsent() {
            if (currentPatient) {
                document.getElementById('consentProcedure').textContent = `${currentPatient.surgery_type || 'Not specified'} ‚Äî ${currentPatient.first_name} ${currentPatient.last_name}`;
            }
            if (!document.getElementById('consentDate').value) {
                document.getElementById('consentDate').value = new Date().toISOString().split('T')[0];
            }
            // Populate risk stats from preop
            const statsDiv = document.getElementById('consentRiskStats');
            const risksDiv = document.getElementById('consentPatientRisks');
            if (currentPreop) {
                const readmit = currentPreop.readmission_risk || currentPreop.readmissionRisk || 2.5;
                const mortality = currentPreop.mortality_risk || currentPreop.mortalityRisk || 0.2;
                statsDiv.innerHTML = `
                    <p><strong>90-Day Readmission Risk:</strong> <span style="color:${readmit > 5 ? '#dc2626' : '#16a34a'};font-weight:700;">${readmit}%</span> (national avg: 2.5%)</p>
                    <p><strong>Surgical Mortality Risk:</strong> <span style="color:${mortality > 0.5 ? '#dc2626' : '#16a34a'};font-weight:700;">${mortality}%</span> (national avg: 0.2%)</p>
                    <p><strong>Pre-op Score:</strong> ${Math.round(currentPreop.joint_score_preop || currentPreop.jointScore || 0)} / 100</p>
                    <p><strong>Expected Post-op:</strong> ${Math.round(currentPreop.projected_postop_score || currentPreop.projectedPostop || 0)} / 100</p>
                    <p><strong>Expected Improvement:</strong> +${Math.round(currentPreop.expected_improvement || currentPreop.expectedImprovement || 0)} points</p>
                    <p style="color:#6b7280;font-size:0.8rem;margin-top:8px;">These statistics were shared with the patient during informed consent discussion.</p>
                `;
                // Patient-specific risks from comorbidities
                let comorbidities = [];
                if (currentPreop.comorbidities) {
                    try { comorbidities = typeof currentPreop.comorbidities === 'string' ? JSON.parse(currentPreop.comorbidities) : currentPreop.comorbidities; } catch(e) {}
                }
                const riskMap = {
                    'diabetes_controlled': 'Diabetes increases infection risk ‚Äî discussed wound care precautions',
                    'diabetes_uncontrolled': 'Uncontrolled diabetes significantly increases infection and wound healing risks',
                    'obesity_class_2': 'BMI >35 increases risk of infection, DVT, and mechanical complications',
                    'obesity_class_3': 'Morbid obesity significantly increases surgical and anesthesia risks',
                    'chf_preserved': 'Heart failure increases perioperative cardiac event risk',
                    'chf_reduced': 'Heart failure with reduced EF ‚Äî high perioperative cardiac risk',
                    'copd': 'COPD increases pulmonary complication and anesthesia risk',
                    'ckd_stage_3': 'Kidney disease may affect medication dosing and fluid management',
                    'ckd_stage_4': 'Advanced kidney disease ‚Äî elevated perioperative risk, nephrology clearance required',
                    'sleep_apnea': 'Sleep apnea increases anesthesia risk ‚Äî CPAP needed perioperatively',
                    'atrial_fibrillation': 'Afib requires anticoagulation management perioperatively',
                    'anticoagulation': 'Anticoagulant use requires bridging protocol discussion',
                    'depression': 'Depression may affect recovery expectations and pain perception',
                    'opioid_chronic': 'Chronic opioid use may complicate postoperative pain management',
                    'liver_disease': 'Liver disease increases bleeding risk and affects drug metabolism',
                    'smoking_current': 'Active smoking increases infection, non-union, and wound complication risk'
                };
                const patientRisks = comorbidities.filter(c => riskMap[c]).map(c => `<div style="padding:6px 0;border-bottom:1px solid #f3f4f6;">‚ö†Ô∏è ${riskMap[c]}</div>`);
                risksDiv.innerHTML = patientRisks.length > 0 ? patientRisks.join('') : '<span style="color:#16a34a;">No elevated comorbidity-specific risks identified.</span>';
            } else {
                statsDiv.innerHTML = '<p style="color:#6b7280;">Complete PreOp assessment first to populate risk statistics.</p>';
            }
        }

        function checkAllConsent() {
            document.querySelectorAll('#consentGeneralRisks input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        async function saveConsent() {
            const sig = document.getElementById('consentPatientSig').value.trim();
            if (!sig) { alert('Patient must sign consent.'); return; }
            const checks = [];
            document.querySelectorAll('#consentGeneralRisks input[type="checkbox"]').forEach(cb => { if (cb.checked) checks.push(cb.id); });
            const data = {
                risks_discussed: checks,
                additional: document.getElementById('consentAdditional').value,
                patient_signature: sig,
                witness: document.getElementById('consentWitness').value,
                date: document.getElementById('consentDate').value
            };
            const result = await saveSurgPrepField('consent_data', data, 'consent_signed_at');
            if (result.success) {
                document.getElementById('consentSignedBadge').style.display = 'block';
                document.getElementById('consentSignedInfo').textContent = `by ${sig} on ${data.date}`;
            }
        }

        function restoreConsent(data, signedAt) {
            if (data.risks_discussed) data.risks_discussed.forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
            if (data.additional) document.getElementById('consentAdditional').value = data.additional;
            if (data.patient_signature) document.getElementById('consentPatientSig').value = data.patient_signature;
            if (data.witness) document.getElementById('consentWitness').value = data.witness;
            if (data.date) document.getElementById('consentDate').value = data.date;
            if (signedAt) {
                document.getElementById('consentSignedBadge').style.display = 'block';
                document.getElementById('consentSignedInfo').textContent = `by ${data.patient_signature} on ${data.date}`;
            }
        }

        function printConsent() {
            const name = currentPatient ? `${currentPatient.first_name} ${currentPatient.last_name}` : '___';
            const proc = currentPatient?.surgery_type || 'Total Joint Arthroplasty';
            const surgeon = currentPatient?.surgeon_last_name ? `Dr. ${currentPatient.surgeon_first_name} ${currentPatient.surgeon_last_name}` : '___';
            const checks = [];
            document.querySelectorAll('#consentGeneralRisks input:checked').forEach(cb => checks.push(cb.parentElement.textContent.trim()));
            const additional = document.getElementById('consentAdditional').value;
            const sig = document.getElementById('consentPatientSig').value || '_______________';
            const witness = document.getElementById('consentWitness').value || '_______________';
            const dt = document.getElementById('consentDate').value || '_______________';
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Informed Consent</title><style>body{font-family:Arial,sans-serif;padding:40px;line-height:1.7;} h2{text-align:center;} .sig-row{display:flex;gap:40px;margin-top:40px;} .sig{border-top:1px solid #000;width:280px;padding-top:4px;font-size:0.9rem;}</style></head><body>
<h2>INFORMED CONSENT FOR SURGERY</h2>
<p><strong>Patient:</strong> ${name} &nbsp; <strong>Procedure:</strong> ${proc} &nbsp; <strong>Surgeon:</strong> ${surgeon}</p>
<p>The following risks of ${proc} have been discussed with the patient:</p>
<ul>${checks.map(c => '<li>' + c + '</li>').join('')}</ul>
${additional ? '<p><strong>Additional risks discussed:</strong> ' + additional + '</p>' : ''}
<p>Patient has been informed of the nature of the procedure, expected benefits, material risks, alternatives including non-operative management, and risks of not having surgery. Patient has had the opportunity to ask questions and all questions have been answered.</p>
<div class="sig-row"><div class="sig"><strong>${sig}</strong><br>Patient Signature<br>Date: ${dt}</div><div class="sig"><strong>${witness}</strong><br>Witness</div><div class="sig"><br>${surgeon}<br>Surgeon</div></div>
</body></html>`);
            w.document.close();
            w.print();
        }

        // ============ HISTORY (B6) ============
        let historyEntries = [];

        function addHistoryEntry(type) {
            const id = 'hist_' + Date.now();
            historyEntries.push({ id, type, procedure: '', date: '', surgeon: '', notes: '', facility: '' });
            renderHistoryEntries();
        }

        function removeHistoryEntry(id) {
            historyEntries = historyEntries.filter(e => e.id !== id);
            renderHistoryEntries();
        }

        function renderHistoryEntries() {
            const container = document.getElementById('historyEntries');
            if (historyEntries.length === 0) {
                container.innerHTML = '<div style="color:#6b7280;padding:12px;text-align:center;">No surgical history recorded.</div>';
                return;
            }
            container.innerHTML = historyEntries.map(e => `
                <div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:8px;background:#fafafa;">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                            <input type="text" placeholder="Procedure (e.g., R TKA, L ACL repair)" value="${e.procedure}" onchange="updateHistEntry('${e.id}','procedure',this.value)" style="padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;">
                            <input type="text" placeholder="Date / Year" value="${e.date}" onchange="updateHistEntry('${e.id}','date',this.value)" style="padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;">
                            <input type="text" placeholder="Surgeon" value="${e.surgeon}" onchange="updateHistEntry('${e.id}','surgeon',this.value)" style="padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;">
                            <input type="text" placeholder="Facility" value="${e.facility}" onchange="updateHistEntry('${e.id}','facility',this.value)" style="padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;">
                        </div>
                        <button onclick="removeHistoryEntry('${e.id}')" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:1.2rem;margin-left:8px;" title="Remove">‚úï</button>
                    </div>
                    <input type="text" placeholder="Notes / Outcome" value="${e.notes}" onchange="updateHistEntry('${e.id}','notes',this.value)" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;margin-top:6px;">
                </div>
            `).join('');
        }

        function updateHistEntry(id, field, value) {
            const entry = historyEntries.find(e => e.id === id);
            if (entry) entry[field] = value;
        }

        // ============ HISTORY / HIST-PE (updated) ============
        async function saveHistory() {
            const data = {
                procedure: document.getElementById('histProcedure').value,
                diagnosis: document.getElementById('histDiagnosis').value,
                surgeries: historyEntries,
                prior_injuries: document.getElementById('histPriorInjuries').value,
                treatments: {
                    pt: document.getElementById('histPT').checked,
                    pt_weeks: document.getElementById('histPTWeeks')?.value || '',
                    cortisone: document.getElementById('histInjCort').checked,
                    steroid_date: document.getElementById('histSteroidDate')?.value || '',
                    ha: document.getElementById('histInjHA').checked,
                    prp: document.getElementById('histInjPRP').checked,
                    arthroscopy: document.getElementById('histArthroscopy').checked,
                    bracing: document.getElementById('histBracing').checked,
                    nsaids: document.getElementById('histNSAIDs').checked,
                    nsaid_allergy: document.getElementById('histNSAIDAllergy')?.value || ''
                },
                xray: getXrayData(),
                allergies: document.getElementById('histAllergies').value,
                medications: document.getElementById('histMedications').value,
                surgeon_notes: document.getElementById('histSurgeonNotes').value
            };
            const result = await saveSurgPrepField('history_data', data);
            if (result.success) alert('Hist/PE saved!');
        }

        function restoreHistory(data) {
            if (data.procedure) { document.getElementById('histProcedure').value = data.procedure; onProcedureChange(); }
            if (data.diagnosis) document.getElementById('histDiagnosis').value = data.diagnosis;
            if (data.surgeries) { historyEntries = data.surgeries; renderHistoryEntries(); }
            if (data.prior_injuries) document.getElementById('histPriorInjuries').value = data.prior_injuries;
            if (data.treatments) {
                if (data.treatments.pt) { document.getElementById('histPT').checked = true; togglePTWeeks(); }
                if (data.treatments.pt_weeks) document.getElementById('histPTWeeks').value = data.treatments.pt_weeks;
                if (data.treatments.cortisone) { document.getElementById('histInjCort').checked = true; toggleSteroidCheck(); }
                if (data.treatments.steroid_date) { document.getElementById('histSteroidDate').value = data.treatments.steroid_date; checkSteroid3Months(); }
                if (data.treatments.ha) document.getElementById('histInjHA').checked = true;
                if (data.treatments.prp) document.getElementById('histInjPRP').checked = true;
                if (data.treatments.arthroscopy) document.getElementById('histArthroscopy').checked = true;
                if (data.treatments.bracing) document.getElementById('histBracing').checked = true;
                if (data.treatments.nsaids) { document.getElementById('histNSAIDs').checked = true; toggleNSAIDAllergy(); }
                if (data.treatments.nsaid_allergy) document.getElementById('histNSAIDAllergy').value = data.treatments.nsaid_allergy;
            }
            if (data.xray) restoreXrayData(data.xray);
            if (data.allergies) document.getElementById('histAllergies').value = data.allergies;
            if (data.medications) document.getElementById('histMedications').value = data.medications;
            if (data.surgeon_notes) document.getElementById('histSurgeonNotes').value = data.surgeon_notes;
        }

        // ============ INSURANCE (updated) ============
        async function saveInsurance() {
            const data = {
                plan_type: document.getElementById('insPlanType').value,
                secondary: document.getElementById('insSecondary').value,
                programs: {
                    team: document.getElementById('insTEAM').checked,
                    bpci: document.getElementById('insBPCI').checked,
                    cjr: document.getElementById('insCJR').checked,
                    comm_bundle: document.getElementById('insCommBundle').checked,
                    mssp: document.getElementById('insMSSP').checked
                },
                program_notes: document.getElementById('insProgramNotes').value,
                auth_status: document.getElementById('insAuthStatus').value,
                auth_num: document.getElementById('insAuthNum').value,
                auth_start: document.getElementById('insAuthStart').value,
                auth_end: document.getElementById('insAuthEnd').value
            };
            const result = await saveSurgPrepField('insurance_data', data);
            if (result.success) {
                alert('Insurance info saved!');
                updateAuthBadge();
                // Sync plan type to patients table
                try {
                    await fetch(`/api/patients/${currentPatient.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ insurance_type: data.plan_type })
                    });
                } catch(e) {}
            }
        }

        function restoreInsurance(data) {
            if (data.plan_type) {
                document.getElementById('insPlanType').value = data.plan_type;
            }
            // Legacy fields ‚Äî ignore carrier/policy_num/group_num/mbi
            if (data.secondary) document.getElementById('insSecondary').value = data.secondary;
            if (data.programs) {
                if (data.programs.team) document.getElementById('insTEAM').checked = true;
                if (data.programs.bpci) document.getElementById('insBPCI').checked = true;
                if (data.programs.cjr) document.getElementById('insCJR').checked = true;
                if (data.programs.comm_bundle) document.getElementById('insCommBundle').checked = true;
                if (data.programs.mssp) document.getElementById('insMSSP').checked = true;
            }
            if (data.program_notes) document.getElementById('insProgramNotes').value = data.program_notes;
            if (data.auth_status) document.getElementById('insAuthStatus').value = data.auth_status;
            if (data.auth_num) document.getElementById('insAuthNum').value = data.auth_num;
            if (data.auth_start) document.getElementById('insAuthStart').value = data.auth_start;
            if (data.auth_end) document.getElementById('insAuthEnd').value = data.auth_end;
            else if (data.auth_expiry) document.getElementById('insAuthEnd').value = data.auth_expiry; // legacy
            updateAuthBadge();
        }

        // ============ PRINT / COPY ============
        function printEquipment() {
            const el = document.getElementById('equipmentList');
            const win = window.open('', '_blank');
            win.document.write('<html><head><title>Equipment List</title><style>body{font-family:Arial,sans-serif;padding:20px;} ul{list-style:none;padding:0;} li{padding:6px 0;border-bottom:1px solid #eee;}</style></head><body>' + el.innerHTML + '</body></html>');
            win.document.close();
            win.print();
        }

        function printPrecert() {
            const text = document.getElementById('precertOutput').textContent;
            const win = window.open('', '_blank');
            win.document.write('<html><head><title>Precertification</title><style>body{font-family:Arial,sans-serif;padding:40px;white-space:pre-wrap;line-height:1.6;}</style></head><body>' + text + '</body></html>');
            win.document.close();
            win.print();
        }

        function copyPrecert() {
            const text = document.getElementById('precertOutput').textContent;
            navigator.clipboard.writeText(text).then(() => alert('Precertification summary copied to clipboard!'));
        }

        // ============ DISPOSITION ============
        function autoPopulateDisposition() {
            // Auto-fill from preop data if disposition fields are still empty
            if(!currentPreop) return;
            if(!document.getElementById('dispAge').value && currentPreop.age) {
                var age = parseInt(currentPreop.age);
                if(age < 65) document.getElementById('dispAge').value = '0';
                else if(age <= 74) document.getElementById('dispAge').value = '1';
                else if(age <= 80) document.getElementById('dispAge').value = '2';
                else document.getElementById('dispAge').value = '3';
            }
            if(!document.getElementById('dispBMI').value && currentPreop.bmi) {
                var bmi = parseFloat(currentPreop.bmi);
                if(bmi < 35) document.getElementById('dispBMI').value = '0';
                else if(bmi < 40) document.getElementById('dispBMI').value = '1';
                else if(bmi < 45) document.getElementById('dispBMI').value = '2';
                else document.getElementById('dispBMI').value = '3';
            }
            if(!document.getElementById('dispASA').value && currentPreop.asa_class) {
                var asa = parseInt(currentPreop.asa_class);
                if(asa <= 2) document.getElementById('dispASA').value = '0';
                else document.getElementById('dispASA').value = '1';
            }
            runDisposition();
        }
        function runDisposition() {
            var fields = ['dispAge','dispBMI','dispASA','dispTUG','dispHome','dispContra','dispCardPulm','dispFrailty'];
            var score = 0; var filled = 0;
            for(var i=0;i<fields.length;i++){
                var v = document.getElementById(fields[i]).value;
                if(v !== '') { score += parseInt(v); filled++; }
            }
            if(filled < 4) { document.getElementById('dispSettingResult').style.display='none'; return; }
            document.getElementById('dispSettingResult').style.display='block';
            var html = '';
            var setting, color, icon, details;
            if(score <= 4) {
                setting = 'ASC (Ambulatory Surgery Center)'; color = '#059669'; icon = 'üè•';
                details = 'Patient is a good candidate for same-day outpatient surgery at an ASC. Low-risk profile supports safe discharge on day of surgery with appropriate home support.';
            } else if(score <= 8) {
                setting = 'HOPD (Hospital Outpatient Department)'; color = '#d97706'; icon = 'üè®';
                details = 'Intermediate risk profile. Hospital outpatient setting recommended ‚Äî allows same-day discharge goal with inpatient backup if needed. Extended recovery area available.';
            } else {
                setting = 'Inpatient Admission'; color = '#dc2626'; icon = 'üõèÔ∏è';
                details = 'Higher risk profile warrants inpatient admission for close monitoring. Plan for 1-2 night stay with post-op nursing observation.';
            }
            html += '<div style="text-align:center;padding:16px;background:'+color+'15;border:2px solid '+color+';border-radius:12px;">';
            html += '<div style="font-size:2rem;">'+icon+'</div>';
            html += '<div style="font-size:1.4rem;font-weight:800;color:'+color+';margin:8px 0;">'+setting+'</div>';
            html += '<div style="font-size:0.9rem;color:#374151;max-width:600px;margin:0 auto;">'+details+'</div>';
            html += '<div style="margin-top:12px;font-size:0.85rem;color:#6b7280;">Risk Score: '+score+'/24 &nbsp;|&nbsp; 0-4 ASC &nbsp;|&nbsp; 5-8 HOPD &nbsp;|&nbsp; 9+ Inpatient</div>';
            html += '</div>';
            // Score breakdown
            var labels = ['Age','BMI','ASA','TUG','Home Support','Contralateral Leg','Cardiac/Pulmonary','Frailty'];
            html += '<table style="width:100%;border-collapse:collapse;margin-top:16px;font-size:0.85rem;">';
            for(var i=0;i<fields.length;i++){
                var v = document.getElementById(fields[i]).value;
                var pts = v !== '' ? parseInt(v) : '-';
                var ptColor = pts === '-' ? '#9ca3af' : pts === 0 ? '#059669' : pts === 1 ? '#d97706' : '#dc2626';
                var selText = v !== '' ? document.getElementById(fields[i]).options[document.getElementById(fields[i]).selectedIndex].text : 'Not assessed';
                html += '<tr><td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;">'+labels[i]+'</td>';
                html += '<td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;color:#6b7280;">'+selText+'</td>';
                html += '<td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;font-weight:700;color:'+ptColor+';text-align:center;width:40px;">'+pts+'</td></tr>';
            }
            html += '</table>';
            // TUG reference
            html += '<div style="margin-top:12px;padding:10px;background:#f8fafc;border-radius:8px;font-size:0.78rem;color:#6b7280;">';
            html += '<strong>TUG Reference:</strong> Patient stands from chair, walks 3m, turns, walks back, sits. &lt;10s normal | 10-14s mostly independent | 15-19s impaired | ‚â•20s high fall risk. Pre-THA: &lt;9.7s = 4√ó more likely to meet discharge criteria within 36 hrs (Oosting 2021).';
            html += '</div>';
            document.getElementById('dispSettingContent').innerHTML = html;
        }

        function updateDischargeDetail() {
            var dest = document.getElementById('dispDestination').value;
            var el = document.getElementById('dischargeDetail');
            if(!dest) { el.style.display='none'; return; }
            el.style.display='block';
            var info = {
                'home_outpt_pt': { label:'Home ‚Üí Outpatient PT', schedule:'Check-ins daily √ó 2 weeks, then every other day √ó 4 weeks. PT 2-3√ó/week at outpatient clinic.', alerts:'Pain ‚â•7, missed PT >2 sessions, missed check-in >2 days.', color:'#059669' },
                'home_home_pt': { label:'Home ‚Üí Home PT', schedule:'Check-ins daily √ó 3 weeks, then every other day √ó 3 weeks. Home PT 2-3√ó/week for 2-4 weeks, then transition to outpatient.', alerts:'Pain ‚â•7, PT no-show, missed check-in >2 days, ROM plateau.', color:'#2563eb' },
                'home_health': { label:'Home Health (Nursing + Therapy)', schedule:'Check-ins daily √ó 4 weeks. Home health nurse visits 2-3√ó/week. PT at home 2-3√ó/week.', alerts:'Pain ‚â•7, wound concerns, missed nurse visit, fever, missed check-in >1 day.', color:'#7c3aed' },
                'snf': { label:'SNF / Inpatient Rehab', schedule:'Facility-based monitoring. SRO check-ins begin at discharge from facility. Typical SNF stay: 5-14 days.', alerts:'Readmission, ER visit, delayed discharge from facility, PROM overdue.', color:'#dc2626' }
            };
            var d = info[dest];
            el.innerHTML = '<div style="border-left:3px solid '+d.color+';padding-left:12px;">' +
                '<div style="font-weight:700;color:'+d.color+';margin-bottom:6px;">'+d.label+'</div>' +
                '<div style="margin-bottom:4px;"><strong>Check-in Schedule:</strong> '+d.schedule+'</div>' +
                '<div><strong>Alert Triggers:</strong> '+d.alerts+'</div></div>';
        }

        async function saveDisposition() {
            if(!currentPatient) { alert('Select a patient first.'); return; }
            var data = {
                setting_score: 0, age: document.getElementById('dispAge').value,
                bmi: document.getElementById('dispBMI').value, asa: document.getElementById('dispASA').value,
                tug_category: document.getElementById('dispTUG').value, tug_seconds: document.getElementById('dispTUGsec').value,
                home_support: document.getElementById('dispHome').value, contralateral: document.getElementById('dispContra').value,
                cardiac_pulmonary: document.getElementById('dispCardPulm').value, frailty: document.getElementById('dispFrailty').value,
                destination: document.getElementById('dispDestination').value
            };
            var fields = ['age','bmi','asa','tug_category','home_support','contralateral','cardiac_pulmonary','frailty'];
            for(var i=0;i<fields.length;i++) if(data[fields[i]]) data.setting_score += parseInt(data[fields[i]]);
            await saveSurgPrepField('disposition_data', data);
        }

        function restoreDisposition(data) {
            if(!data) return;
            var fieldMap = {dispAge:'age', dispBMI:'bmi', dispASA:'asa', dispTUG:'tug_category', dispHome:'home_support', dispContra:'contralateral', dispCardPulm:'cardiac_pulmonary', dispFrailty:'frailty'};
            Object.keys(fieldMap).forEach(function(id){
                var key = fieldMap[id];
                if(data[key] !== undefined && data[key] !== '') document.getElementById(id).value = data[key];
            });
            if(data.tug_seconds) document.getElementById('dispTUGsec').value = data.tug_seconds;
            if(data.destination) document.getElementById('dispDestination').value = data.destination;
            runDisposition();
            updateDischargeDetail();
        }

        // ============ PREHAB & PATIENT PREP ============
        function generatePrehabPlan() {
            if(!currentPatient || !currentPreop) {
                alert('Load a patient with a PreOp assessment first.');
                return;
            }
            var preop = currentPreop;
            var comorbidities = {};
            try { comorbidities = JSON.parse(preop.comorbidity_data || '{}'); } catch(e){}
            var intakeData = {};
            try { intakeData = JSON.parse(preop.intake_data || '{}'); } catch(e){}
            var bmi = preop.bmi || 28;
            var age = preop.age || 65;
            var procedure = preop.procedure_type || 'TKA';
            var joint = procedure.indexOf('H') >= 0 ? 'hip' : 'knee';

            // === EXERCISE SECTION ===
            var tugVal = document.getElementById('dispTUGsec').value || document.getElementById('dispTUG').value;
            var tugSec = parseFloat(tugVal) || 15;
            var exHtml = '';
            exHtml += '<div style="margin-bottom:12px;padding:12px;background:#f0fdf4;border-radius:8px;border-left:3px solid #059669;">';
            exHtml += '<strong style="color:#059669;">Recommended Duration:</strong> ';
            exHtml += bmi >= 40 || tugSec >= 15 ? '6-8 weeks before surgery (extended prehab indicated)' : '4-6 weeks before surgery';
            exHtml += '</div>';
            var exercises = [];
            if(joint === 'knee') {
                exercises.push({name:'Quad Sets', desc:'Tighten thigh muscle, press knee flat into bed. Hold 5 sec. 3 sets √ó 10 reps.', priority:'Essential'});
                exercises.push({name:'Straight Leg Raises', desc:'Lying flat, tighten quad, lift leg 12 inches. Hold 3 sec. 3 sets √ó 10.', priority:'Essential'});
                exercises.push({name:'Heel Slides', desc:'Lying flat, slide heel toward buttock bending knee. Hold 5 sec. 3 sets √ó 10.', priority:'Essential'});
                exercises.push({name:'Standing Mini Squats', desc:'Hold chair back, bend knees 30-45¬∞. Hold 3 sec. 2 sets √ó 10.', priority:'Recommended'});
                exercises.push({name:'Step-Ups', desc:'4-6 inch step. Step up with surgical leg, step down. 2 sets √ó 10 each leg.', priority:'Recommended'});
            } else {
                exercises.push({name:'Glute Bridges', desc:'Lying flat, bend knees, lift hips. Hold 5 sec. 3 sets √ó 10.', priority:'Essential'});
                exercises.push({name:'Clamshells', desc:'Lie on side, knees bent. Open top knee keeping feet together. 3 sets √ó 15.', priority:'Essential'});
                exercises.push({name:'Standing Hip Abduction', desc:'Hold chair, lift surgical leg to side. Hold 3 sec. 3 sets √ó 10.', priority:'Essential'});
                exercises.push({name:'Seated Marching', desc:'Sit in chair, lift knee toward chest alternating. 2 sets √ó 20.', priority:'Recommended'});
                exercises.push({name:'Standing Hip Flexion', desc:'Hold chair, lift knee toward chest. Hold 3 sec. 2 sets √ó 10.', priority:'Recommended'});
            }
            exercises.push({name:'Walking Program', desc: tugSec >= 15 ? 'Start with 5-10 min walks, increase by 2 min/week. Use assistive device as needed.' : 'Walk 15-30 min daily at comfortable pace. Increase distance weekly.', priority:'Essential'});
            if(tugSec >= 15) exercises.push({name:'Balance Training', desc:'Stand on one leg holding chair. Hold 10-30 sec each side. 3√ó daily. Progress to no hands.', priority:'Recommended ‚Äî TUG ‚â• 15s'});

            exHtml += '<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
            exHtml += '<tr style="background:#f8fafc;"><th style="padding:8px;text-align:left;">Exercise</th><th style="padding:8px;text-align:left;">Instructions</th><th style="padding:8px;text-align:center;width:100px;">Priority</th></tr>';
            for(var i=0;i<exercises.length;i++){
                var pc = exercises[i].priority.indexOf('Essential') >= 0 ? '#059669' : '#d97706';
                exHtml += '<tr><td style="padding:8px;border-bottom:1px solid #f3f4f6;font-weight:600;">'+exercises[i].name+'</td>';
                exHtml += '<td style="padding:8px;border-bottom:1px solid #f3f4f6;">'+exercises[i].desc+'</td>';
                exHtml += '<td style="padding:8px;border-bottom:1px solid #f3f4f6;text-align:center;color:'+pc+';font-weight:600;font-size:0.8rem;">'+exercises[i].priority+'</td></tr>';
            }
            exHtml += '</table>';
            exHtml += '<div style="margin-top:10px;font-size:0.78rem;color:#6b7280;">Evidence: Prehab ‚â•8 weeks shows improved outcomes (Widmer 2015). Progressive resistance training improves sit-to-stand and walking speed at 3 and 12 months post-op (J√∏rgensen 2022).</div>';
            document.getElementById('prehabExerciseContent').innerHTML = exHtml;
            document.getElementById('prehabExerciseCard').style.display = 'block';

            // === SUPPLEMENTS ===
            var supps = [];
            supps.push({name:'Vitamin D3', dose:'2,000 IU daily (50,000 IU weekly loading if deficient)', reason:'Deficiency associated with poorer outcomes, increased LOS, and higher revision/infection risk after TJA.', test:'Check 25-OH Vitamin D level. Target ‚â• 30 ng/mL.', priority: true});
            supps.push({name:'Protein Supplementation', dose:'1.2 ‚Äì 1.5 g/kg/day total protein intake', reason:'Prevents sarcopenia, supports wound healing and muscle recovery. Essential amino acids attenuate post-op muscle atrophy.', test:'Consider albumin/prealbumin if malnourished.', priority: true});
            supps.push({name:'Calcium', dose:'1,200 mg daily (with Vitamin D)', reason:'Supports bone health and implant integration. Especially important for osteoporotic patients.', test:null, priority: age > 65 || (intakeData.gender && intakeData.gender.answer === 'Female')});
            if(comorbidities.anemia || bmi < 20) supps.push({name:'Iron Supplementation', dose:'325 mg ferrous sulfate daily (with vitamin C for absorption)', reason:'Correct anemia before surgery to reduce transfusion risk. Target Hgb ‚â• 12 g/dL (women), ‚â• 13 g/dL (men).', test:'Check CBC, iron studies, ferritin.', priority: true});
            if(bmi >= 35) supps.push({name:'Protein Shake / Meal Replacement', dose:'1-2 servings daily (20-30g protein per serving)', reason:'BMI ‚â• 35 ‚Äî optimize nutrition while maintaining caloric awareness. High protein supports tissue healing.', test:null, priority: true});

            var supHtml = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
            for(var i=0;i<supps.length;i++){
                if(!supps[i].priority) continue;
                supHtml += '<tr><td style="padding:8px;border-bottom:1px solid #f3f4f6;font-weight:700;width:160px;vertical-align:top;color:#1e3a5f;">'+supps[i].name+'</td>';
                supHtml += '<td style="padding:8px;border-bottom:1px solid #f3f4f6;"><strong>Dose:</strong> '+supps[i].dose+'<br><span style="color:#6b7280;">'+supps[i].reason+'</span>';
                if(supps[i].test) supHtml += '<br><span style="color:#d97706;font-weight:600;font-size:0.8rem;">Lab: '+supps[i].test+'</span>';
                supHtml += '</td></tr>';
            }
            supHtml += '</table>';
            supHtml += '<div style="margin-top:10px;font-size:0.78rem;color:#6b7280;">Sources: Vivek et al. JBJS Rev 2024 (Vitamin D meta-analysis); Pegreffi et al. 2024 (sarcopenia/nutrition review); AAHKS preoperative optimization guidelines.</div>';
            document.getElementById('prehabSupplementContent').innerHTML = supHtml;
            document.getElementById('prehabSupplementCard').style.display = 'block';

            // === COMORBIDITY-DRIVEN TESTS ===
            var tests = [];
            var checked = comorbidities.checked || {};
            // Always required
            tests.push({test:'CBC with Differential', reason:'Baseline hemoglobin, screen for anemia', category:'Standard'});
            tests.push({test:'BMP (Basic Metabolic Panel)', reason:'Electrolytes, renal function (Cr, BUN, glucose)', category:'Standard'});
            tests.push({test:'Urinalysis', reason:'Screen for UTI ‚Äî perioperative infection risk', category:'Standard'});
            tests.push({test:'25-OH Vitamin D Level', reason:'Deficiency prevalence 40-70% in arthroplasty patients', category:'Standard'});
            tests.push({test:'EKG', reason:'Baseline cardiac rhythm (age >50 or cardiac history)', category:'Standard'});
            if(age > 50 || (intakeData.gender && intakeData.gender.answer === 'Female' && age > 45)) tests.push({test:'DEXA Scan', reason:'Bone density assessment ‚Äî osteoporosis/periprosthetic fracture risk', category:'Consider'});
            // Comorbidity-driven
            if(checked.diabetes_uncontrolled || checked.diabetes_controlled) {
                tests.push({test:'HbA1c', reason:'Diabetes ‚Äî target <8.0% for surgical clearance', category:'Required'});
                tests.push({test:'Fasting Glucose', reason:'Perioperative glucose management', category:'Required'});
            }
            if(checked.chf_severe || checked.chf_reduced || checked.chf_preserved) {
                tests.push({test:'Echocardiogram', reason:'CHF ‚Äî assess EF, valvular function', category:'Required'});
                tests.push({test:'BNP / NT-proBNP', reason:'CHF severity marker', category:'Required'});
                tests.push({test:'Cardiology Clearance', reason:'CHF ‚Äî anesthesia and surgical risk assessment', category:'Consult'});
            }
            if(checked.cad) {
                tests.push({test:'Cardiology Clearance', reason:'CAD ‚Äî perioperative cardiac risk', category:'Consult'});
                if(checked.cad && !checked.chf_severe) tests.push({test:'Stress Test', reason:'CAD ‚Äî functional cardiac assessment if no recent test', category:'Consider'});
            }
            if(checked.atrial_fibrillation || checked.anticoagulation) {
                tests.push({test:'PT/INR', reason:'Anticoagulation ‚Äî bridging protocol assessment', category:'Required'});
                tests.push({test:'Hematology Consult', reason:'Anticoagulation management plan', category:'Consult'});
            }
            if(checked.ckd_stage_3) {
                tests.push({test:'CMP (Comprehensive Metabolic Panel)', reason:'Renal function ‚Äî GFR, electrolytes', category:'Required'});
                tests.push({test:'Nephrology Clearance', reason:'CKD ‚Äî contrast/medication dose adjustment', category:'Consult'});
            }
            if(checked.anemia) {
                tests.push({test:'Iron Studies (Fe, TIBC, Ferritin)', reason:'Anemia workup ‚Äî optimize before surgery', category:'Required'});
                tests.push({test:'Reticulocyte Count', reason:'Anemia characterization', category:'Consider'});
            }
            if(checked.sleep_apnea) tests.push({test:'Sleep Medicine Clearance', reason:'OSA ‚Äî CPAP compliance, anesthesia planning', category:'Consult'});
            if(checked.obesity_class_3) tests.push({test:'Pulmonary Function Tests', reason:'Morbid obesity ‚Äî respiratory reserve assessment', category:'Consider'});
            if(checked.smoking_current) tests.push({test:'Chest X-Ray', reason:'Active smoker ‚Äî baseline pulmonary assessment', category:'Consider'});
            if(checked.rheumatoid_arthritis) {
                tests.push({test:'Rheumatology Clearance', reason:'RA ‚Äî medication hold schedule (MTX, biologics)', category:'Consult'});
                tests.push({test:'CRP / ESR', reason:'Inflammatory markers ‚Äî infection vs disease activity', category:'Required'});
            }
            if(checked.dental_problems) tests.push({test:'Dental Clearance', reason:'Dental infection risk ‚Äî prosthetic joint infection prevention', category:'Consult'});
            if(checked.depression || checked.opioid_chronic) tests.push({test:'Pain Management / Psych Consult', reason:'Optimize mental health and pain management pre-op', category:'Consider'});

            var testHtml = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
            testHtml += '<tr style="background:#f8fafc;"><th style="padding:8px;text-align:left;">Test / Consult</th><th style="padding:8px;text-align:left;">Reason</th><th style="padding:8px;text-align:center;width:80px;">Priority</th></tr>';
            var catColors = {Standard:'#6b7280', Required:'#dc2626', Consult:'#7c3aed', Consider:'#d97706'};
            // Deduplicate
            var seen = {};
            for(var i=0;i<tests.length;i++){
                if(seen[tests[i].test]) continue;
                seen[tests[i].test] = true;
                var cc = catColors[tests[i].category] || '#6b7280';
                testHtml += '<tr><td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;font-weight:600;">'+tests[i].test+'</td>';
                testHtml += '<td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;color:#6b7280;">'+tests[i].reason+'</td>';
                testHtml += '<td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;text-align:center;font-weight:700;color:'+cc+';font-size:0.78rem;">'+tests[i].category+'</td></tr>';
            }
            testHtml += '</table>';
            document.getElementById('prehabTestsContent').innerHTML = testHtml;
            document.getElementById('prehabTestsCard').style.display = 'block';

            // === MEDICATION MANAGEMENT ===
            var meds = [];
            meds.push({med:'NSAIDs (Ibuprofen, Naproxen, Meloxicam)', action:'STOP 7 days before surgery', reason:'Increased bleeding risk', priority:'All Patients'});
            meds.push({med:'Aspirin 81mg', action:'Continue unless surgeon instructs otherwise', reason:'Low-dose aspirin generally safe perioperatively', priority:'If Applicable'});
            if(checked.anticoagulation || checked.atrial_fibrillation) {
                meds.push({med:'Warfarin (Coumadin)', action:'STOP 5 days before surgery. Bridge with Lovenox if high-risk (discuss with hematology).', reason:'Target INR < 1.5 on day of surgery', priority:'Required'});
                meds.push({med:'Eliquis / Xarelto / Pradaxa (DOACs)', action:'STOP 48-72 hours before surgery (drug-specific)', reason:'Renal-cleared ‚Äî adjust hold time based on GFR', priority:'Required'});
            }
            if(checked.diabetes_controlled || checked.diabetes_uncontrolled) {
                meds.push({med:'Metformin', action:'HOLD day of surgery and 48 hrs after', reason:'Lactic acidosis risk with anesthesia/contrast', priority:'Required'});
                meds.push({med:'Insulin', action:'Take half dose morning of surgery. Bring insulin to hospital.', reason:'Perioperative glucose management', priority:'Required'});
            }
            if(checked.rheumatoid_arthritis) {
                meds.push({med:'Methotrexate', action:'HOLD 1 week before surgery, resume 2 weeks after wound healed', reason:'Immunosuppression ‚Äî infection risk', priority:'Required'});
                meds.push({med:'Biologics (Humira, Enbrel, etc.)', action:'HOLD 1-2 dosing cycles before surgery per rheumatology', reason:'Immunosuppression ‚Äî wound healing', priority:'Required'});
            }
            var glp1 = intakeData.diet_glp1;
            if(glp1 && glp1.answer === 'Yes') {
                meds.push({med:'GLP-1 Agonist (Ozempic, Wegovy, Mounjaro)', action:'HOLD 1 week before surgery (ASA recommendation)', reason:'Delayed gastric emptying ‚Äî aspiration risk under anesthesia', priority:'Required'});
            }
            meds.push({med:'Herbal Supplements (Fish Oil, Ginkgo, Garlic, Ginseng)', action:'STOP 2 weeks before surgery', reason:'Increased bleeding risk', priority:'All Patients'});

            var medHtml = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
            medHtml += '<tr style="background:#fef2f2;"><th style="padding:8px;text-align:left;">Medication</th><th style="padding:8px;text-align:left;">Action</th><th style="padding:8px;text-align:left;">Reason</th></tr>';
            for(var i=0;i<meds.length;i++){
                var ac = meds[i].action.indexOf('STOP') >= 0 || meds[i].action.indexOf('HOLD') >= 0 ? '#dc2626' : '#059669';
                medHtml += '<tr><td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;font-weight:600;">'+meds[i].med+'</td>';
                medHtml += '<td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;font-weight:700;color:'+ac+';">'+meds[i].action+'</td>';
                medHtml += '<td style="padding:6px 8px;border-bottom:1px solid #f3f4f6;color:#6b7280;">'+meds[i].reason+'</td></tr>';
            }
            medHtml += '</table>';
            document.getElementById('prehabMedsContent').innerHTML = medHtml;
            document.getElementById('prehabMedsCard').style.display = 'block';
            document.getElementById('prehabPrintCard').style.display = 'block';
        }

        function printPrehab() {
            var cards = ['prehabExerciseCard','prehabSupplementCard','prehabTestsCard','prehabMedsCard'];
            var html = '<html><head><title>Patient Preparation Packet</title><style>body{font-family:Arial,sans-serif;padding:30px;font-size:12px;line-height:1.5;} h3{color:#1e3a5f;border-bottom:2px solid #2c5aa0;padding-bottom:4px;margin-top:24px;} table{width:100%;border-collapse:collapse;margin-bottom:16px;} td,th{padding:5px 6px;border-bottom:1px solid #ddd;text-align:left;} .page-break{page-break-before:always;}</style></head><body>';
            html += '<h2 style="text-align:center;color:#1e3a5f;">Pre-Operative Preparation Packet</h2>';
            html += '<p style="text-align:center;color:#6b7280;">Patient: ' + (currentPatient ? currentPatient.first_name + ' ' + currentPatient.last_name : 'N/A') + ' &nbsp;|&nbsp; Date: ' + new Date().toLocaleDateString() + '</p>';
            for(var i=0;i<cards.length;i++){
                var el = document.getElementById(cards[i]);
                if(el && el.style.display !== 'none') html += el.innerHTML;
            }
            html += '</body></html>';
            var win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.print();
        }

        async function savePrehab() {
            if(!currentPatient) { alert('Select a patient first.'); return; }
            var data = { generated: true, timestamp: new Date().toISOString() };
            await saveSurgPrepField('prehab_data', data);
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '/index.html';
        }

        // ============ X-RAY MODAL ============
        function openXrayModal() {
            if (!currentPatient) { alert('Select a patient first.'); return; }
            // Toggle knee vs hip based on procedure
            const proc = document.getElementById('histProcedure').value;
            const isHip = ['THA','Partial_Hip','Hip_Fracture'].includes(proc);
            document.getElementById('xrayKneeSection').style.display = isHip ? 'none' : 'block';
            document.getElementById('xrayHipSection').style.display = isHip ? 'block' : 'none';
            document.getElementById('xrayModal').style.display = 'block';
        }

        function closeXrayModal() {
            document.getElementById('xrayModal').style.display = 'none';
        }

        function xrayModalChanged() {
            // Show/hide severity selects when compartment checked
            ['NarrowMedial','NarrowLateral','NarrowPF','OsteoMedial','OsteoLateral','OsteoPF'].forEach(id => {
                const cb = document.getElementById('xm' + id);
                const det = document.getElementById('xm' + id + 'D');
                if (cb && det) det.style.display = cb.checked ? 'flex' : 'none';
            });
        }

        function saveXrayFromModal() {
            // Auto-populate deformity from alignment
            const alignRadio = document.querySelector('input[name="xrayAlign"]:checked');
            const align = alignRadio ? alignRadio.value : '';
            const deformityInput = document.getElementById('calcDeformity');
            const deformitySource = document.getElementById('deformitySource');
            const deformityMap = { varus_mild: 5, varus_moderate: 15, varus_severe: 25, valgus_mild: 5, valgus_moderate: 15, valgus_severe: 25 };
            if (deformityMap[align] !== undefined) {
                deformityInput.value = deformityMap[align];
                deformitySource.textContent = '(from X-Ray ‚Äî ' + align.replace('_', ' ') + ')';
                runCalculator();
            } else if (align === 'neutral') {
                deformityInput.value = 0;
                deformitySource.textContent = '(from X-Ray ‚Äî neutral)';
                runCalculator();
            }
            // Update summary preview
            updateXraySummaryPreview();
            // Update precert x-ray summary
            updatePrecertXraySummary();
            // Auto-save via history save
            saveHistory();
            closeXrayModal();
        }

        function updateXraySummaryPreview() {
            const data = getXrayData();
            const preview = document.getElementById('xraySummaryPreview');
            let parts = [];
            if (data.alignment) parts.push('Alignment: ' + data.alignment.replace(/_/g, ' '));
            // Knee findings
            ['medial','lateral','pf'].forEach(c => {
                if (data['narrow_' + c]) parts.push('Narrowing: ' + c + ' (' + (data['narrow_' + c + '_sev'] || 'mild') + ')');
                if (data['osteo_' + c]) parts.push('Osteophytes: ' + c + ' (' + (data['osteo_' + c + '_sev'] || 'mild') + ')');
                if (data['sclerosis_' + c]) parts.push('Sclerosis: ' + c);
            });
            // Hip findings
            if (data.hip_narrowing) parts.push('Hip narrowing: ' + data.hip_narrowing.replace(/_/g, ' '));
            if (data.hip_femoral_head) parts.push('Femoral head: ' + data.hip_femoral_head);
            ['acet_sclerosis','acet_cysts','acet_osteo','protrusio','dysplasia','fem_osteo','fem_sclerosis','ho','lld','cam','pincer'].forEach(k => {
                if (data['hip_' + k]) parts.push(k.replace(/_/g, ' '));
            });
            if (data.kl_grade) parts.push('KL Grade: ' + data.kl_grade);
            if (data.additional) parts.push('Notes: ' + data.additional.substring(0, 60));
            preview.innerHTML = parts.length > 0 ? '<strong style="color:#1e3a5f;">‚úÖ X-Ray documented:</strong> ' + parts.join(' ¬∑ ') : 'No x-ray data entered yet. Click "Open X-Ray Assessment" above.';
            preview.style.color = parts.length > 0 ? '#1e293b' : '#6b7280';
        }

        // Updated getXrayData to read from modal elements
        function getXrayData() {
            const alignRadio = document.querySelector('input[name="xrayAlign"]:checked');
            const data = {
                alignment: alignRadio ? alignRadio.value : ''
            };
            // Knee compartments
            ['Medial','Lateral','PF'].forEach(c => {
                const lc = c.toLowerCase();
                data['narrow_' + (lc === 'pf' ? 'pf' : lc)] = document.getElementById('xmNarrow' + c)?.checked || false;
                if (data['narrow_' + (lc === 'pf' ? 'pf' : lc)]) {
                    data['narrow_' + (lc === 'pf' ? 'pf' : lc) + '_sev'] = document.getElementById('xmNarrow' + c + 'Sev')?.value || '';
                    data['narrow_' + (lc === 'pf' ? 'pf' : lc) + '_mm'] = document.getElementById('xmNarrow' + c + 'MM')?.value || '';
                }
                data['osteo_' + (lc === 'pf' ? 'pf' : lc)] = document.getElementById('xmOsteo' + c)?.checked || false;
                if (data['osteo_' + (lc === 'pf' ? 'pf' : lc)]) {
                    data['osteo_' + (lc === 'pf' ? 'pf' : lc) + '_sev'] = document.getElementById('xmOsteo' + c + 'Sev')?.value || '';
                }
                data['sclerosis_' + (lc === 'pf' ? 'pf' : lc)] = document.getElementById('xmSclerosis' + c)?.checked || false;
            });
            // Hip findings
            const hipNarrow = document.querySelector('input[name="hipNarrow"]:checked');
            data.hip_narrowing = hipNarrow ? hipNarrow.value : '';
            const hipFem = document.querySelector('input[name="hipFemHead"]:checked');
            data.hip_femoral_head = hipFem ? hipFem.value : '';
            data.hip_acet_sclerosis = document.getElementById('hipAcetSclerosis')?.checked || false;
            data.hip_acet_cysts = document.getElementById('hipAcetCysts')?.checked || false;
            data.hip_acet_osteo = document.getElementById('hipAcetOsteo')?.checked || false;
            data.hip_protrusio = document.getElementById('hipProtrusio')?.checked || false;
            data.hip_dysplasia = document.getElementById('hipDysplasia')?.checked || false;
            data.hip_fem_osteo = document.getElementById('hipFemOsteo')?.checked || false;
            data.hip_fem_sclerosis = document.getElementById('hipFemSclerosis')?.checked || false;
            data.hip_ho = document.getElementById('hipHO')?.checked || false;
            data.hip_lld = document.getElementById('hipLLD')?.checked || false;
            data.hip_cam = document.getElementById('hipCAM')?.checked || false;
            data.hip_pincer = document.getElementById('hipPincer')?.checked || false;
            data.hip_lld_mm = document.getElementById('hipLLDmm')?.value || '';
            // Shared
            const kl = document.querySelector('input[name="klGrade"]:checked');
            data.kl_grade = kl ? kl.value : '';
            data.additional = document.getElementById('xmAdditionalFindings')?.value || '';
            return data;
        }

        function restoreXrayData(d) {
            if (!d) return;
            // Alignment
            if (d.alignment) {
                const r = document.querySelector('input[name="xrayAlign"][value="' + d.alignment + '"]');
                if (r) r.checked = true;
            }
            // Knee compartments
            ['Medial','Lateral','PF'].forEach(c => {
                const lc = c.toLowerCase();
                const key = lc === 'pf' ? 'pf' : lc;
                if (d['narrow_' + key]) { const cb = document.getElementById('xmNarrow' + c); if (cb) cb.checked = true; }
                if (d['narrow_' + key + '_sev']) { const el = document.getElementById('xmNarrow' + c + 'Sev'); if (el) el.value = d['narrow_' + key + '_sev']; }
                if (d['narrow_' + key + '_mm']) { const el = document.getElementById('xmNarrow' + c + 'MM'); if (el) el.value = d['narrow_' + key + '_mm']; }
                if (d['osteo_' + key]) { const cb = document.getElementById('xmOsteo' + c); if (cb) cb.checked = true; }
                if (d['osteo_' + key + '_sev']) { const el = document.getElementById('xmOsteo' + c + 'Sev'); if (el) el.value = d['osteo_' + key + '_sev']; }
                if (d['sclerosis_' + key]) { const cb = document.getElementById('xmSclerosis' + c); if (cb) cb.checked = true; }
            });
            // Hip findings
            if (d.hip_narrowing) { const r = document.querySelector('input[name="hipNarrow"][value="' + d.hip_narrowing + '"]'); if (r) r.checked = true; }
            if (d.hip_femoral_head) { const r = document.querySelector('input[name="hipFemHead"][value="' + d.hip_femoral_head + '"]'); if (r) r.checked = true; }
            ['acet_sclerosis','acet_cysts','acet_osteo','protrusio','dysplasia','fem_osteo','fem_sclerosis','ho','lld','cam','pincer'].forEach(k => {
                const elId = 'hip' + k.split('_').map((s,i) => i===0 ? s.charAt(0).toUpperCase()+s.slice(1) : s.charAt(0).toUpperCase()+s.slice(1)).join('');
                // Map to actual IDs
                const idMap = { acet_sclerosis:'hipAcetSclerosis', acet_cysts:'hipAcetCysts', acet_osteo:'hipAcetOsteo', protrusio:'hipProtrusio', dysplasia:'hipDysplasia', fem_osteo:'hipFemOsteo', fem_sclerosis:'hipFemSclerosis', ho:'hipHO', lld:'hipLLD', cam:'hipCAM', pincer:'hipPincer' };
                if (d['hip_' + k]) { const cb = document.getElementById(idMap[k]); if (cb) cb.checked = true; }
            });
            if (d.hip_lld_mm) { const el = document.getElementById('hipLLDmm'); if (el) el.value = d.hip_lld_mm; }
            // KL Grade
            if (d.kl_grade) { const r = document.querySelector('input[name="klGrade"][value="' + d.kl_grade + '"]'); if (r) r.checked = true; }
            if (d.additional) { const el = document.getElementById('xmAdditionalFindings'); if (el) el.value = d.additional; }
            xrayModalChanged();
            updateXraySummaryPreview();
        }

        // ============ PRINT EDUCATION ============
        function printEducation() {
            const proc = currentPatient?.surgery_type || document.getElementById('histProcedure').value || 'Joint Replacement';
            const isHip = proc.toLowerCase().includes('hip');
            const name = currentPatient ? currentPatient.first_name + ' ' + currentPatient.last_name : 'Patient';
            const surgDate = currentPatient?.surgery_date ? new Date(currentPatient.surgery_date).toLocaleDateString() : 'TBD';
            const classLink = document.getElementById('eduClassLink')?.value || '';
            
            let html = `<!DOCTYPE html><html><head><title>Pre-Op Education ‚Äî ${name}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 24px; font-size: 11px; color: #1e293b; line-height: 1.5; }
                h1 { font-size: 16px; color: #1e3a5f; margin: 0 0 4px; }
                h2 { font-size: 12px; color: #1e3a5f; border-bottom: 2px solid #2c5aa0; padding-bottom: 3px; margin: 14px 0 6px; }
                .alert-box { background: #fef2f2; border: 2px solid #fca5a5; padding: 10px; border-radius: 6px; margin: 8px 0; }
                .alert-title { font-weight: 700; color: #991b1b; margin-bottom: 4px; }
                .green-box { background: #f0fdf4; border: 1px solid #86efac; padding: 10px; border-radius: 6px; margin: 8px 0; }
                .med-stop { background: #fef2f2; padding: 4px 8px; border-radius: 4px; margin: 2px 0; }
                .med-keep { background: #f0fdf4; padding: 4px 8px; border-radius: 4px; margin: 2px 0; }
                .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
                .footer { margin-top: 16px; padding-top: 6px; border-top: 1px solid #e5e7eb; font-size: 9px; color: #9ca3af; text-align: center; }
                @media print { body { padding: 12px; } }
            </style></head><body>`;
            
            html += `<h1>Pre-Operative Patient Education</h1>`;
            html += `<div style="font-size:10px;color:#6b7280;margin-bottom:12px;">${name} ¬∑ ${proc} ¬∑ Surgery: ${surgDate} ¬∑ SRO Intelligence</div>`;
            
            // Skin care
            html += `<h2>‚ö†Ô∏è SKIN CARE ‚Äî YOUR SURGERY WILL BE CANCELLED IF:</h2>`;
            html += `<div class="alert-box"><div class="alert-title">Do NOT come to surgery with ANY of these:</div>`;
            html += `‚ùå Open wounds, cuts, or scratches on the operative leg/hip<br>`;
            html += `‚ùå Pimples, boils, rashes, or skin irritation on the operative limb<br>`;
            html += `‚ùå Any skin infection on the operative leg/hip<br>`;
            html += `‚ùå Any severe infection anywhere on the body (UTI, dental, cellulitis)<br>`;
            html += `‚ùå Infected insect bites on the operative area</div>`;
            html += `<div class="green-box">`;
            html += `‚úÖ Keep operative leg clean and moisturized (unscented lotion)<br>`;
            html += `‚úÖ Do NOT shave the operative leg for 2 weeks before surgery<br>`;
            html += `‚úÖ Shower with Hibiclens (Chlorhexidine) night before AND morning of surgery<br>`;
            html += `‚úÖ Use fresh bed linens the night before ¬∑ Wear clean, loose clothes<br>`;
            html += `‚úÖ Remove nail polish, jewelry, piercings ¬∑ Report ANY new skin issues immediately</div>`;

            // Nutrition
            html += `<h2>ü•ó Nutrition</h2>`;
            html += `<div class="two-col"><div><strong>Before Surgery:</strong><br>High protein diet (1.2-1.5 g/kg/day) ¬∑ Protein shakes 1-2x daily ¬∑ Fruits/veggies for Vitamin C ¬∑ 8+ glasses water ¬∑ Limit processed food/sugar/alcohol</div>`;
            html += `<div><strong>After Surgery:</strong><br>Continue high protein ¬∑ Shakes if low appetite ¬∑ High-fiber foods (prevent constipation) ¬∑ Extra hydration ¬∑ Iron-rich foods if anemic</div></div>`;

            // Supplements
            html += `<h2>üíä Supplements</h2>`;
            html += `Vitamin D3: 2,000 IU daily ¬∑ Protein: 20-30g supplement 1-2x daily ¬∑ Calcium: 1,200 mg (if age >65 or female) ¬∑ Iron: only if anemic (with Vitamin C)`;

            // Exercise
            html += `<h2>üö∂ Walking & Exercise</h2>`;
            html += `<strong>Walking:</strong> Start 10-15 min daily ‚Üí Goal 30 min by surgery. Steps: 5,000-7,000/day.<br>`;
            html += `<strong>Exercises (2-3x daily):</strong> `;
            if (isHip) {
                html += `Glute bridges (10 reps) ¬∑ Clamshells (10 each side) ¬∑ Hip abduction (10 reps) ¬∑ Ankle pumps (20 reps) ¬∑ Seated marching (10 each)`;
            } else {
                html += `Quad sets (10 reps, hold 5 sec) ¬∑ Straight leg raises (10 each) ¬∑ Heel slides (10 reps) ¬∑ Ankle pumps (20 reps) ¬∑ Mini squats (10 reps)`;
            }

            // Medications
            html += `<h2>üíâ Medications</h2>`;
            html += `<div class="two-col"><div><strong style="color:#dc2626;">üõë STOP:</strong><br>`;
            html += `<div class="med-stop">NSAIDs ‚Äî 7 days before</div>`;
            html += `<div class="med-stop">Warfarin ‚Äî 5 days before</div>`;
            html += `<div class="med-stop">Eliquis/Xarelto ‚Äî 48-72 hrs before</div>`;
            html += `<div class="med-stop">Methotrexate ‚Äî 1 week before</div>`;
            html += `<div class="med-stop">Biologics ‚Äî 1-2 dosing cycles</div>`;
            html += `<div class="med-stop">GLP-1 (Ozempic/Wegovy) ‚Äî 1 week</div>`;
            html += `<div class="med-stop">Herbals/fish oil ‚Äî 2 weeks</div>`;
            html += `</div><div><strong style="color:#059669;">‚úÖ CONTINUE:</strong><br>`;
            html += `<div class="med-keep">BP meds ‚Äî take morning of with sip of water</div>`;
            html += `<div class="med-keep">Heart meds ‚Äî take as usual</div>`;
            html += `<div class="med-keep">Aspirin 81mg ‚Äî continue unless told to stop</div>`;
            html += `<div class="med-keep">Metformin ‚Äî HOLD day of + 48 hrs</div>`;
            html += `<div class="med-keep">Insulin ‚Äî HALF dose morning of; bring to hospital</div>`;
            html += `<div class="med-keep">Anxiety/depression/thyroid meds ‚Äî take as usual</div>`;
            html += `</div></div>`;
            html += `<div style="background:#fef3c7;padding:8px;border-radius:4px;margin-top:6px;"><strong>‚ö†Ô∏è Bring ALL medication bottles to the hospital.</strong> If unsure about any medication, call our office.</div>`;

            // Home prep + class
            html += `<h2>üè† Home Preparation</h2>`;
            html += `‚òê Raised toilet seat &nbsp; ‚òê Grab bars &nbsp; ‚òê Remove trip hazards &nbsp; ‚òê Stock easy meals &nbsp; ‚òê Arrange ride + help 1-2 weeks &nbsp; ‚òê Ice machine/packs &nbsp; ‚òê Walker ready`;
            if (classLink) html += `<br><br><strong>Joint Class:</strong> ${classLink}`;
            html += `<br><br><strong>Nothing to eat or drink after midnight</strong> the night before surgery.`;

            html += `<div class="footer">SRO Intelligence ¬∑ ${new Date().toLocaleDateString()} ¬∑ CONFIDENTIAL</div>`;
            html += `</body></html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }
    </script>
</body>
</html>
