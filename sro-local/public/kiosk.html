<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Patient Intake Kiosk | SRO Intelligence</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #f8fafc; min-height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }

.kiosk-card { background: white; border-radius: 20px; padding: 48px 40px; max-width: 480px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); color: #1e293b; }
.logo { font-size: 1.8rem; font-weight: 800; color: #1e40af; margin-bottom: 4px; letter-spacing: -1px; }
.logo span { color: #3b82f6; }
.subtitle { font-size: 0.85rem; color: #64748b; margin-bottom: 32px; }

.field-label { font-size: 0.8rem; font-weight: 600; color: #475569; text-align: left; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.mrn-input { width: 100%; padding: 16px 20px; font-size: 1.4rem; font-weight: 600; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; letter-spacing: 2px; outline: none; transition: border-color 0.2s; }
.mrn-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
.mrn-input::placeholder { color: #cbd5e1; font-weight: 400; letter-spacing: 0; font-size: 1rem; }

.go-btn { width: 100%; padding: 16px; font-size: 1.15rem; font-weight: 700; background: #2563eb; color: white; border: none; border-radius: 12px; cursor: pointer; margin-top: 16px; transition: background 0.15s; }
.go-btn:hover { background: #1d4ed8; }
.go-btn:active { transform: scale(0.98); }
.go-btn:disabled { background: #94a3b8; cursor: default; }

.or-divider { display: flex; align-items: center; gap: 12px; margin: 24px 0; color: #94a3b8; font-size: 0.8rem; }
.or-divider::before, .or-divider::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }

.patient-list-btn { width: 100%; padding: 14px; font-size: 0.95rem; font-weight: 600; background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: all 0.15s; }
.patient-list-btn:hover { background: #e2e8f0; border-color: #cbd5e1; }

.patient-grid { max-height: 320px; overflow-y: auto; margin-top: 12px; display: none; }
.patient-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 6px; cursor: pointer; transition: all 0.15s; }
.patient-row:hover { background: #eff6ff; border-color: #93c5fd; }
.patient-row .name { font-weight: 600; font-size: 0.95rem; }
.patient-row .meta { font-size: 0.75rem; color: #64748b; }
.patient-row .mrn-badge { background: #f1f5f9; padding: 3px 8px; border-radius: 5px; font-size: 0.72rem; font-weight: 600; color: #475569; }

.status-msg { margin-top: 16px; padding: 12px; border-radius: 10px; font-size: 0.9rem; display: none; }
.status-msg.error { display: block; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
.status-msg.loading { display: block; background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

.footer-note { margin-top: 24px; font-size: 0.72rem; color: #64748b; }
.footer-note a { color: #2563eb; text-decoration: none; }

/* Back to kiosk button shown after previsit */
.back-strip { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; padding: 12px; text-align: center; display: none; z-index: 9999; }
.back-strip button { background: #2563eb; color: white; border: none; padding: 12px 32px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
</style>
</head>
<body>

<div class="kiosk-card">
    <div class="logo">SRO<span>Intelligence</span></div>
    <div class="subtitle">Patient Pre-Visit Intake Kiosk</div>

    <div class="field-label">Enter Patient MRN</div>
    <input type="text" class="mrn-input" id="mrnInput" placeholder="e.g. 10042" autofocus
           onkeydown="if(event.key==='Enter')launchByMRN()">
    <button class="go-btn" id="goBtn" onclick="launchByMRN()">Launch Intake ‚Üí</button>

    <div id="statusMsg" class="status-msg"></div>

    <div class="or-divider">or select from list</div>

    <button class="patient-list-btn" id="listToggle" onclick="togglePatientList()">‚ñº Show Patient List</button>
    <div class="patient-grid" id="patientGrid"></div>

    <div class="footer-note">
        üîí HIPAA Safe ‚Äî No PHI leaves this device<br>
        <a href="/dashboard.html">‚Üê Back to Dashboard</a>
    </div>
</div>

<script>
var allPatients = [];

// Load patient list on page load
fetch('/api/patients?clinic_id=11111111-1111-1111-1111-111111111111')
    .then(function(r) { return r.json(); })
    .then(function(patients) {
        allPatients = patients;
        renderPatientList(patients);
    })
    .catch(function(e) {
        console.error('Failed to load patients:', e);
    });

function renderPatientList(patients) {
    var grid = document.getElementById('patientGrid');
    if (!patients.length) {
        grid.innerHTML = '<div style="padding:16px;color:#94a3b8;font-size:0.85rem;">No patients found. Add patients from the dashboard first.</div>';
        return;
    }
    // Sort by last name
    patients.sort(function(a, b) { return (a.last_name || '').localeCompare(b.last_name || ''); });
    var html = '';
    for (var i = 0; i < patients.length; i++) {
        var p = patients[i];
        var name = (p.last_name || '') + ', ' + (p.first_name || '');
        var proc = p.surgery_type || 'General';
        html += '<div class="patient-row" onclick="launchForPatient(\'' + p.token + '\')">' +
            '<div><div class="name">' + name + '</div><div class="meta">' + proc + '</div></div>' +
            '<div class="mrn-badge">' + (p.mrn || 'No MRN') + '</div>' +
            '</div>';
    }
    grid.innerHTML = html;
}

function togglePatientList() {
    var grid = document.getElementById('patientGrid');
    var btn = document.getElementById('listToggle');
    if (grid.style.display === 'block') {
        grid.style.display = 'none';
        btn.textContent = '‚ñº Show Patient List';
    } else {
        grid.style.display = 'block';
        btn.textContent = '‚ñ≤ Hide Patient List';
    }
}

function launchByMRN() {
    var mrn = document.getElementById('mrnInput').value.trim();
    if (!mrn) { showStatus('Enter an MRN to continue.', 'error'); return; }

    showStatus('Looking up patient...', 'loading');

    // Find patient by MRN
    var match = allPatients.find(function(p) { return p.mrn === mrn; });
    if (!match) {
        showStatus('No patient found with MRN: ' + mrn, 'error');
        return;
    }
    if (!match.token) {
        showStatus('Patient found but no token generated. Open their record on the dashboard first.', 'error');
        return;
    }
    launchForPatient(match.token);
}

function launchForPatient(token) {
    if (!token) { showStatus('No token for this patient.', 'error'); return; }
    window.location.href = '/previsit.html?t=' + token;
}

function showStatus(msg, type) {
    var el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.className = 'status-msg ' + type;
}

// Auto-focus MRN input
document.getElementById('mrnInput').focus();
</script>
</body>
</html>
