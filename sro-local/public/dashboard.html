<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | SRO Intelligence</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .risk-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .risk-low { background: #065f46; color: #34d399; }
        .risk-moderate { background: #78350f; color: #fbbf24; }
        .risk-high { background: #7f1d1d; color: #f87171; }
        .risk-none { background: #374151; color: #9ca3af; font-size: 0.65rem; }
        .btn-preop {
            background: #8b5cf6 !important;
            color: white !important;
        }
        .btn-preop:hover {
            background: #7c3aed !important;
        }
        .preop-section {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .preop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .preop-stat {
            text-align: center;
        }
        .preop-stat-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #3b82f6;
        }
        .preop-stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        /* Sticky table headers */
        .table-container {
            max-height: calc(100vh - 340px);
            overflow-y: auto;
        }
        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #f8f9fa;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon">SRO</span>
            <span class="nav-title">SRO Intelligence</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html" class="nav-link active">Dashboard</a>
            <a href="/preop.html" class="nav-link">Pre-Op</a>
            <a href="/surgical-prep.html" class="nav-link">Surg Prep</a>
            <a href="/nonop-plan.html" class="nav-link">Non-Op Plan</a>
            <a href="/analytics.html" class="nav-link">Analytics</a>
            <a href="/rpm-report.html" class="nav-link">RPM Billing</a>
            <a href="/settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span id="userName">Loading...</span>
            <button class="btn btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" style="cursor:pointer;" onclick="filterByStat(null)" data-stat-filter="all">
                <div class="stat-value" id="statActive">-</div>
                <div class="stat-label">Active Patients</div>
            </div>
            <div class="stat-card stat-success" style="cursor:pointer;" onclick="filterByStat('on-track')" data-stat-filter="on-track">
                <div class="stat-value" id="statOnTrack">-</div>
                <div class="stat-label">On Track</div>
            </div>
            <div class="stat-card stat-warning" style="cursor:pointer;" onclick="filterByStat('attention')" data-stat-filter="attention">
                <div class="stat-value" id="statAttention">-</div>
                <div class="stat-label">Needs Attention</div>
            </div>
            <div class="stat-card stat-danger" style="cursor:pointer;" onclick="filterByStat('overdue')" data-stat-filter="overdue">
                <div class="stat-value" id="statOverdue">-</div>
                <div class="stat-label">Overdue</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #7c3aed; cursor:pointer;" onclick="filterByStat('er_visits')" data-stat-filter="er_visits">
                <div class="stat-value" id="statERVisits">-</div>
                <div class="stat-label">ER Visits</div>
            </div>
            <div class="stat-card" style="border-left: 4px solid #6366f1; cursor:pointer;" onclick="filterByStat('readmissions')" data-stat-filter="readmissions">
                <div class="stat-value" id="statReadmissions">-</div>
                <div class="stat-label">Readmissions</div>
            </div>
        </div>

        <!-- Nurse Action Panel (only visible for nurse role) -->
        <div id="nursePanel" style="display:none; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #064e3b, #065f46); border-radius: 12px; padding: 20px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0; font-size: 1.2rem;">ü©∫ Today's Priorities</h2>
                    <span id="nursePanelCount" style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">0 items</span>
                </div>
                <div id="nurseActionQueue" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #a7f3d0;">Loading priorities...</div>
                </div>
            </div>
        </div>

        <!-- Admin Metrics Panel (only visible for admin role) -->
        <div id="adminPanel" style="display:none; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #312e81, #4338ca); border-radius: 12px; padding: 20px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0; font-size: 1.2rem;">üìä Practice Overview</h2>
                    <span id="adminPanelDate" style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;"></span>
                </div>
                <!-- Row 1: Big Metrics -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; text-align: center; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px 8px;">
                        <div id="adminPromRate" style="font-size: 2rem; font-weight: 700;">--%</div>
                        <div style="font-size: 0.7rem; color: #c7d2fe;">PROM Compliance</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px 8px;">
                        <div id="adminCheckinRate" style="font-size: 2rem; font-weight: 700;">--%</div>
                        <div style="font-size: 0.7rem; color: #c7d2fe;">Check-in Rate</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px 8px;">
                        <div id="adminRpmEligible" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.7rem; color: #c7d2fe;">RPM Eligible</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px 8px;">
                        <div id="adminAlertCount" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.7rem; color: #c7d2fe;">Open Alerts</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 14px 8px;">
                        <div id="adminAvgPain" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.7rem; color: #c7d2fe;">Avg Pain</div>
                    </div>
                </div>
                <!-- Row 2: Surgeon Compliance Bars -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #e0e7ff;">PROM Compliance by Surgeon</div>
                        <div id="adminPromBySurgeon" style="font-size: 0.8rem;"></div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: #e0e7ff;">RPM Billing This Month</div>
                        <div id="adminRpmSummary" style="font-size: 0.8rem;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tabs -->
        <div style="display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid #e5e7eb;">
            <button id="tabPatients" class="dashboard-tab active" onclick="switchTab('patients')" style="padding: 12px 24px; font-size: 1rem; font-weight: 600; border: none; background: none; cursor: pointer; border-bottom: 3px solid #2c5aa0; color: #2c5aa0; margin-bottom: -2px;">
                üë• Patients
            </button>
            <button id="tabProm" class="dashboard-tab" onclick="switchTab('prom')" style="padding: 12px 24px; font-size: 1rem; font-weight: 600; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; color: #6b7280; margin-bottom: -2px;">
                üìã PROM Compliance
            </button>
        </div>

        <!-- PATIENTS TAB -->
        <div id="panelPatients" style="margin-top: 20px;">
            <!-- Filters and Actions -->
            <div class="toolbar">
                <div class="filters">
                    <select id="filterStatus" onchange="filterPatients()">
                        <option value="all">All Status</option>
                        <option value="on-track">On Track</option>
                        <option value="attention">Needs Attention</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    <select id="filterSurgeon" onchange="filterPatients()">
                        <option value="all">All Surgeons</option>
                    </select>
                </div>
                <div class="actions">
                    <button class="btn btn-sm" style="background:#f59e0b;color:white;" onclick="seedDemoData()" title="Load demo patients for testing">üß™ Seed Demo</button>
                    <button class="btn btn-sm" style="background:#ef4444;color:white;" onclick="clearDemoData()" title="Remove demo patients">üóëÔ∏è Clear Demo</button>
                    <button class="btn btn-secondary" onclick="exportPatients()">Export CSV</button>
                    <a href="/preop.html" class="btn btn-preop">+ Pre-Op Assessment</a>
                    <button class="btn btn-primary" onclick="openAddPatientModal()">+ Add Patient</button>
                </div>
            </div>

            <!-- Patient Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Surgery</th>
                            <th>Day</th>
                            <th>Risk</th>
                            <th>Surgeon</th>
                            <th>Last Check-in</th>
                            <th>Pain</th>
                            <th>PT</th>
                            <th>Alerts</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        <tr>
                            <td colspan="11" class="loading">Loading patients...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PROM COMPLIANCE TAB -->
        <div id="panelProm" style="margin-top: 20px; display: none;">
            <div id="promCompliancePanel" class="table-container" style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">üìä PROM Compliance</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span id="promComplianceRate" style="font-size: 1.5rem; font-weight: 700; color: #2c5aa0;">--%</span>
                        <span style="color: #666; font-size: 0.85rem;">completion rate</span>
                    </div>
                </div>
                
                <!-- Compliance Stats Row -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="promCompleted" style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">0</div>
                        <div style="font-size: 0.8rem; color: #666;">Completed</div>
                    </div>
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="promDueSoon" style="font-size: 1.5rem; font-weight: 700; color: #d97706;">0</div>
                        <div style="font-size: 0.8rem; color: #666;">Due Soon</div>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="promOverdue" style="font-size: 1.5rem; font-weight: 700; color: #dc2626;">0</div>
                        <div style="font-size: 0.8rem; color: #666;">Overdue</div>
                    </div>
                    <div style="background: #f0f4ff; padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="promPending" style="font-size: 1.5rem; font-weight: 700; color: #2563eb;">0</div>
                        <div style="font-size: 0.8rem; color: #666;">Pending</div>
                    </div>
                </div>
                
                <!-- Window Breakdown -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">By Collection Window</h3>
                        <div id="promByWindow" style="font-size: 0.85rem;"></div>
                    </div>
                    <div>
                        <h3 style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">By Surgeon</h3>
                        <div id="promBySurgeon" style="font-size: 0.85rem;"></div>
                    </div>
                </div>
                
                <!-- Action Lists -->
                <div style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="font-size: 0.9rem; color: #dc2626; margin-bottom: 8px;">üî¥ Overdue PROMs</h3>
                            <div id="promOverdueList" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></div>
                        </div>
                        <div>
                            <h3 style="font-size: 0.9rem; color: #d97706; margin-bottom: 8px;">üü° Due in Next 14 Days</h3>
                            <div id="promDueSoonList" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Patient Detail Modal -->
    <div id="patientModal" class="modal" style="display: none;">
        <div class="modal-content modal-large" style="display: flex; flex-direction: column; max-height: 90vh;">
            <div class="modal-header" style="position: sticky; top: 0; z-index: 10; background: white; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                <h2 id="modalPatientName">Patient Details</h2>
                <div class="modal-header-actions">
                    <div id="rpmTimer" class="rpm-timer" style="display: none;">
                        <span class="timer-icon">‚è±Ô∏è</span>
                        <span id="timerDisplay">00:00</span>
                        <button class="btn btn-sm btn-warning" onclick="endReview()">End Review</button>
                    </div>
                    <button id="startReviewBtn" class="btn btn-primary" onclick="startReview()">
                        Start Review ‚è±Ô∏è
                    </button>
                    <button class="btn" style="background:#1e40af;color:white;font-size:0.8rem;padding:6px 12px;" onclick="openEpisodeTimeline()">
                        üìã Timeline
                    </button>
                    <button class="btn btn-close" onclick="closePatientModal()">√ó</button>
                </div>
            </div>
            <div class="modal-body" style="overflow-y: auto; flex: 1;">
                <!-- Surgeon Quick Summary Card -->
                <div id="surgeonSummaryCard" style="display:none; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #0f172a, #1e293b); border-radius: 12px; padding: 20px; color: white;">
                        <!-- Row 1: Key Vitals -->
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; text-align: center;">
                            <div>
                                <div id="sumPain" style="font-size: 2.2rem; font-weight: 700;">-</div>
                                <div style="font-size: 0.7rem; color: #94a3b8;">PAIN</div>
                            </div>
                            <div>
                                <div id="sumBMI" style="font-size: 2.2rem; font-weight: 700;">-</div>
                                <div style="font-size: 0.7rem; color: #94a3b8;">BMI</div>
                            </div>
                            <div>
                                <div id="sumJointScore" style="font-size: 2.2rem; font-weight: 700;">-</div>
                                <div id="sumJointLabel" style="font-size: 0.7rem; color: #94a3b8;">SCORE</div>
                            </div>
                            <div>
                                <div id="sumProjected" style="font-size: 2.2rem; font-weight: 700; color: #22c55e;">-</div>
                                <div style="font-size: 0.7rem; color: #94a3b8;">PROJECTED</div>
                            </div>
                            <div>
                                <div id="sumRiskBadge" style="margin-top: 8px;"></div>
                                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 6px;">RISK</div>
                            </div>
                        </div>

                        <!-- Row 2: Surgery + Days -->
                        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 14px; font-size: 0.85rem; color: #94a3b8;">
                            <span id="sumSurgery">-</span>
                            <span>‚Ä¢</span>
                            <span id="sumDays">-</span>
                            <span>‚Ä¢</span>
                            <span id="sumAge">-</span>
                        </div>

                        <!-- Row 3: Alert Badges -->
                        <div id="sumBadges" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin-top: 14px;"></div>

                        <!-- Row 4: Quick Actions -->
                        <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: center; flex-wrap: wrap;">
                            <a id="sumPreopLink" href="#" class="btn btn-sm" style="background: #8b5cf6; color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem;">Open PreOp</a>
                            <a id="sumNonopLink" href="#" class="btn btn-sm" style="background: #d97706; color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem;">üìã Non-Op Plan</a>
                            <a id="sumSurgPrepLink" href="#" class="btn btn-sm" style="background: #0d9488; color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem;">üîß Surg Prep</a>
                            <button class="btn btn-sm" style="background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem;" onclick="document.getElementById('painChartCanvas').scrollIntoView({behavior:'smooth'})">Pain Trend</button>
                            <button class="btn btn-sm" style="background: #059669; color: white; padding: 8px 16px; border-radius: 6px; font-size: 0.8rem;" onclick="document.getElementById('promTrendCanvas').scrollIntoView({behavior:'smooth'})">PROM Trend</button>
                        </div>
                    </div>
                </div>

                <div class="patient-detail-grid">
                    <!-- Patient Info -->
                    <div class="detail-section">
                        <h3>Patient Information</h3>
                        <div id="patientInfo">Loading...</div>
                    </div>
                    
                    <!-- Surgery Info -->
                    <div class="detail-section">
                        <h3>Surgery Details</h3>
                        <div id="surgeryInfo">Loading...</div>
                    </div>
                    
                    <!-- Check-in Link -->
                    <div class="detail-section">
                        <h3>Patient Check-in Link</h3>
                        <div class="checkin-link-box">
                            <input type="text" id="checkinLink" readonly>
                            <button class="btn btn-sm" onclick="copyCheckinLink()">Copy</button>
                        </div>
                        <button class="btn btn-secondary btn-sm" style="margin-top: 10px; width: 100%;" onclick="openManualCheckinModal()">
                            üìû Log Phone/Manual Check-in
                        </button>
                        <div style="display:flex;gap:6px;margin-top:8px;">
                            <button class="btn btn-sm" style="flex:1;background:#2563eb;color:white;font-size:0.75rem;" onclick="sendPatientLink('checkin')">üìã Copy Check-in Link</button>
                            <button class="btn btn-sm btn-preop" style="flex:1;font-size:0.75rem;" onclick="sendPatientLink('preop')">üìã Copy PreOp Link</button>
                        </div>
                        <p style="font-size:0.65rem;color:#6b7280;margin-top:4px;text-align:center;">No PHI in links ‚Äî HIPAA safe. Paste into text or email.</p>
                    </div>
                </div>
                
                <!-- Compliance Scorecard -->
                <div id="complianceScorecard" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="text-align: center;">
                        <div id="scorecardCheckin" style="font-size: 1.5rem; font-weight: 700;">--%</div>
                        <div style="font-size: 0.75rem; color: #666;">Check-in Adherence</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="scorecardProm" style="font-size: 1.5rem; font-weight: 700;">--%</div>
                        <div style="font-size: 0.75rem; color: #666;">PROM Completion</div>
                    </div>
                    <div style="text-align: center;">
                        <div id="scorecardWorkup" style="font-size: 1.5rem; font-weight: 700;">--</div>
                        <div style="font-size: 0.75rem; color: #666;">Workup Status</div>
                    </div>
                </div>

                <!-- Pre-Op Assessment Section -->
                <div class="preop-section">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Pre-Op Assessment</h3>
                        <a id="preopActionBtn" href="#" class="btn btn-sm btn-preop">+ Complete Pre-Op</a>
                    </div>
                    <div id="preopInfo" style="margin-top: 15px;">
                        Loading...
                    </div>
                </div>
                
                <!-- PROM Schedule Section -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <h3 style="margin: 0 0 10px 0;">üìã PROM Collection Schedule</h3>
                    <div id="promScheduleList">Loading...</div>
                </div>
                
                <!-- Pain Trend Chart -->
                <div class="chart-section">
                    <h3>Pain Trend (Last 14 Days)</h3>
                    <div id="painChart" class="chart-container">
                        <canvas id="painChartCanvas"></canvas>
                    </div>
                </div>

                <!-- PROM Trend Chart -->
                <div class="chart-section" style="margin-top: 20px;">
                    <h3>PROM Score Trend</h3>
                    <div class="chart-container">
                        <canvas id="promTrendCanvas" width="700" height="250"></canvas>
                    </div>
                </div>
                
                <!-- Recent Check-ins -->
                <div class="checkins-section">
                    <h3>Recent Check-ins</h3>
                    <div id="checkinsList" class="checkins-list">Loading...</div>
                </div>
                
                <!-- Adverse Events Section -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3>‚ö†Ô∏è Adverse Events</h3>
                        <button class="btn btn-sm" style="background: #dc3545; color: white;" onclick="openAdverseEventModal()">+ Log Event</button>
                    </div>
                    <div id="adverseEventsList" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                        <p class="text-muted">No adverse events recorded.</p>
                    </div>
                </div>

                <!-- Nursing Notes Section -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3>üìù Notes</h3>
                        <button class="btn btn-sm" style="background: #2c5aa0; color: white;" onclick="openNoteModal()">+ Add Note</button>
                    </div>
                    <div id="nursingNotesList" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                        <p class="text-muted">No notes yet.</p>
                    </div>
                </div>

                <!-- Tasks / To-Do Section -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3>‚úÖ Tasks</h3>
                        <button class="btn btn-sm" style="background: #059669; color: white;" onclick="openTaskModal()">+ Add Task</button>
                    </div>
                    <div id="tasksList" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                        <p class="text-muted">No tasks.</p>
                    </div>
                </div>

                <!-- PDF Export -->
                <div style="margin-top: 20px; text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px dashed #d1d5db;">
                    <button class="btn" style="background: #1e40af; color: white; padding: 10px 24px; font-size: 0.9rem;" onclick="exportEpisodePDF()">üìÑ Export Episode Summary PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add Task</h2>
                <button class="btn btn-close" onclick="closeTaskModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 12px;">
                    <label style="display:block;font-weight:600;margin-bottom:4px;">Task Description</label>
                    <input type="text" id="taskDescription" placeholder="e.g. Call patient re: workup results" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display:block;font-weight:600;margin-bottom:4px;">Category</label>
                    <select id="taskCategory" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                        <option value="follow_up">üìû Follow Up</option>
                        <option value="workup">üî¨ Workup / Lab</option>
                        <option value="prom">üìà PROM Collection</option>
                        <option value="referral">üìã Referral / Consult</option>
                        <option value="documentation">üìÑ Documentation</option>
                        <option value="other">üìå Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display:block;font-weight:600;margin-bottom:4px;">Priority</label>
                    <select id="taskPriority" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                        <option value="high">üî¥ High</option>
                        <option value="medium" selected>üü° Medium</option>
                        <option value="low">üü¢ Low</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display:block;font-weight:600;margin-bottom:4px;">Due Date (optional)</label>
                    <input type="date" id="taskDueDate" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display:block;font-weight:600;margin-bottom:4px;">Assigned To (optional)</label>
                    <input type="text" id="taskAssignedTo" placeholder="e.g. Nurse Smith" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;">
                </div>
                <button class="btn btn-primary" style="width:100%;padding:10px;" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>

    <!-- Nursing Note Modal -->
    <div id="nursingNoteModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add Note</h2>
                <button class="btn btn-close" onclick="closeNoteModal()">√ó</button>
            </div>
            <form id="nursingNoteForm" onsubmit="handleSaveNote(event)">
                <div class="form-group">
                    <label>Type</label>
                    <select id="noteType" required>
                        <option value="phone_call">üìû Phone Call</option>
                        <option value="clinic_visit">üè• Clinic Visit</option>
                        <option value="nurse_note">üìù Nurse Note</option>
                        <option value="provider_note">üë®‚Äç‚öïÔ∏è Provider Note</option>
                        <option value="care_coordination">ü§ù Care Coordination</option>
                        <option value="other">üìã Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="noteText" rows="4" required placeholder="Enter note details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                    <button type="submit" class="btn" style="background: #2c5aa0; color: white;">Save Note</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div id="addPatientModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Patient</h2>
                <button class="btn btn-close" onclick="closeAddPatientModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="addPatientForm" onsubmit="handleAddPatient(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="newPatientFirst" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="newPatientLast" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="newPatientDOB">
                        </div>
                        <div class="form-group">
                            <label>MRN</label>
                            <input type="text" id="newPatientMRN">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newPatientEmail">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="newPatientPhone">
                        </div>
                    </div>
                    <hr>
                    <h3>Surgery Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Surgery Type *</label>
                            <select id="newSurgeryType" required>
                                <option value="">Select...</option>
                                <option value="TKA">Total Knee Arthroplasty (TKA)</option>
                                <option value="THA">Total Hip Arthroplasty (THA)</option>
                                <option value="PKA">Partial Knee Arthroplasty (PKA)</option>
                                <option value="Revision TKA">Revision TKA</option>
                                <option value="Revision THA">Revision THA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Surgery Date *</label>
                            <input type="date" id="newSurgeryDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Surgeon *</label>
                        <select id="newSurgeon" required>
                            <option value="">Select surgeon...</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddPatientModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Patient</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- RPM Log Modal -->
    <div id="rpmLogModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Log Review Time</h2>
                <button class="btn btn-close" onclick="closeRpmLogModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="rpm-summary">
                    <p><strong>Duration:</strong> <span id="rpmDuration">0:00</span></p>
                </div>
                <form id="rpmLogForm" onsubmit="handleSaveRpmLog(event)">
                    <div class="form-group">
                        <label>Activity Type *</label>
                        <select id="rpmActivityType" required>
                            <option value="data_review">Data Review</option>
                            <option value="care_management">Care Management</option>
                            <option value="communication">Patient Communication</option>
                            <option value="documentation">Documentation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="rpmNotes" rows="3" placeholder="Brief notes about this review..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="discardRpmLog()">Discard</button>
                        <button type="submit" class="btn btn-primary">Save & Log Time</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Manual Check-in Modal -->
    <div id="manualCheckinModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìû Log Manual Check-in</h2>
                <button class="btn btn-close" onclick="closeManualCheckinModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="background: #e8f4fd; padding: 10px; border-radius: 6px; margin-bottom: 20px;">
                    Use this form to log check-ins from phone calls or in-person visits when the patient can't use the app.
                </p>
                <form id="manualCheckinForm" onsubmit="handleManualCheckin(event)">
                    <div class="form-group">
                        <label>Source *</label>
                        <select id="manualSource" required>
                            <option value="phone">Phone Call</option>
                            <option value="in-person">In-Person Visit</option>
                            <option value="voicemail">Voicemail</option>
                            <option value="family">Family Member Report</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pain Level (0-10) *</label>
                        <select id="manualPain" required>
                            <option value="">Select...</option>
                            <option value="0">0 - No pain</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10 - Worst pain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Did PT Exercises? *</label>
                        <select id="manualPT" required>
                            <option value="">Select...</option>
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Took Medications? *</label>
                        <select id="manualMed" required>
                            <option value="">Select...</option>
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Any Concerns?</label>
                        <input type="text" id="manualConcerns" placeholder="Swelling, redness, fever, etc.">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="manualNotes" rows="2" placeholder="Additional notes from the call..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeManualCheckinModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Check-in</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick RPM Log Modal -->
    <div id="quickRpmModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>‚è±Ô∏è Log RPM Time</h2>
                <button class="btn btn-close" onclick="closeQuickRpmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Patient: <strong id="quickRpmPatientName">-</strong></p>
                <form id="quickRpmForm" onsubmit="handleQuickRpmLog(event)">
                    <input type="hidden" id="quickRpmPatientId">
                    <input type="hidden" id="quickRpmEpisodeId">
                    <div class="form-group">
                        <label>Time Spent (minutes) *</label>
                        <input type="number" id="quickRpmMinutes" min="1" max="120" required placeholder="e.g., 5">
                    </div>
                    <div class="form-group">
                        <label>Activity Type *</label>
                        <select id="quickRpmActivity" required>
                            <option value="data_review">Data Review</option>
                            <option value="care_management">Care Management</option>
                            <option value="communication">Patient Communication</option>
                            <option value="documentation">Documentation</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="quickRpmNotes" rows="2" placeholder="Brief notes..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeQuickRpmModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Time</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Adverse Event Log Modal -->
    <div id="adverseEventModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Log Adverse Event</h2>
                <button class="btn btn-close" onclick="closeAdverseEventModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="adverseEventForm" onsubmit="handleLogAdverseEvent(event)">
                    <div class="form-group">
                        <label>Event Type *</label>
                        <select id="aeEventType" required>
                            <option value="">Select...</option>
                            <option value="er_visit">ER Visit</option>
                            <option value="readmission">Hospital Readmission</option>
                            <option value="complication">Complication</option>
                            <option value="fall">Fall</option>
                            <option value="infection">Infection</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Event Date *</label>
                        <input type="date" id="aeEventDate" required>
                    </div>
                    <div class="form-group">
                        <label>Facility</label>
                        <input type="text" id="aeFacility" placeholder="Hospital or clinic name">
                    </div>
                    <div class="form-group">
                        <label>Reason / Description</label>
                        <textarea id="aeReason" rows="3" placeholder="What happened..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Reported By</label>
                        <select id="aeReportedBy">
                            <option value="staff">Staff</option>
                            <option value="patient">Patient</option>
                            <option value="family">Family Member</option>
                            <option value="other_provider">Other Provider</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAdverseEventModal()">Cancel</button>
                        <button type="submit" class="btn" style="background: #dc3545; color: white;">Log Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js"></script>
    <script>
        function sendPatientLink(type) {
            var linkInput = document.getElementById('checkinLink');
            if (!linkInput || !linkInput.value) { alert('Select a patient first.'); return; }
            var match = linkInput.value.match(/[?&]t=([^&]+)/);
            if (!match) { alert('No patient token found.'); return; }
            var token = match[1];
            var baseUrl = 'https://sro-cloud-relay.onrender.com';
            var link;
            if (type === 'checkin') {
                link = baseUrl + '/checkin.html?t=' + token;
            } else {
                link = baseUrl + '/preop.html?t=' + token;
            }
            navigator.clipboard.writeText(link).then(function() {
                var msg = type === 'checkin' ? 'Check-in' : 'PreOp intake';
                alert(msg + ' link copied!\n\n' + link + '\n\nPaste into text or email.\nNo PHI in link (HIPAA safe).');
            }).catch(function() {
                prompt('Copy this link:', link);
            });
        }
    </script>
</body>
</html>
