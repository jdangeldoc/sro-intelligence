<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPM Billing Report | SRO Intelligence</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .month-info {
            background: #e8f4fd;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .month-info .month-name {
            font-size: 20px;
            font-weight: 600;
        }
        .month-info .days-left {
            font-size: 16px;
            color: #2c5aa0;
        }
        .status-qualified { color: #155724; }
        .status-at-risk { color: #856404; }
        .status-wont-make-it { color: #721c24; }
        .checkin-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .progress-bar {
            width: 100px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .progress-fill.green { background: #28a745; }
        .progress-fill.yellow { background: #ffc107; }
        .progress-fill.red { background: #dc3545; }
        .staff-breakdown {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.green { background: #28a745; }
        .legend-dot.yellow { background: #ffc107; }
        .legend-dot.red { background: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon">SRO</span>
            <span class="nav-title">SRO Intelligence</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard.html" class="nav-link">Dashboard</a>
            <a href="/analytics.html" class="nav-link">Analytics</a>
            <a href="/rpm-report.html" class="nav-link active">RPM Billing</a>
            <a href="/settings.html" class="nav-link">Settings</a>
        </div>
        <div class="nav-user">
            <span id="userName">Loading...</span>
            <button class="btn btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1>RPM Billing Report</h1>
            <p>Track time and check-in days for CPT 99457 and 99458 billing</p>
        </div>

        <div class="toolbar">
            <div class="filters">
                <label>Month:</label>
                <input type="month" id="billingMonth" onchange="loadReport()">
            </div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="exportCSV()">Export All (CSV)</button>
                <button class="btn btn-primary" onclick="exportBillingReport()">üìã Export for Billers</button>
                <button class="btn btn-primary" onclick="exportToNetwork()" style="background: #28a745;">üìÅ Send to Billing Folder</button>
            </div>
        </div>

        <!-- Month Info Banner -->
        <div class="month-info">
            <div>
                <span class="month-name" id="monthName">January 2026</span>
            </div>
            <div class="days-left" id="daysLeftBanner">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalPatients">-</div>
                <div class="stat-label">Active Patients</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="qualifiedCount">-</div>
                <div class="stat-label">Fully Qualified (16+ days & 20+ min)</div>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-value" id="atRiskCount">-</div>
                <div class="stat-label">At Risk (Need More Check-ins)</div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-value" id="estimatedRevenue">$0</div>
                <div class="stat-label">Estimated Revenue</div>
            </div>
        </div>

        <!-- Revenue Breakdown -->
        <div class="revenue-box">
            <h2>Revenue Breakdown</h2>
            <p>
                <span id="cpt99457Count">0</span> √ó $48 (99457) + 
                <span id="cpt99458Count">0</span> √ó $38 (99458) = 
                <strong id="revTotal">$0</strong>
            </p>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                Requirements: 16+ check-in days AND 20+ minutes of review time per patient
            </p>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot green"></div>
                <span>Qualified (16+ days)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot yellow"></div>
                <span>At Risk (can still make it)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot red"></div>
                <span>Won't Make It (not enough days left)</span>
            </div>
        </div>

        <!-- Patient Detail Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Check-in Days</th>
                        <th>Review Time</th>
                        <th>Staff Breakdown</th>
                        <th>99457</th>
                        <th>99458</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <tr><td colspan="7" class="empty">Select a month to load report</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        const CLINIC_ID = sessionStorage.getItem('clinicId') || '11111111-1111-1111-1111-111111111111';
        document.getElementById('userName').textContent = sessionStorage.getItem('userName') || 'User';
        
        let reportData = [];

        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('billingMonth').value = now.toISOString().slice(0, 7);
            loadReport();
        });

        async function loadReport() {
            const month = document.getElementById('billingMonth').value;
            if (!month) return;
            
            // Update month name display
            const monthDate = new Date(month + '-01');
            const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('monthName').textContent = monthName;
            
            // Calculate days left
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7);
            const isCurrentMonth = month === currentMonth;
            
            if (isCurrentMonth) {
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                const daysLeft = lastDay - today.getDate();
                document.getElementById('daysLeftBanner').innerHTML = `<strong>${daysLeft} days left</strong> in ${monthName}`;
            } else if (month > currentMonth) {
                document.getElementById('daysLeftBanner').textContent = 'Future month';
            } else {
                document.getElementById('daysLeftBanner').textContent = 'Month completed';
            }
            
            try {
                const res = await fetch(`/api/rpm-summary?clinic_id=${CLINIC_ID}&billing_month=${month}`);
                reportData = await res.json();
                renderReport();
            } catch (e) {
                console.error(e);
            }
        }

        function renderReport() {
            const total = reportData.length;
            const qualified = reportData.filter(r => r.cpt_99457_eligible).length;
            const atRisk = reportData.filter(r => r.days_status_code === 'at-risk').length;
            const c99457 = reportData.filter(r => r.cpt_99457_eligible).length;
            const c99458 = reportData.filter(r => r.cpt_99458_eligible).length;
            const revenue = c99457 * 48 + c99458 * 38;
            
            document.getElementById('totalPatients').textContent = total;
            document.getElementById('qualifiedCount').textContent = qualified;
            document.getElementById('atRiskCount').textContent = atRisk;
            document.getElementById('estimatedRevenue').textContent = '$' + revenue.toLocaleString();
            document.getElementById('cpt99457Count').textContent = c99457;
            document.getElementById('cpt99458Count').textContent = c99458;
            document.getElementById('revTotal').textContent = '$' + revenue.toLocaleString();
            
            const tbody = document.getElementById('reportTableBody');
            if (!reportData.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">No active patients</td></tr>';
                return;
            }
            
            tbody.innerHTML = reportData.map(r => {
                // Progress bar color
                let progressColor = 'red';
                if (r.checkin_days >= 16) progressColor = 'green';
                else if (r.days_status_code === 'at-risk') progressColor = 'yellow';
                
                const progressWidth = Math.min(100, (r.checkin_days / 16) * 100);
                
                // Staff breakdown text
                let staffText = '-';
                if (r.staff_breakdown && r.staff_breakdown.length > 0) {
                    staffText = r.staff_breakdown.map(s => 
                        `${s.staff_name}: ${Math.round(s.seconds / 60)}m`
                    ).join('<br>');
                }
                
                // Status class
                const statusClass = r.days_status_code === 'qualified' ? 'status-qualified' : 
                                   r.days_status_code === 'at-risk' ? 'status-at-risk' : 'status-wont-make-it';
                
                return `
                    <tr>
                        <td>
                            <strong>${r.patient_first} ${r.patient_last}</strong>
                            ${r.mrn ? `<br><small class="text-muted">MRN: ${r.mrn}</small>` : ''}
                        </td>
                        <td>
                            <div class="checkin-progress">
                                <span>${r.checkin_days}/16</span>
                                <div class="progress-bar">
                                    <div class="progress-fill ${progressColor}" style="width: ${progressWidth}%"></div>
                                </div>
                            </div>
                            ${r.is_current_month && r.checkin_days < 16 ? 
                                `<small class="text-muted">${r.days_left_in_month} days left in month</small>` : ''}
                        </td>
                        <td>
                            <strong>${r.total_minutes} min</strong>
                            ${r.total_minutes < 20 ? `<br><small class="text-muted">${20 - r.total_minutes} min needed</small>` : ''}
                        </td>
                        <td><small>${staffText}</small></td>
                        <td>${r.cpt_99457_eligible ? '‚úÖ' : '‚ùå'}</td>
                        <td>${r.cpt_99458_eligible ? '‚úÖ' : '‚ùå'}</td>
                        <td><span class="${statusClass}">${r.days_status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function exportCSV() {
            const month = document.getElementById('billingMonth').value;
            const rows = [['Month', 'Patient', 'MRN', 'Check-in Days', 'Review Minutes', 'CPT 99457', 'CPT 99458', 'Status']];
            reportData.forEach(r => rows.push([
                month,
                `${r.patient_first} ${r.patient_last}`,
                r.mrn || '',
                `${r.checkin_days}/16`,
                r.total_minutes,
                r.cpt_99457_eligible ? 'Yes' : 'No',
                r.cpt_99458_eligible ? 'Yes' : 'No',
                r.days_status.replace(/[‚úÖ‚ö†Ô∏èüî¥]/g, '').trim()
            ]));
            const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
            a.download = `rpm-billing-${month}.csv`;
            a.click();
        }

        function exportBillingReport() {
            const month = document.getElementById('billingMonth').value;
            const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Only include billable patients
            const billable = reportData.filter(r => r.cpt_99457_eligible);
            
            if (billable.length === 0) {
                alert('No patients qualify for billing this month.');
                return;
            }
            
            const rows = [[
                'Billing Month',
                'Patient Name',
                'MRN',
                'Date of Birth',
                'Check-in Days',
                'Total Review Time (min)',
                'CPT 99457 ($48)',
                'CPT 99458 ($38)',
                'Staff Who Reviewed',
                'Estimated Charge'
            ]];
            
            billable.forEach(r => {
                const staffList = r.staff_breakdown && r.staff_breakdown.length > 0 
                    ? r.staff_breakdown.map(s => `${s.staff_name} (${Math.round(s.seconds/60)}m)`).join('; ')
                    : 'N/A';
                
                const charge = (r.cpt_99457_eligible ? 48 : 0) + (r.cpt_99458_eligible ? 38 : 0);
                
                rows.push([
                    monthName,
                    `${r.patient_last}, ${r.patient_first}`,
                    r.mrn || '',
                    r.date_of_birth || '',
                    r.checkin_days,
                    r.total_minutes,
                    r.cpt_99457_eligible ? 'YES - Bill' : 'No',
                    r.cpt_99458_eligible ? 'YES - Bill' : 'No',
                    staffList,
                    '$' + charge
                ]);
            });
            
            // Add summary row
            const total99457 = billable.filter(r => r.cpt_99457_eligible).length;
            const total99458 = billable.filter(r => r.cpt_99458_eligible).length;
            const totalCharge = (total99457 * 48) + (total99458 * 38);
            
            rows.push([]);
            rows.push(['SUMMARY']);
            rows.push(['Total Patients Billable', billable.length]);
            rows.push(['Total 99457 Codes', total99457, '', '', '', '', `${total99457} x $48 = $${total99457 * 48}`]);
            rows.push(['Total 99458 Codes', total99458, '', '', '', '', `${total99458} x $38 = $${total99458 * 38}`]);
            rows.push(['TOTAL ESTIMATED CHARGES', '', '', '', '', '', '$' + totalCharge]);
            
            const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
            a.download = `RPM-Billing-Report-${month}.csv`;
            a.click();
        }

        function exportToNetwork() {
            // PLACEHOLDER: Will save directly to hospital shared network folder
            // Requires: Network path configured in Settings (e.g., \\hospital-server\billing\RPM-Reports\)
            alert('PLACEHOLDER\\n\\nThis button will save the billing report directly to the hospital shared network folder.\\n\\nSetup required:\\n1. Configure network path in Settings\\n2. Path example: \\\\\\\\hospital-server\\\\billing\\\\RPM-Reports\\\\\\n\\nFor now, use "Export for Billers" and manually save to the shared folder.');
        }

        function logout() { sessionStorage.clear(); location.href = '/index.html'; }
    </script>
</body>
</html>
